<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AeroNav - Ballon Tracker Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js für das Höhenprofil -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background: #f0fdf4; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255,255,255,0.5);
        }

        #instruments {
            position: absolute; top: 10px; left: 10px; right: 10px;
            z-index: 1000; display: flex; justify-content: space-between; gap: 5px;
        }

        .instrument-box { flex: 1; text-align: center; padding: 8px; }
        .value { font-size: 1.2rem; font-weight: 800; color: #1e3a8a; }
        .label { font-size: 0.6rem; color: #64748b; text-transform: uppercase; }

        #error-overlay {
            position: absolute; top: 70px; left: 10px; right: 10px;
            z-index: 1100; display: none;
        }

        #nav-indicator {
            position: absolute; bottom: 100px; left: 10px; right: 10px;
            z-index: 1000; display: none;
        }

        #controls {
            position: absolute; bottom: 20px; left: 10px; right: 10px;
            z-index: 1000; display: flex; flex-direction: column; gap: 10px;
        }

        .btn-large {
            padding: 15px; border-radius: 50px; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .btn-large:active { transform: scale(0.98); }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; width: 95%; max-width: 450px; max-height: 90vh;
            overflow-y: auto; padding: 20px; border-radius: 20px;
        }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 0.75rem; font-weight: bold; color: #475569; margin-bottom: 4px; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem;
        }

        @keyframes pulse-red {
            0% { background-color: #ef4444; }
            50% { background-color: #991b1b; }
            100% { background-color: #ef4444; }
        }
        .pulse-error { animation: pulse-red 2s infinite; }

        .ai-shimmer {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .nav-arrow { font-size: 2rem; transition: transform 0.3s; }
        
        /* Chart container */
        .chart-container { width: 100%; height: 150px; margin-top: 10px; }
    </style>
</head>
<body>

    <!-- Cockpit -->
    <div id="instruments" class="pointer-events-none">
        <div class="glass-panel instrument-box pointer-events-auto">
            <div class="value" id="disp-alt">0</div>
            <div class="label">m</div>
        </div>
        <div class="glass-panel instrument-box pointer-events-auto">
            <div class="value" id="disp-speed">0</div>
            <div class="label">km/h</div>
        </div>
        <div class="glass-panel instrument-box pointer-events-auto">
            <div class="value" id="disp-heading">---</div>
            <div class="label">Kurs</div>
        </div>
        <div class="glass-panel instrument-box pointer-events-auto">
            <div class="value" id="disp-climb">0.0</div>
            <div class="label">Vario</div>
        </div>
    </div>

    <!-- KI Navigations-Indikator -->
    <div id="nav-indicator" class="pointer-events-none">
        <div class="glass-panel p-4 flex items-center gap-4 border-l-4 border-indigo-600">
            <div id="nav-arrow-box" class="flex flex-col items-center">
                <i id="nav-icon" class="fa-solid fa-arrow-up nav-arrow text-indigo-600"></i>
                <span id="nav-alt-target" class="text-[10px] font-bold text-indigo-900 mt-1">HÖHE</span>
            </div>
            <div class="flex-1">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs font-bold text-indigo-900">✨ KI-NAVIGATOR</span>
                    <span id="nav-dist" class="text-[10px] font-bold text-slate-500">0.0 km</span>
                </div>
                <p id="nav-text" class="text-xs text-slate-700 leading-tight">Berechne besten Kurs zum Ziel...</p>
            </div>
            <button onclick="clearWaypoint()" class="pointer-events-auto bg-slate-100 p-2 rounded-full text-slate-400">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
    </div>

    <!-- KI Wetter-Widget -->
    <div id="ai-weather-info" class="absolute top-24 left-3 right-3 z-[1001] hidden">
        <div class="glass-panel p-3 border-l-4 border-purple-500">
            <div class="flex items-center gap-2 mb-1">
                <span class="text-xs font-bold text-purple-700">✨ KI-WETTERCHECK</span>
                <div id="ai-weather-loading" class="hidden h-1 w-12 ai-shimmer rounded"></div>
            </div>
            <p id="ai-weather-text" class="text-[11px] text-gray-700 italic leading-tight">Analysiere Bedingungen...</p>
        </div>
    </div>

    <!-- Status Overlay -->
    <div id="error-overlay" class="pulse-error text-white p-3 rounded-xl shadow-lg flex items-center gap-3">
        <i class="fa-solid fa-triangle-exclamation text-xl"></i>
        <div class="flex-1">
            <div class="font-bold text-sm" id="error-title">GPS Signal verloren</div>
            <div class="text-[10px] opacity-90" id="error-desc">Suche nach Position...</div>
        </div>
        <button onclick="retryGPS()" class="bg-white/20 px-3 py-1 rounded-lg text-xs font-bold">Retry</button>
    </div>

    <div id="map"></div>

    <!-- Steuerung -->
    <div id="controls" class="pointer-events-none">
        <div class="flex gap-2 pointer-events-auto">
            <button id="btn-toggle" onclick="toggleRecording()" class="btn-large flex-1 bg-green-600 text-white flex items-center justify-center gap-2">
                <i class="fa-solid fa-play"></i> <span id="btn-text">Fahrt starten</span>
            </button>
            <button onclick="openMenu()" class="btn-large bg-white text-indigo-600 w-16 flex items-center justify-center border-2 border-indigo-100">
                <i class="fa-solid fa-bars-staggered"></i>
            </button>
        </div>
    </div>

    <!-- Modal: Fahrt speichern -->
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-indigo-900">Fahrt abschließen</h2>
            
            <div class="grid grid-cols-2 gap-2">
                <div class="form-group">
                    <label>Fahrt-Name</label>
                    <input type="text" id="save-name">
                </div>
                <div class="form-group">
                    <label>Ballon (Reg)</label>
                    <input type="text" id="save-reg" placeholder="z.B. D-OXYZ">
                </div>
            </div>

            <div class="form-group">
                <label>✨ KI-Logbuch Bericht</label>
                <div class="relative">
                    <textarea id="save-notes" rows="3" placeholder="Notizen..."></textarea>
                    <button onclick="generateAIRepo()" id="btn-ai-repo" class="absolute bottom-2 right-2 bg-purple-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-lg flex items-center gap-1">
                        ✨ Erstellen
                    </button>
                </div>
            </div>

            <div id="ai-repo-loader" class="hidden mb-4 p-3 bg-purple-50 rounded-xl text-center">
                <div class="ai-shimmer h-4 w-3/4 mx-auto rounded mb-2"></div>
                <span class="text-[10px] text-purple-600 font-bold tracking-wider uppercase">Analysiere Flugdaten...</span>
            </div>

            <div class="flex gap-2">
                <button onclick="confirmSave()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">Speichern</button>
                <button onclick="closeSaveModal()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl">Verwerfen</button>
            </div>
        </div>
    </div>

    <!-- Modal: Historie & Replay -->
    <div id="menu-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Historie</h2>
                <button onclick="closeMenu()" class="text-gray-400 p-2"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div id="replay-info" class="hidden mb-4 p-3 bg-indigo-50 rounded-xl border border-indigo-100">
                <div class="flex justify-between items-start mb-2">
                    <h3 id="replay-title" class="font-bold text-indigo-900">Fahrt Details</h3>
                    <button onclick="downloadGPX()" class="text-xs bg-indigo-600 text-white px-3 py-1 rounded-lg">GPX Export</button>
                </div>
                <div class="chart-container">
                    <canvas id="altitudeChart"></canvas>
                </div>
                <p id="replay-notes" class="text-xs text-slate-600 italic mt-2"></p>
            </div>

            <div id="saved-list" class="space-y-3 max-h-[40vh] overflow-y-auto pr-2"></div>

            <div class="mt-6 pt-4 border-t space-y-2">
                <button onclick="toggleSimulation()" id="sim-btn" class="w-full py-3 px-4 rounded-xl bg-purple-50 text-purple-700 font-bold text-sm flex items-center justify-between">
                    <span><i class="fa-solid fa-robot mr-2"></i> Simulation</span>
                    <i class="fa-solid fa-play"></i>
                </button>
                <button onclick="closeMenu()" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold">Fertig</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const apiKey = ""; 
        const state = {
            recording: false,
            track: [],
            lastPosTime: null,
            watchId: null,
            maxAlt: 0,
            currentAlt: 0,
            currentPos: null,
            startTime: null,
            simulationId: null,
            lastAIWeatherUpdate: 0,
            lastAINavUpdate: 0,
            waypoint: null,
            waypointMarker: null,
            windLibrary: {},
            currentReplay: null,
            chart: null
        };

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([51.1657, 10.4515], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const trackLine = L.polyline([], { color: '#4f46e5', weight: 4, opacity: 0.8 }).addTo(map);
        const marker = L.circleMarker([0,0], { radius: 8, color: 'white', fillColor: '#4f46e5', fillOpacity: 1, weight: 2 }).addTo(map);

        // --- GPS LOGIC ---
        function handlePosition(pos) {
            state.lastPosTime = Date.now();
            hideError();
            const { latitude, longitude, altitude, speed, heading } = pos.coords;
            processData(latitude, longitude, altitude || 0, (speed || 0) * 3.6, heading, pos.timestamp);
            
            if (state.recording) {
                if (Date.now() - state.lastAIWeatherUpdate > 300000) checkAIWeather(latitude, longitude, altitude);
                if (Date.now() - state.lastAINavUpdate > 20000) updateAINavigation();
            }
        }

        function processData(lat, lng, alt, speedKmh, heading, time) {
            const climb = state.track.length > 0 ? (alt - state.track[state.track.length-1].alt) : 0;
            state.currentAlt = alt;
            state.currentPos = L.latLng(lat, lng);
            if (alt > state.maxAlt) state.maxAlt = alt;
            
            document.getElementById('disp-alt').innerText = Math.round(alt);
            document.getElementById('disp-speed').innerText = Math.round(speedKmh);
            document.getElementById('disp-heading').innerText = heading ? Math.round(heading) + "°" : "---";
            document.getElementById('disp-climb').innerText = climb.toFixed(1);

            marker.setLatLng([lat, lng]);

            if (state.recording) {
                state.track.push({ lat, lng, alt, speedKmh, heading, time });
                trackLine.addLatLng([lat, lng]);
                if (state.track.length % 5 === 0) map.panTo([lat, lng]);
            }
        }

        // --- KI CORE ---
        async function callGemini(prompt, systemPrompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    if (!response.ok) throw new Error();
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (err) {
                    if (i === 4) throw err;
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        async function generateAIRepo() {
            if (state.track.length < 5) return;
            const loader = document.getElementById('ai-repo-loader');
            const textarea = document.getElementById('save-notes');
            loader.classList.remove('hidden');
            try {
                const prompt = `Erstelle Logbucheintrag für Ballonfahrt: Max ${Math.round(state.maxAlt)}m, Start ${new Date(state.startTime).toLocaleTimeString()}.`;
                textarea.value = await callGemini(prompt, "Du bist ein erfahrener Ballonpilot. Schreibe kurz und atmosphärisch.");
            } finally { loader.classList.add('hidden'); }
        }

        async function updateAINavigation() {
            if (!state.waypoint || !state.currentPos) return;
            try {
                const prompt = `Pos: ${state.currentPos.lat}, ${state.currentPos.lng}. Ziel: ${state.waypoint.lat}, ${state.waypoint.lng}. Höhe: ${state.currentAlt}m.`;
                const instruction = await callGemini(prompt, "Gib EINE kurze Handlungsanweisung (max 8 Wörter), um das Ziel zu erreichen.");
                document.getElementById('nav-text').innerText = instruction;
                state.lastAINavUpdate = Date.now();
            } catch (e) {}
        }

        async function checkAIWeather(lat, lng, alt) {
            document.getElementById('ai-weather-info').style.display = 'block';
            try {
                const advice = await callGemini(`Wettercheck ${lat}, ${lng}, ${alt}m`, "Kurzer Sicherheitstipp für Ballonpiloten (max 10 Wörter).");
                document.getElementById('ai-weather-text').innerText = advice;
                state.lastAIWeatherUpdate = Date.now();
            } catch (e) {}
        }

        // --- GPX EXPORT ---
        function downloadGPX() {
            if (!state.currentReplay) return;
            const f = state.currentReplay;
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="AeroNav" xmlns="http://www.topografix.com/GPX/1/1">
  <trk><name>${f.name}</name><trkseg>`;
            
            f.track.forEach(p => {
                gpx += `\n    <trkpt lat="${p.lat}" lon="${p.lng}"><ele>${p.alt}</ele><time>${new Date(p.time).toISOString()}</time></trkpt>`;
            });

            gpx += `\n  </trkseg></trk></gpx>`;
            
            const blob = new Blob([gpx], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${f.name.replace(/\s+/g, '_')}.gpx`;
            a.click();
        }

        // --- HÖHENPROFIL (Chart) ---
        function renderAltitudeChart(track) {
            const ctx = document.getElementById('altitudeChart').getContext('2d');
            if (state.chart) state.chart.destroy();
            
            const labels = track.filter((_, i) => i % 5 === 0).map((_, i) => i);
            const data = track.filter((_, i) => i % 5 === 0).map(p => p.alt);

            state.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Höhe (m)',
                        data: data,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: false, ticks: { font: { size: 8 } } },
                        x: { display: false }
                    }
                }
            });
        }

        // --- REPLAY & HISTORY ---
        function loadToMap(id) {
            const flights = JSON.parse(localStorage.getItem('flights') || '[]');
            const f = flights.find(x => x.id === id);
            if (!f) return;

            state.currentReplay = f;
            trackLine.setLatLngs(f.track.map(p => [p.lat, p.lng]));
            map.fitBounds(trackLine.getBounds());
            
            document.getElementById('replay-info').classList.remove('hidden');
            document.getElementById('replay-title').innerText = f.name;
            document.getElementById('replay-notes').innerText = f.notes || "Keine Notizen";
            
            renderAltitudeChart(f.track);
        }

        // --- RECORDING & MODALS ---
        function toggleRecording() {
            if (!state.recording) {
                state.recording = true; state.startTime = Date.now(); state.track = [];
                document.getElementById('btn-toggle').className = "btn-large flex-1 bg-red-600 text-white flex gap-2 justify-center";
                document.getElementById('btn-text').innerText = "Stoppen";
            } else {
                state.recording = false;
                document.getElementById('save-modal').style.display = 'flex';
                document.getElementById('save-name').value = `Fahrt ${new Date().toLocaleDateString()}`;
            }
        }

        function confirmSave() {
            const flight = { id: Date.now(), name: document.getElementById('save-name').value, notes: document.getElementById('save-notes').value, track: state.track };
            const flights = JSON.parse(localStorage.getItem('flights') || '[]');
            flights.push(flight);
            localStorage.setItem('flights', JSON.stringify(flights));
            closeSaveModal();
        }

        function closeSaveModal() { document.getElementById('save-modal').style.display = 'none'; resetUI(); }
        function resetUI() { document.getElementById('btn-toggle').className = "btn-large flex-1 bg-green-600 text-white flex gap-2 justify-center"; document.getElementById('btn-text').innerText = "Fahrt starten"; }
        function openMenu() { document.getElementById('menu-modal').style.display = 'flex'; renderHistory(); }
        function closeMenu() { document.getElementById('menu-modal').style.display = 'none'; }
        function renderHistory() {
            const list = document.getElementById('saved-list');
            const flights = JSON.parse(localStorage.getItem('flights') || '[]');
            list.innerHTML = flights.reverse().map(f => `
                <div class="bg-white border p-3 rounded-xl flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-sm">${f.name}</h3>
                        <p class="text-[10px] text-slate-400">${f.track.length} Wegpunkte</p>
                    </div>
                    <button onclick="loadToMap(${f.id})" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-2 rounded-lg font-bold">Details</button>
                </div>`).join('');
        }

        // --- UTILS ---
        function setWaypoint(latlng) {
            if (state.waypointMarker) map.removeLayer(state.waypointMarker);
            state.waypoint = latlng;
            state.waypointMarker = L.marker(latlng).addTo(map);
            document.getElementById('nav-indicator').style.display = 'block';
            updateAINavigation();
        }
        function clearWaypoint() { if (state.waypointMarker) map.removeLayer(state.waypointMarker); state.waypoint = null; document.getElementById('nav-indicator').style.display = 'none'; }
        function retryGPS() { startGPSWatch(); }
        function startGPSWatch() { navigator.geolocation.watchPosition(handlePosition, () => showError("GPS Fehler", "Signal verloren"), { enableHighAccuracy: true }); }
        function showError(t, d) { document.getElementById('error-title').innerText = t; document.getElementById('error-desc').innerText = d; document.getElementById('error-overlay').style.display = 'flex'; }
        function hideError() { document.getElementById('error-overlay').style.display = 'none'; }
        
        function toggleSimulation() {
            if (!state.recording) toggleRecording();
            let lat = 51.16, lng = 10.45, alt = 200;
            setInterval(() => { alt += Math.random()*4-1.5; lat += 0.0002; lng += 0.0001; processData(lat, lng, alt, 15, 45, Date.now()); }, 1000);
            closeMenu();
        }

        map.on('contextmenu', (e) => setWaypoint(e.latlng));
        window.onload = startGPSWatch;
    </script>
</body>
</html>
