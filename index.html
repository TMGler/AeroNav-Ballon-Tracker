<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AeroNav Balloon Pilot</title>
    
    <!-- PWA Integration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AeroNav">

    <!-- Frameworks & Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --glass-bg: rgba(15, 23, 42, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-blue: #3b82f6;
            --accent-red: #ef4444;
            --accent-green: #22c55e;
        }

        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 0;
            background: #020617;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        .hud-top {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 800px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 10px;
        }

        .hud-value { text-align: center; }
        .hud-label { font-size: 0.65rem; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.05em; }
        .hud-num { font-size: 1.25rem; font-weight: 700; font-family: 'Courier New', Courier, monospace; }

        /* Anchored to bottom left */
        .sidebar-left { 
            position: absolute; 
            bottom: 30px; 
            left: 10px; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        
        .sidebar-right-container { 
            position: absolute; 
            top: 80px; 
            right: 10px; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            align-items: end;
            gap: 5px;
        }

        .sidebar-right-content {
            width: 80px;
            transition: all 0.3s ease;
            overflow: hidden;
            max-height: 60vh;
            opacity: 1;
        }
        
        .sidebar-right-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0;
            border: none;
        }

        .btn-round { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.2s; cursor: pointer; }
        .btn-round:active { transform: scale(0.9); }
        .btn-round.active { background: var(--accent-blue); color: white; }
        .btn-round.recording { background: var(--accent-red); animation: pulse 2s infinite; }
        
        .btn-small-toggle {
            width: 36px; height: 36px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; cursor: pointer;
            background: var(--glass-bg); border: 1px solid var(--glass-border);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(6px); z-index: 2000; display: none; padding: 20px; overflow-y: auto; }
        .modal-content { max-width: 1000px; margin: auto; min-height: 85vh; display: flex; flex-direction: column; }

        .tab-btn { padding: 12px 20px; border-bottom: 2px solid transparent; font-weight: 500; opacity: 0.6; }
        .tab-btn.active { border-color: var(--accent-blue); color: var(--accent-blue); opacity: 1; }

        .wind-layer { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }

        .leaflet-tile { filter: brightness(0.85); }
        .satellite-layer .leaflet-tile { filter: none; }

        .compass-arrow { width: 0; height: 0; border-left: 5px solid solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid var(--accent-blue); transition: transform 0.3s; }
        
        /* Green arrow for measured wind */
        .arrow-green { border-bottom-color: #4ade80 !important; }

        /* Custom Balloon Marker Image Style */
        .balloon-marker-img {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            object-fit: cover;
            background: #fff;
        }

        /* Form Controls */
        input, select, textarea { background: rgba(30, 41, 59, 0.5) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: white !important; border-radius: 6px; padding: 8px 12px; width: 100%; }
        input[type="color"] { padding: 0; height: 40px; }
        input:focus { border-color: var(--accent-blue) !important; outline: none; }
        label { font-size: 0.75rem; color: #94a3b8; margin-bottom: 4px; display: block; }

        .perf-grid input { padding: 4px; text-align: center; font-size: 0.8rem; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .loader {
            border: 2px solid rgba(255,255,255,0.1);
            border-left-color: var(--accent-blue);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- MOBILE OPTIMIZATIONS --- */
        @media (max-width: 640px) {
            .hud-top {
                width: 98%;
                top: 5px;
                padding: 6px 4px;
                gap: 2px;
            }
            .hud-num { font-size: 1.1rem; }
            .hud-label { font-size: 0.55rem; }
            
            .modal-content {
                width: 100%;
                height: 100%;
                min-height: 100vh;
                border-radius: 0;
                border: none;
                margin: 0;
                padding: 15px;
            }
            
            .sidebar-left {
                left: 5px;
                bottom: 20px;
                gap: 8px;
            }
            .sidebar-right-container {
                right: 5px;
                top: 75px;
            }
            .btn-round {
                width: 44px;
                height: 44px;
                font-size: 1rem;
            }
            
            #status-badges {
                right: 60px;
                top: 75px;
            }
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <!-- HUD TOP -->
    <div class="hud-top glass-panel" id="hud">
        <div class="hud-value">
            <div class="hud-label">H√∂he</div>
            <div class="hud-num"><span id="hud-alt">0</span> <small class="text-xs font-normal" id="lbl-alt">m</small></div>
        </div>
        <div class="hud-value">
            <div class="hud-label">Vario</div>
            <div class="hud-num"><span id="hud-vario">0.0</span> <small class="text-xs font-normal" id="lbl-vario">m/s</small></div>
        </div>
        <div class="hud-value">
            <div class="hud-label">Speed</div>
            <div class="hud-num"><span id="hud-speed">0.0</span> <small class="text-xs font-normal" id="lbl-speed">km/h</small></div>
        </div>
        <div class="hud-value">
            <div class="hud-label">Kurs</div>
            <div class="hud-num"><span id="hud-course">360</span>¬∞</div>
        </div>
    </div>

    <!-- STATUS BADGES -->
    <div id="status-badges" class="absolute top-[80px] right-[100px] z-[990] flex gap-2 pointer-events-none">
        <div id="badge-gps" class="hidden px-3 py-1 rounded font-bold text-xs text-white bg-red-500/80 backdrop-blur-sm shadow-lg border border-white/20 transition-colors">NO GPS</div>
        <div id="badge-rec" class="hidden px-3 py-1 rounded font-bold text-xs text-white bg-red-600/90 backdrop-blur-sm shadow-lg border border-white/20 animate-pulse">REC</div>
    </div>

    <!-- SIDEBAR LEFT -->
    <div class="sidebar-left">
        <button id="btn-center" class="btn-round glass-panel" title="Zentrieren / Lock">
            <i class="fas fa-crosshairs"></i>
        </button>
        <button id="btn-record" class="btn-round glass-panel" title="Aufnahme">
            <i class="fas fa-circle"></i>
        </button>
        <button id="btn-screenshot" class="btn-round glass-panel" title="Screenshot">
            <i class="fas fa-camera"></i>
        </button>
        <button id="btn-layers" class="btn-round glass-panel" title="Ebenen">
            <i class="fas fa-layer-group"></i>
        </button>
        <div class="mt-4 flex flex-col gap-2">
            <button id="btn-settings" class="btn-round glass-panel bg-slate-800" title="Men√º">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>

    <!-- SIDEBAR RIGHT (Wind) -->
    <div class="sidebar-right-container">
        <button id="btn-wind-toggle" class="btn-small-toggle glass-panel text-blue-400" title="Windanzeige umschalten">
            <i class="fas fa-wind"></i>
        </button>
        <div id="wind-panel" class="sidebar-right-content glass-panel p-2 flex flex-col gap-1 overflow-y-auto">
            <div class="flex justify-between items-center border-b border-white/10 mb-1 pb-1">
                <span class="text-[0.6rem] uppercase text-slate-400">Wind</span>
                <div class="flex gap-1">
                    <button onclick="weatherService.fetchLiveWind()" class="text-[0.6rem] text-green-400 hover:text-white" title="Live-Daten laden"><i class="fas fa-sync-alt"></i></button>
                    <button onclick="ui.editWindSettings()" class="text-[0.6rem] text-blue-400 hover:text-white" title="Wind bearbeiten"><i class="fas fa-pen"></i></button>
                </div>
            </div>
            <div id="wind-layers-container"></div>
        </div>
    </div>

    <!-- SIMULATION PANEL -->
    <div id="sim-panel" class="absolute bottom-8 left-1/2 -translate-x-1/2 z-[1000] hidden glass-panel px-6 py-3 flex items-center gap-4 border border-white/10 shadow-2xl">
        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider border-r border-white/10 pr-3">Sim Control</div>
        <div class="flex gap-3">
            <button onclick="simulation.adjustAltitude(-50)" class="bg-red-600/90 hover:bg-red-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg transition transform active:scale-95 text-sm flex items-center gap-2">
                <i class="fas fa-arrow-down"></i> 50m
            </button>
            <button onclick="simulation.adjustAltitude(50)" class="bg-blue-600/90 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg transition transform active:scale-95 text-sm flex items-center gap-2">
                <i class="fas fa-arrow-up"></i> 50m
            </button>
        </div>
    </div>

    <!-- MAIN MODAL -->
    <div id="main-modal" class="overlay">
        <div class="modal-content glass-panel p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold flex items-center gap-2">
                    <i class="fas fa-parachute-box text-blue-400"></i> AeroNav Control
                </h2>
                <button onclick="ui.closeModal()" class="text-3xl opacity-50 hover:opacity-100">&times;</button>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-white/10 mb-6 overflow-x-auto whitespace-nowrap scrollbar-hide">
                <button class="tab-btn active" onclick="ui.switchTab('planning')">Planung</button>
                <button class="tab-btn" onclick="ui.switchTab('fleet')">Flotte</button>
                <button class="tab-btn" onclick="ui.switchTab('cylinders')">Gasflaschen</button>
                <button class="tab-btn" onclick="ui.switchTab('passengers')">Passagiere</button>
                <button class="tab-btn" onclick="ui.switchTab('logbook')">Logbuch</button>
                <button class="tab-btn" onclick="ui.switchTab('environment')">Wetter/Wind</button>
                <button class="tab-btn" onclick="ui.switchTab('settings')">Einstellungen</button>
            </div>

            <!-- Tab Content -->
            <div id="tab-content" class="flex-grow overflow-y-auto pr-2"></div>
        </div>
    </div>

    <script>
        /**
         * STATE & CONSTANTS
         */
        const STORAGE_KEY = "AERONAV_PRO_DATA";
        
        let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
            pilot: { name: "Max Mustermann", weight: 85 },
            balloons: [],
            cylinders: [],
            passengers: [],
            logs: [],
            plannings: [], 
            archive: [], // NEW: Archive array
            windLayers: [
                { alt: 0, dir: 270, speed: 5 },
                { alt: 500, dir: 285, speed: 12 },
                { alt: 1000, dir: 300, speed: 18 },
                { alt: 2000, dir: 330, speed: 25 }
            ],
            measuredWindLayers: [],
            settings: { 
                apiKey: "", 
                unitAlt: 'm', 
                unitSpeed: 'kmh', 
                unitVario: 'ms',
                trackColor: '#3b82f6',
                trackWidth: 4,
                mapStyle: 'dark',
                mode: 'sim', 
                activeBalloonId: null 
            }
        };

        // Migration for older states
        if(!state.settings.unitVario) state.settings.unitVario = 'ms';
        if(!state.settings.trackColor) state.settings.trackColor = '#3b82f6';
        if(!state.settings.trackWidth) state.settings.trackWidth = 4;
        if(!state.settings.mapStyle) state.settings.mapStyle = 'dark';
        if(!state.settings.mode) state.settings.mode = 'sim';
        if(!state.measuredWindLayers) state.measuredWindLayers = [];
        if(state.settings.activeBalloonId === undefined) state.settings.activeBalloonId = null;
        if(!state.plannings) state.plannings = [];
        if(!state.archive) state.archive = []; // Ensure archive exists

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        /**
         * ENGINE: SIMULATION & PHYSICS
         */
        const simulation = {
            gpsWatchId: null,
            lat: 51.1657, lng: 10.4515, alt: 200, targetAlt: 200,
            course: 270, speed: 5, vario: 0,

            init() {
                setInterval(() => this.tick(), 1000);
                this.applyMode();
            },

            applyMode() {
                const mode = state.settings.mode;
                const simPanel = document.getElementById('sim-panel');
                const gpsBadge = document.getElementById('badge-gps');

                if (mode === 'gps') {
                    simPanel.classList.add('hidden'); 
                    gpsBadge.classList.remove('hidden');
                    this.startGPS();
                } else {
                    simPanel.classList.remove('hidden');
                    gpsBadge.classList.add('hidden');
                    this.stopGPS();
                }
            },

            startGPS() {
                const gpsBadge = document.getElementById('badge-gps');
                if (navigator.geolocation) {
                    if (this.gpsWatchId) navigator.geolocation.clearWatch(this.gpsWatchId);
                    this.gpsWatchId = navigator.geolocation.watchPosition(pos => {
                        const c = pos.coords;
                        gpsBadge.innerText = "GPS OK";
                        gpsBadge.classList.remove('bg-red-500/80');
                        gpsBadge.classList.add('bg-green-600/80');
                        this.lat = c.latitude;
                        this.lng = c.longitude;
                        if(c.altitude !== null) this.alt = c.altitude;
                        this.speed = (c.speed || 0) * 1.94384; 
                        if(c.heading !== null && !isNaN(c.heading)) this.course = c.heading;
                        flightManager.updateHUD(this.getCurrentState());
                    }, err => {
                        console.warn("GPS Fehler:", err.message);
                        gpsBadge.innerText = "NO GPS";
                        gpsBadge.classList.remove('bg-green-600/80');
                        gpsBadge.classList.add('bg-red-500/80');
                    }, { enableHighAccuracy: true });
                } else {
                    gpsBadge.innerText = "NO GPS SUPP";
                    gpsBadge.classList.add('bg-red-500/80');
                }
            },

            stopGPS() {
                if (this.gpsWatchId) {
                    navigator.geolocation.clearWatch(this.gpsWatchId);
                    this.gpsWatchId = null;
                }
                const gpsBadge = document.getElementById('badge-gps');
                gpsBadge.classList.add('hidden');
            },

            adjustAltitude(delta) { this.targetAlt += delta; if (this.targetAlt < 0) this.targetAlt = 0; },

            tick() {
                if (state.settings.mode === 'gps') return;
                const diff = this.targetAlt - this.alt;
                this.vario = diff * 0.08;
                this.alt += this.vario;
                const wind = this.getWindAtAlt(this.alt);
                this.course = wind.dir;
                this.speed = wind.speed; 
                const moveScale = this.speed * 0.000005;
                const rad = (this.course - 90) * (Math.PI / 180);
                this.lat += Math.sin(rad) * moveScale;
                this.lng += Math.cos(rad) * moveScale;
                flightManager.updateHUD(this.getCurrentState());
            },

            getWindAtAlt(altitude) {
                const sorted = [...state.windLayers].sort((a,b) => a.alt - b.alt);
                let lower = sorted[0], upper = sorted[sorted.length-1];
                for (let i = 0; i < sorted.length - 1; i++) {
                    if (altitude >= sorted[i].alt && altitude <= sorted[i+1].alt) {
                        lower = sorted[i]; upper = sorted[i+1]; break;
                    }
                }
                const factor = upper.alt === lower.alt ? 0 : (altitude - lower.alt) / (upper.alt - lower.alt);
                return {
                    dir: lower.dir + (upper.dir - lower.dir) * factor,
                    speed: lower.speed + (upper.speed - lower.speed) * factor
                };
            },

            getCurrentState() { return { lat: this.lat, lng: this.lng, alt: this.alt, course: this.course, speed: this.speed, vario: this.vario }; }
        };

        const weatherService = {
            async fetchLiveWind() {
                const center = mapManager.map.getCenter();
                const lat = center.lat;
                const lng = center.lng;
                document.getElementById('wind-layers-container').innerHTML = '<div class="text-center p-2"><div class="loader"></div></div>';
                try {
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=wind_speed_10m,wind_direction_10m&hourly=wind_speed_1000hPa,wind_direction_1000hPa,wind_speed_950hPa,wind_direction_950hPa,wind_speed_850hPa,wind_direction_850hPa,wind_speed_700hPa,wind_direction_700hPa&wind_speed_unit=kn`;
                    const response = await fetch(url);
                    const data = await response.json();
                    if (!data.hourly) throw new Error("Keine Daten");
                    const now = new Date();
                    const currentHourIso = now.toISOString().slice(0, 13) + ":00";
                    const hourIndex = data.hourly.time.findIndex(t => t.startsWith(currentHourIso)) || 0;
                    const newLayers = [
                        { alt: 0, dir: data.current.wind_direction_10m, speed: data.current.wind_speed_10m },
                        { alt: 100, dir: data.hourly.wind_direction_1000hPa[hourIndex], speed: data.hourly.wind_speed_1000hPa[hourIndex] },
                        { alt: 500, dir: data.hourly.wind_direction_950hPa[hourIndex], speed: data.hourly.wind_speed_950hPa[hourIndex] },
                        { alt: 1500, dir: data.hourly.wind_direction_850hPa[hourIndex], speed: data.hourly.wind_speed_850hPa[hourIndex] },
                        { alt: 3000, dir: data.hourly.wind_direction_700hPa[hourIndex], speed: data.hourly.wind_speed_700hPa[hourIndex] }
                    ];
                    state.windLayers = newLayers;
                    saveState();
                    ui.renderWind();
                    alert(`Live-Winddaten f√ºr ${lat.toFixed(2)}, ${lng.toFixed(2)} geladen!`);
                    if (ui.tab === 'environment') ui.render();
                } catch (e) {
                    alert("Fehler beim Laden der Wetterdaten: " + e.message);
                    ui.renderWind(); 
                }
            }
        };

        const mapManager = {
            map: null, marker: null, track: null, lock: false,
            layers: {
                dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'),
                light: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
            },
            init() {
                this.map = L.map('map', { zoomControl: false }).setView([51.1657, 10.4515], 13);
                const style = state.settings.mapStyle || 'dark';
                this.setLayer(style);
                
                // Initialize icon based on settings
                this.updateIcon();
                
                this.track = L.polyline([], { color: state.settings.trackColor, weight: state.settings.trackWidth }).addTo(this.map);
                document.getElementById('btn-center').onclick = () => { this.lock = !this.lock; document.getElementById('btn-center').classList.toggle('active', this.lock); };
                document.getElementById('btn-layers').onclick = () => this.cycle();
                setTimeout(() => this.map.invalidateSize(), 500);
            },
            update(pos) {
                this.marker.setLatLng([pos.lat, pos.lng]);
                if (this.lock) this.map.panTo([pos.lat, pos.lng]);
                if (flightManager.recording) {
                    flightManager.points.push([pos.lat, pos.lng]);
                    this.track.setLatLngs(flightManager.points);
                }
            },
            updateTrackStyle() {
                if(this.track) {
                    this.track.setStyle({ color: state.settings.trackColor, weight: state.settings.trackWidth });
                }
            },
            updateIcon() {
                // Find Active Balloon
                let iconHtml = '<div class="text-3xl">üéà</div>';
                let className = '';
                
                if (state.settings.activeBalloonId) {
                    const balloon = state.balloons.find(b => b.id === state.settings.activeBalloonId);
                    if (balloon && balloon.image) {
                        iconHtml = `<img src="${balloon.image}" class="balloon-marker-img">`;
                        className = ''; // Style handled by balloon-marker-img class
                    }
                }

                const newIcon = L.divIcon({ html: iconHtml, className: className, iconSize: [44, 44], iconAnchor: [22, 22] });
                
                if (this.marker) {
                    this.marker.setIcon(newIcon);
                } else {
                    this.marker = L.marker([51.1657, 10.4515], { icon: newIcon }).addTo(this.map);
                }
            },
            setLayer(style) {
                if (this.map.hasLayer(this.layers.dark)) this.map.removeLayer(this.layers.dark);
                if (this.map.hasLayer(this.layers.light)) this.map.removeLayer(this.layers.light);
                if (this.map.hasLayer(this.layers.sat)) this.map.removeLayer(this.layers.sat);
                const m = document.getElementById('map');
                m.classList.remove('satellite-layer');
                if (style === 'light') { this.layers.light.addTo(this.map); } 
                else if (style === 'sat') { this.layers.sat.addTo(this.map); m.classList.add('satellite-layer'); } 
                else { this.layers.dark.addTo(this.map); }
                state.settings.mapStyle = style;
                saveState();
            },
            cycle() {
                if (state.settings.mapStyle === 'dark') this.setLayer('light');
                else if (state.settings.mapStyle === 'light') this.setLayer('sat');
                else this.setLayer('dark');
                if (ui.tab === 'settings' && document.getElementById('set-map-style')) {
                    document.getElementById('set-map-style').value = state.settings.mapStyle;
                }
            }
        };

        const flightManager = {
            recording: false, points: [], start: null,
            init() { document.getElementById('btn-record').onclick = () => this.toggle(); },
            toggle() {
                const recBadge = document.getElementById('badge-rec');
                if (this.recording) {
                    const end = new Date();
                    state.logs.push({ id: Date.now(), start: this.start.toISOString(), end: end.toISOString(), track: this.points, balloon: state.settings.mode === 'gps' ? "GPS Live" : "Simulation", notes: "" });
                    saveState();
                    this.recording = false;
                    this.points = [];
                    mapManager.track.setLatLngs([]);
                    document.getElementById('btn-record').classList.remove('recording');
                    recBadge.classList.add('hidden');
                    ui.switchTab('logbook'); ui.openModal();
                } else {
                    state.measuredWindLayers = [];
                    ui.renderWind(); 
                    this.recording = true; 
                    this.start = new Date();
                    document.getElementById('btn-record').classList.add('recording');
                    recBadge.classList.remove('hidden');
                }
            },
            updateHUD(data) {
                let dAlt = data.alt;
                let dSpeed = data.speed; // kt
                let dVario = data.vario; // m/s
                let uAlt = 'm';
                let uSpeed = 'kt';
                let uVario = 'm/s';

                if (state.settings.unitAlt === 'ft') { dAlt = data.alt * 3.28084; uAlt = 'ft'; }
                if (state.settings.unitSpeed === 'kmh') { dSpeed = data.speed * 1.852; uSpeed = 'km/h'; } else { uSpeed = 'kt'; }
                if (state.settings.unitVario === 'fts') { dVario = data.vario * 3.28084; uVario = 'ft/s'; }

                document.getElementById('hud-alt').innerText = Math.round(dAlt);
                document.getElementById('lbl-alt').innerText = uAlt;
                document.getElementById('hud-speed').innerText = dSpeed.toFixed(1);
                document.getElementById('lbl-speed').innerText = uSpeed;
                document.getElementById('hud-course').innerText = Math.round(data.course);
                
                const varioValEl = document.getElementById('hud-vario');
                const varioLblEl = document.getElementById('lbl-vario');
                
                varioValEl.innerText = dVario.toFixed(1);
                varioLblEl.innerText = uVario;

                varioValEl.classList.remove('text-green-400', 'text-red-400');
                varioLblEl.classList.remove('text-green-400', 'text-red-400');

                if (data.vario >= 0.1) {
                    varioValEl.classList.add('text-green-400');
                    varioLblEl.classList.add('text-green-400');
                } else if (data.vario <= -0.1) {
                    varioValEl.classList.add('text-red-400');
                    varioLblEl.classList.add('text-red-400');
                }
                
                if (this.recording && data.speed > 1) { 
                    const bucketAlt = Math.round(data.alt / 50) * 50;
                    const existingIdx = state.measuredWindLayers.findIndex(l => l.alt === bucketAlt);
                    const newLayer = { alt: bucketAlt, dir: data.course, speed: data.speed, isMeasured: true };
                    
                    if (existingIdx >= 0) { state.measuredWindLayers[existingIdx] = newLayer; } 
                    else { state.measuredWindLayers.push(newLayer); }
                    ui.renderWind();
                }
                mapManager.update(data);
            }
        };

        const ui = {
            tab: 'planning', editingId: null, editingPlanId: null,
            planningMode: 'active', // 'active' or 'archive'

            init() {
                document.getElementById('btn-settings').onclick = () => this.openModal();
                document.getElementById('btn-screenshot').onclick = () => this.capture();
                document.getElementById('btn-wind-toggle').onclick = () => this.toggleWindPanel();
                this.renderWind();
            },
            toggleWindPanel() { document.getElementById('wind-panel').classList.toggle('collapsed'); },
            editWindSettings() { this.openModal(); this.switchTab('environment'); },
            openModal() { document.getElementById('main-modal').style.display = 'flex'; this.switchTab(this.tab); },
            closeModal() { document.getElementById('main-modal').style.display = 'none'; },
            switchTab(t) { 
                this.tab = t; this.editingId = null;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.onclick.toString().includes(`'${t}'`)));
                this.render(); 
            },
            render() {
                const c = document.getElementById('tab-content');
                c.innerHTML = '';
                if (this.editingId) { this.renderForm(c); return; }
                switch(this.tab) {
                    case 'planning': this.viewPlanning(c); break;
                    case 'fleet': this.viewFleet(c); break;
                    case 'cylinders': this.viewCylinders(c); break;
                    case 'passengers': this.viewPassengers(c); break;
                    case 'logbook': this.viewLogbook(c); break;
                    case 'settings': this.viewSettings(c); break;
                    case 'environment': this.viewEnvironment(c); break;
                }
            },

            // --- VIEWS ---
            viewFleet(c) {
                c.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Ballon-Flotte</h3><button onclick="ui.edit('new')" class="bg-blue-600 px-4 py-2 rounded text-sm">+ Ballon hinzuf√ºgen</button></div>`;
                state.balloons.forEach(b => {
                    const defaultCount = b.defaultCylinders ? b.defaultCylinders.length : 0;
                    c.innerHTML += `<div class="glass-panel p-4 mb-2 flex justify-between items-center"><div><div class="font-bold text-lg">${b.callsign}</div><div class="text-xs text-slate-400">${b.volume}m¬≥ | Std-Flaschen: ${defaultCount} | MTOM: ${b.mtom}kg</div></div><div class="flex gap-2"><button onclick="ui.edit('${b.id}')" class="bg-slate-700 px-3 py-1 rounded">Edit</button><button onclick="ui.delete('balloons','${b.id}')" class="text-red-400 p-1"><i class="fas fa-trash"></i></button></div></div>`;
                });
            },
            viewCylinders(c) {
                c.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Gasflaschen-Inventar</h3><button onclick="ui.edit('new')" class="bg-blue-600 px-4 py-2 rounded text-sm">+ Flasche hinzuf√ºgen</button></div>`;
                state.cylinders.forEach(cyl => {
                    const isTuvExpired = new Date(cyl.tuv) < new Date();
                    c.innerHTML += `<div class="glass-panel p-4 mb-2 flex justify-between items-center ${isTuvExpired ? 'border-red-500/50 border' : ''}"><div><div class="font-bold">${cyl.label} (${cyl.type})</div><div class="text-xs text-slate-400">SN: ${cyl.sn} | Tara: ${cyl.tare}kg | Gas: ${cyl.gas}kg | T√úV: <span class="${isTuvExpired ? 'text-red-400 font-bold' : ''}">${cyl.tuv}</span></div></div><div class="flex gap-2"><button onclick="ui.edit('${cyl.id}')" class="bg-slate-700 px-3 py-1 rounded">Edit</button><button onclick="ui.delete('cylinders','${cyl.id}')" class="text-red-400 p-1"><i class="fas fa-trash"></i></button></div></div>`;
                });
            },
            viewPassengers(c) {
                c.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Passagier-Datenbank</h3><button onclick="ui.edit('new')" class="bg-blue-600 px-4 py-2 rounded text-sm">+ Passagier hinzuf√ºgen</button></div>`;
                state.passengers.forEach(p => {
                    c.innerHTML += `<div class="glass-panel p-4 mb-2 flex justify-between items-center"><div><div class="font-bold">${p.name}</div><div class="text-xs text-slate-400">${p.weight}kg | ${p.gender} | ${p.phone}</div></div><div class="flex gap-2"><button onclick="ui.taufe('${p.name}')" class="bg-amber-600/20 text-amber-500 px-2 py-1 rounded text-xs">Taufe</button><button onclick="ui.edit('${p.id}')" class="bg-slate-700 px-3 py-1 rounded text-xs">Edit</button><button onclick="ui.delete('passengers','${p.id}')" class="text-red-400 p-1"><i class="fas fa-trash"></i></button></div></div>`;
                });
            },
            viewLogbook(c) {
                c.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Fahrtenbuch</h3><button onclick="ui.edit('new')" class="bg-blue-600 px-4 py-2 rounded text-sm">+ Manueller Eintrag</button></div>`;
                state.logs.sort((a,b)=>new Date(b.start)-new Date(a.start)).forEach(l => {
                    c.innerHTML += `<div class="glass-panel p-4 mb-2 flex justify-between items-center"><div><div class="font-bold">${new Date(l.start).toLocaleDateString()} - ${l.balloon}</div><div class="text-xs text-slate-400">${l.start.split('T')[1].substring(0,5)} bis ${l.end.split('T')[1].substring(0,5)} | ${l.notes}</div></div><div class="flex gap-2"><button onclick="ui.delete('logs','${l.id}')" class="text-red-400 p-1"><i class="fas fa-trash"></i></button></div></div>`;
                });
            },
            viewPlanning(c) {
                // Initial plannings/archive array check
                if (!state.plannings) { state.plannings = []; saveState(); }
                if (!state.archive) { state.archive = []; saveState(); }

                const isArchive = this.planningMode === 'archive';
                const listData = isArchive ? state.archive : state.plannings;
                const listTitle = isArchive ? 'Archiv / Vorlagen' : 'Aktive Planungen';

                c.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">Weight & Balance Planung</h3>
                    
                    <!-- Saved Plans List / Archive Switch -->
                    <div class="mb-6 p-4 glass-panel border border-white/10">
                        <div class="flex gap-4 border-b border-white/10 pb-2 mb-2 text-sm">
                            <button onclick="ui.setPlanView('active')" class="${!isArchive ? 'text-blue-400 font-bold border-b-2 border-blue-400' : 'text-slate-500 hover:text-slate-300'} pb-1 transition">Aktive Planungen</button>
                            <button onclick="ui.setPlanView('archive')" class="${isArchive ? 'text-blue-400 font-bold border-b-2 border-blue-400' : 'text-slate-500 hover:text-slate-300'} pb-1 transition">Archiv</button>
                        </div>

                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xs uppercase text-slate-400 font-bold">${listTitle}</h4>
                            ${!isArchive ? '<button onclick="ui.clearPlanForm()" class="text-xs bg-slate-700 px-3 py-1 rounded hover:bg-slate-600 transition">+ Neue Planung</button>' : ''}
                        </div>

                        <div class="max-h-32 overflow-y-auto space-y-1" id="saved-plans-list">
                            ${listData.length === 0 ? `<div class="text-xs text-slate-500 italic p-2">${isArchive ? 'Archiv ist leer' : 'Keine aktiven Planungen'}</div>` : 
                                listData.sort((a,b) => b.id - a.id).map(p => `
                                    <div class="flex justify-between items-center bg-slate-800 p-2 rounded text-xs group hover:bg-slate-700/50 transition">
                                        <div class="cursor-pointer flex-1" onclick="${isArchive ? `ui.loadTemplate('${p.id}')` : `ui.loadPlan('${p.id}')`}" title="${isArchive ? 'Als Vorlage laden' : 'Bearbeiten'}">
                                            <div class="font-bold text-white flex items-center gap-2">
                                                ${isArchive ? '<i class="fas fa-history text-slate-500"></i>' : ''} 
                                                ${p.name}
                                            </div>
                                            <div class="text-slate-400 text-[10px]">${p.date} | ${p.balloonName}</div>
                                        </div>
                                        <div class="flex gap-1">
                                            ${!isArchive ? 
                                                `<button onclick="ui.archivePlan(${p.id})" class="text-blue-400 hover:text-blue-300 p-1 px-2 bg-slate-900/50 rounded" title="Ins Archiv verschieben"><i class="fas fa-box-archive"></i></button>` : 
                                                `<button onclick="ui.unarchivePlan(${p.id})" class="text-green-400 hover:text-green-300 p-1 px-2 bg-slate-900/50 rounded" title="Wiederherstellen"><i class="fas fa-box-open"></i></button>`
                                            }
                                            <button onclick="ui.delete('${isArchive ? 'archive' : 'plannings'}', ${p.id})" class="text-red-400 hover:text-red-300 p-1 px-2 bg-slate-900/50 rounded"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label>Bezeichnung der Planung</label>
                                <input type="text" id="plan-name" placeholder="z.B. Morgenfahrt Alpen" class="bg-slate-800 border-slate-600 focus:border-blue-500">
                            </div>
                            <div>
                                <label>Ballon w√§hlen</label>
                                <select id="plan-balloon" onchange="ui.selectBalloon()">
                                    <option value="">-- W√§hlen --</option>
                                    ${state.balloons.map(b => `<option value="${b.id}">${b.callsign}</option>`).join('')}
                                </select>
                            </div>
                            
                            <!-- Cylinder List -->
                            <div>
                                <label>Gasflaschen f√ºr diese Fahrt</label>
                                <div class="glass-panel p-3 border border-white/5 bg-slate-900/40">
                                    <div id="plan-cyl-list" class="space-y-2 mb-3"><div class="text-xs text-slate-500 italic">Keine Flaschen ausgew√§hlt</div></div>
                                    <div class="flex gap-2 pt-2 border-t border-white/10">
                                        <select id="plan-cyl-add-select" class="text-xs bg-slate-800 border-none"><option value="">+ Flasche w√§hlen</option>${state.cylinders.map(c => `<option value="${c.id}">${c.label} (${c.type}) - ${c.gas+c.tare}kg</option>`).join('')}</select>
                                        <button onclick="ui.addPlanCylinder()" class="bg-blue-600 px-3 rounded text-xs hover:bg-blue-500"><i class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label>Passagiere w√§hlen</label>
                                <div class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto p-2 border border-white/5 rounded" id="plan-pax">
                                    ${state.passengers.map(p => `<label class="flex items-center gap-2 bg-slate-800 p-2 rounded text-[10px] hover:bg-slate-700 cursor-pointer"><input type="checkbox" value="${p.id}" onchange="ui.recalcWB()" class="w-4 h-4"> ${p.name} (${p.weight}kg)</label>`).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-2">
                                <div><label>Startort Temp (¬∞C)</label><input type="number" id="plan-temp" value="15" onchange="ui.recalcWB()"></div>
                                <div><label>Zielh√∂he (m)</label><input type="number" id="plan-alt" value="1000" onchange="ui.recalcWB()"></div>
                            </div>
                            
                            <div id="wb-result" class="glass-panel p-6 border-blue-500/30 border min-h-[200px] flex flex-col justify-center text-center">
                                <div class="text-slate-500 italic">Bitte Ballon und Zuladung w√§hlen...</div>
                            </div>
                            
                            <button onclick="ui.savePlan()" id="btn-save-plan" class="bg-green-600 hover:bg-green-500 w-full py-3 rounded font-bold shadow-lg shadow-green-900/20 mt-4 transition transform active:scale-95 flex items-center justify-center gap-2">
                                <i class="fas fa-save"></i> Planung Speichern
                            </button>
                        </div>
                    </div>
                `;
            },

            viewSettings(c) {
                c.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">Einstellungen</h3>
                    <div class="grid md:grid-cols-2 gap-8">
                        <section class="space-y-4">
                            <h4 class="font-bold text-blue-400">Pilot & System</h4>
                            <div><label>Name des Piloten</label><input type="text" id="set-pilot-name" value="${state.pilot.name}"></div>
                            <div><label>Gewicht (kg)</label><input type="number" id="set-pilot-weight" value="${state.pilot.weight}"></div>
                            <div>
                                <label>Aktueller Ballon (f√ºr Karte)</label>
                                <select id="set-active-balloon" class="bg-slate-800 text-sm">
                                    <option value="">-- Standard (Emoji) --</option>
                                    ${state.balloons.map(b => `<option value="${b.id}" ${state.settings.activeBalloonId === b.id ? 'selected' : ''}>${b.callsign}</option>`).join('')}
                                </select>
                            </div>
                            <div class="pt-2"><label>Gemini API Key</label><input type="password" id="set-api-key" value="${state.settings.apiKey || ''}" placeholder="AI API Key..."></div>
                            
                            <h4 class="font-bold text-blue-400 mt-2">Einheiten</h4>
                            <div class="grid grid-cols-3 gap-2">
                                <div><label>H√∂he</label><select id="set-unit-alt"><option value="m" ${state.settings.unitAlt==='m'?'selected':''}>Meter (m)</option><option value="ft" ${state.settings.unitAlt==='ft'?'selected':''}>Fu√ü (ft)</option></select></div>
                                <div><label>Speed</label><select id="set-unit-speed"><option value="kmh" ${state.settings.unitSpeed==='kmh'?'selected':''}>km/h</option><option value="kt" ${state.settings.unitSpeed==='kt'?'selected':''}>Knoten (kt)</option></select></div>
                                <div><label>Vario</label><select id="set-unit-vario"><option value="ms" ${state.settings.unitVario==='ms'?'selected':''}>m/s</option><option value="fts" ${state.settings.unitVario==='fts'?'selected':''}>ft/s</option></select></div>
                            </div>
                        </section>
                        
                        <section class="space-y-4">
                            <h4 class="font-bold text-blue-400">Karte & Anzeige</h4>
                            
                            <div>
                                <label class="mb-2 block">Betriebsmodus</label>
                                <div class="flex items-center justify-between bg-white/5 p-3 rounded border border-white/10">
                                    <div class="flex flex-col">
                                        <span class="text-sm font-bold text-white">GPS / Live-Tracking</span>
                                        <span class="text-[10px] text-slate-400">Verwendet echte Standortdaten</span>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="set-mode-toggle" class="sr-only peer" ${state.settings.mode === 'gps' ? 'checked' : ''}>
                                        <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                                <div class="text-[10px] text-slate-500 mt-1 text-right">
                                    ${state.settings.mode === 'gps' ? 'Modus: GPS Aktiv' : 'Modus: Simulation (Training)'}
                                </div>
                            </div>

                            <div>
                                <label>Kartenstil</label>
                                <select id="set-map-style">
                                    <option value="dark" ${state.settings.mapStyle==='dark'?'selected':''}>Dark Matter (Dunkel)</option>
                                    <option value="light" ${state.settings.mapStyle==='light'?'selected':''}>OpenStreetMap (Hell)</option>
                                    <option value="sat" ${state.settings.mapStyle==='sat'?'selected':''}>Satellit</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label>Track Farbe</label><input type="color" id="set-track-color" value="${state.settings.trackColor}"></div>
                                <div><label>Track St√§rke (px)</label><input type="number" id="set-track-width" value="${state.settings.trackWidth}" min="1" max="10"></div>
                            </div>

                            <h4 class="font-bold text-red-400 mt-4">Datenverwaltung</h4>
                            <div class="flex flex-col gap-2">
                                <button onclick="system.exportData()" class="bg-slate-700 py-2 rounded text-sm">Backup Export (JSON)</button>
                                <button onclick="system.resetData()" class="bg-red-900/40 text-red-300 py-2 rounded text-sm">Daten zur√ºcksetzen</button>
                            </div>
                        </section>
                        
                        <div class="col-span-2 mt-4">
                            <button onclick="ui.saveSettings()" class="bg-blue-600 w-full py-3 rounded font-bold shadow-lg shadow-blue-900/20">Einstellungen Speichern</button>
                        </div>
                    </div>
                `;
            },

            viewEnvironment(c) {
                c.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">Wetter & Wind Simulation</h3>
                    <div class="glass-panel p-6 border-white/10 border">
                        <div class="flex justify-between items-start mb-4">
                            <p class="text-sm text-slate-400">Hier definierst du die Windschichten f√ºr die Simulation. Der Ballon bewegt sich basierend auf der aktuellen H√∂he und diesen Werten.</p>
                            <button onclick="weatherService.fetchLiveWind()" class="bg-green-600/20 text-green-400 border border-green-500/50 px-3 py-1 rounded text-xs whitespace-nowrap hover:bg-green-600 hover:text-white transition"><i class="fas fa-satellite-dish mr-1"></i> Live-Daten laden</button>
                        </div>
                        <div class="grid grid-cols-4 gap-2 text-xs uppercase text-slate-500 font-bold mb-2">
                            <div>H√∂he (m)</div><div>Richtung (¬∞)</div><div>Speed (kt)</div><div></div>
                        </div>
                        <div id="wind-rows" class="space-y-2 mb-4">
                            ${state.windLayers.sort((a,b)=>a.alt-b.alt).map((w, idx) => `
                                <div class="grid grid-cols-4 gap-2 items-center">
                                    <input type="number" class="wind-edit-alt" value="${w.alt}" placeholder="H√∂he">
                                    <input type="number" class="wind-edit-dir" value="${w.dir}" placeholder="Dir">
                                    <input type="number" class="wind-edit-spd" value="${w.speed}" placeholder="Knots">
                                    <button onclick="ui.removeWindLayer(${idx})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="ui.addWindLayer()" class="bg-slate-700 px-4 py-2 rounded text-xs mb-6">+ Schicht hinzuf√ºgen</button>
                        <button onclick="ui.saveEnvironment()" class="bg-blue-600 w-full py-3 rounded font-bold shadow-lg">Wetterdaten Speichern</button>
                        <p class="text-[10px] text-slate-500 mt-2 text-center">Live-Daten bereitgestellt durch Open-Meteo.com (Kein Key erforderlich)</p>
                    </div>
                `;
            },

            edit(id) { this.editingId = id; this.render(); },
            renderForm(c) {
                if (this.tab === 'fleet') this.formBalloon(c);
                if (this.tab === 'cylinders') this.formCylinder(c);
                if (this.tab === 'passengers') this.formPassenger(c);
                if (this.tab === 'logbook') this.formLogManual(c);
            },
            
            formBalloon(c) {
                const b = state.balloons.find(x => x.id === this.editingId) || { callsign: "", volume: 3000, weight: 400, mtom: 1100, defaultCylinders: [], matrix: [[0.320, 0.280, 0.240],[0.280, 0.240, 0.200],[0.240, 0.200, 0.160],[0.200, 0.160, 0.120]], image: null };
                const defCyls = b.defaultCylinders || [];
                const renderDefaultList = () => defCyls.map(id => { const cyl = state.cylinders.find(cx => cx.id === id); if (!cyl) return ''; return `<div class="flex justify-between items-center bg-slate-800 p-2 rounded mb-1 text-xs default-cyl-item" data-id="${id}"><span>${cyl.label} (${cyl.type})</span> <button onclick="ui.removeEditCylinder(this)" class="text-red-400 hover:text-red-300"><i class="fas fa-times"></i></button></div>`; }).join('');

                c.innerHTML = `
                    <h3 class="text-xl font-bold mb-4">${this.editingId === 'new' ? 'Neuer Ballon' : 'Ballon bearbeiten'}</h3>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div><label>Kennung</label><input type="text" id="f-callsign" value="${b.callsign}" placeholder="z.B. D-OAAA"></div>
                            
                            <!-- Bild Upload -->
                            <div>
                                <label>Ballon Bild (f√ºr Karte)</label>
                                <div class="flex items-center gap-4 bg-white/5 p-2 rounded border border-white/10">
                                    <div class="w-12 h-12 bg-slate-800 rounded-full border border-white/20 flex items-center justify-center overflow-hidden shrink-0">
                                        <img id="preview-balloon-img" src="${b.image || ''}" class="w-full h-full object-cover ${b.image ? '' : 'hidden'}">
                                        <span class="${b.image ? 'hidden' : ''} text-[8px] text-slate-500 uppercase">Kein Bild</span>
                                    </div>
                                    <div class="flex-1">
                                        <input type="file" id="f-image" accept="image/*" class="text-xs w-full file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700" onchange="ui.handleImageUpload(this)">
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <div><label>Volumen (m¬≥)</label><input type="number" id="f-volume" value="${b.volume}"></div>
                                <div><label>Leergewicht (kg)</label><input type="number" id="f-weight" value="${b.weight}"></div>
                            </div>
                            <div><label>MTOM (kg)</label><input type="number" id="f-mtom" value="${b.mtom}"></div>
                            
                            <div class="border-t border-white/10 pt-4 mt-2">
                                <label class="text-blue-400 font-bold mb-2">Standard-Flaschenbest√ºckung</label>
                                <div class="glass-panel p-3 border border-white/5 bg-slate-900/40">
                                    <div id="edit-cyl-list" class="mb-3 max-h-32 overflow-y-auto">${defCyls.length > 0 ? renderDefaultList() : '<div class="text-xs text-slate-500 italic">Keine Standard-Flaschen</div>'}</div>
                                    <div class="flex gap-2"><select id="edit-cyl-select" class="text-xs bg-slate-800 border-none"><option value="">+ Flasche w√§hlen</option>${state.cylinders.map(c => `<option value="${c.id}">${c.label} (${c.type})</option>`).join('')}</select><button onclick="ui.addEditCylinder()" class="bg-blue-600 px-3 rounded text-xs hover:bg-blue-500"><i class="fas fa-plus"></i></button></div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label>Tragkraft-Matrix (kg/m¬≥)</label>
                            <div class="perf-grid grid grid-cols-4 gap-1 text-[10px] text-center">
                                <div></div><div>0¬∞C</div><div>15¬∞C</div><div>30¬∞C</div><div>0m</div>${b.matrix.map((row, i) => `${i > 0 ? `<div>${i*1000}m</div>` : ''}${row.map((val, j) => `<input type="number" step="0.001" class="matrix-input" data-row="${i}" data-col="${j}" value="${val}">`).join('')}`).join('')}
                            </div>
                            <p class="text-[9px] text-slate-500 mt-2">Werte: Netto-Tragkraft in kg pro 1m¬≥ H√ºlle.</p>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6"><button onclick="ui.saveBalloon()" class="bg-blue-600 px-6 py-2 rounded">Speichern</button><button onclick="ui.switchTab('fleet')" class="bg-slate-700 px-6 py-2 rounded">Abbrechen</button></div>
                `;
            },
            
            handleImageUpload(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.getElementById('preview-balloon-img');
                        img.src = e.target.result;
                        img.classList.remove('hidden');
                        img.nextElementSibling.classList.add('hidden'); // Hide text placeholder
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            },

            formCylinder(c) {
                const cyl = state.cylinders.find(x => x.id === this.editingId) || { label: "", type: "V40", sn: "", tare: 15, gas: 20, tuv: "2028-12-31" };
                c.innerHTML = `<h3 class="text-xl font-bold mb-4">Gasflasche Details</h3><div class="grid grid-cols-2 gap-4"><div class="col-span-2"><label>Bezeichnung</label><input type="text" id="f-label" value="${cyl.label}"></div><div><label>Typ</label><input type="text" id="f-type" value="${cyl.type}"></div><div><label>Seriennummer</label><input type="text" id="f-sn" value="${cyl.sn}"></div><div><label>Tara (kg)</label><input type="number" id="f-tare" value="${cyl.tare}"></div><div><label>Gasf√ºllung (kg)</label><input type="number" id="f-gas" value="${cyl.gas}"></div><div class="col-span-2"><label>N√§chster T√úV</label><input type="date" id="f-tuv" value="${cyl.tuv}"></div></div><div class="flex gap-2 mt-6"><button onclick="ui.saveCylinder()" class="bg-blue-600 px-6 py-2 rounded">Speichern</button><button onclick="ui.switchTab('cylinders')" class="bg-slate-700 px-6 py-2 rounded">Abbrechen</button></div>`;
            },
            formPassenger(c) {
                const p = state.passengers.find(x => x.id === this.editingId) || { name: "", weight: 80, gender: "n/a", phone: "" };
                c.innerHTML = `<h3 class="text-xl font-bold mb-4">Passagier Details</h3><div class="space-y-4"><div><label>Vollst√§ndiger Name</label><input type="text" id="f-name" value="${p.name}"></div><div class="grid grid-cols-2 gap-4"><div><label>Gewicht (kg)</label><input type="number" id="f-p-weight" value="${p.weight}"></div><div><label>Geschlecht</label><select id="f-gender"><option value="n/a" ${p.gender==='n/a'?'selected':''}>n/a</option><option value="m" ${p.gender==='m'?'selected':''}>M√§nnlich</option><option value="w" ${p.gender==='w'?'selected':''}>Weiblich</option><option value="d" ${p.gender==='d'?'selected':''}>Divers</option></select></div></div><div><label>Telefonnummer</label><input type="tel" id="f-phone" value="${p.phone}"></div></div><div class="flex gap-2 mt-6"><button onclick="ui.savePassenger()" class="bg-blue-600 px-6 py-2 rounded">Speichern</button><button onclick="ui.switchTab('passengers')" class="bg-slate-700 px-6 py-2 rounded">Abbrechen</button></div>`;
            },
            formLogManual(c) {
                c.innerHTML = `<h3 class="text-xl font-bold mb-4">Manueller Log-Eintrag</h3><div class="space-y-4"><div><label>Datum</label><input type="date" id="f-l-date" value="${new Date().toISOString().split('T')[0]}"></div><div class="grid grid-cols-2 gap-4"><div><label>Startzeit</label><input type="time" id="f-l-start" value="08:00"></div><div><label>Landezeit</label><input type="time" id="f-l-end" value="09:30"></div></div><div><label>Ballon</label><select id="f-l-balloon">${state.balloons.map(b=>`<option>${b.callsign}</option>`).join('')}</select></div><div><label>Notizen / Ort</label><textarea id="f-l-notes" rows="3"></textarea></div></div><div class="flex gap-2 mt-6"><button onclick="ui.saveLogManual()" class="bg-blue-600 px-6 py-2 rounded">Speichern</button><button onclick="ui.switchTab('logbook')" class="bg-slate-700 px-6 py-2 rounded">Abbrechen</button></div>`;
            },

            // --- SAVING & LOGIC ---
            addEditCylinder() { const sel = document.getElementById('edit-cyl-select'); const id = sel.value; if (!id) return; const list = document.getElementById('edit-cyl-list'); if (list.querySelector(`[data-id="${id}"]`)) return; if(list.innerHTML.includes('Keine Standard')) list.innerHTML = ''; const cyl = state.cylinders.find(c => c.id === id); const div = document.createElement('div'); div.className = "flex justify-between items-center bg-slate-800 p-2 rounded mb-1 text-xs default-cyl-item"; div.setAttribute('data-id', id); div.innerHTML = `<span>${cyl.label} (${cyl.type})</span> <button onclick="ui.removeEditCylinder(this)" class="text-red-400 hover:text-red-300"><i class="fas fa-times"></i></button>`; list.appendChild(div); },
            removeEditCylinder(btn) { btn.parentElement.remove(); },
            addPlanCylinder(idOverride) { const sel = document.getElementById('plan-cyl-add-select'); const id = idOverride || sel.value; if (!id) return; const list = document.getElementById('plan-cyl-list'); if (list.querySelector(`[data-pid="${id}"]`)) return; if(list.innerHTML.includes('Keine Flaschen')) list.innerHTML = ''; const cyl = state.cylinders.find(c => c.id === id); const div = document.createElement('div'); div.className = "flex justify-between items-center bg-slate-800 p-2 rounded mb-1 text-xs plan-cyl-item"; div.setAttribute('data-pid', id); div.innerHTML = `<div><div class="font-bold">${cyl.label}</div><div class="text-slate-400 text-[10px]">Total: ${cyl.gas+cyl.tare}kg</div></div><button onclick="ui.removePlanCylinder(this)" class="text-red-400 hover:text-red-300 px-2"><i class="fas fa-trash-alt"></i></button>`; list.appendChild(div); if (!idOverride) this.recalcWB(); },
            removePlanCylinder(btn) { btn.parentElement.remove(); this.recalcWB(); },

            saveBalloon() {
                const matrix = [[],[],[],[]];
                document.querySelectorAll('.matrix-input').forEach(el => { matrix[el.dataset.row][el.dataset.col] = parseFloat(el.value); });
                const defaultCylinders = [];
                document.querySelectorAll('.default-cyl-item').forEach(el => { defaultCylinders.push(el.dataset.id); });
                
                // Image handling
                const imgPreview = document.getElementById('preview-balloon-img');
                let image = null;
                // Only save image data if src contains data (base64) or if it's already there and not hidden
                if (!imgPreview.classList.contains('hidden') && imgPreview.src.length > 100) {
                    image = imgPreview.src;
                }

                const data = { 
                    id: this.editingId === 'new' ? Date.now().toString() : this.editingId, 
                    callsign: document.getElementById('f-callsign').value, 
                    volume: parseFloat(document.getElementById('f-volume').value), 
                    weight: parseFloat(document.getElementById('f-weight').value), 
                    mtom: parseFloat(document.getElementById('f-mtom').value), 
                    matrix: matrix, 
                    defaultCylinders: defaultCylinders,
                    image: image
                };
                if (this.editingId === 'new') state.balloons.push(data); else state.balloons = state.balloons.map(x => x.id === this.editingId ? data : x);
                saveState(); this.switchTab('fleet');
            },
            saveCylinder() { const data = { id: this.editingId === 'new' ? Date.now().toString() : this.editingId, label: document.getElementById('f-label').value, type: document.getElementById('f-type').value, sn: document.getElementById('f-sn').value, tare: parseFloat(document.getElementById('f-tare').value), gas: parseFloat(document.getElementById('f-gas').value), tuv: document.getElementById('f-tuv').value }; if (this.editingId === 'new') state.cylinders.push(data); else state.cylinders = state.cylinders.map(x => x.id === this.editingId ? data : x); saveState(); this.switchTab('cylinders'); },
            savePassenger() { const data = { id: this.editingId === 'new' ? Date.now().toString() : this.editingId, name: document.getElementById('f-name').value, weight: parseFloat(document.getElementById('f-p-weight').value), gender: document.getElementById('f-gender').value, phone: document.getElementById('f-phone').value }; if (this.editingId === 'new') state.passengers.push(data); else state.passengers = state.passengers.map(x => x.id === this.editingId ? data : x); saveState(); this.switchTab('passengers'); },
            saveLogManual() { const date = document.getElementById('f-l-date').value; state.logs.push({ id: Date.now(), start: date + "T" + document.getElementById('f-l-start').value, end: date + "T" + document.getElementById('f-l-end').value, balloon: document.getElementById('f-l-balloon').value, notes: document.getElementById('f-l-notes').value, track: [] }); saveState(); this.switchTab('logbook'); },
            delete(collection, id) { 
                if (confirm("L√∂schen?")) { 
                    // Handle numbers/strings mixing in ids
                    state[collection] = state[collection].filter(x => x.id != id); 
                    saveState(); 
                    this.render(); 
                } 
            },

            // --- PLANNING LOGIC ---
            setPlanView(mode) {
                this.planningMode = mode;
                this.render();
            },

            archivePlan(id) {
                const planIdx = state.plannings.findIndex(p => p.id == id);
                if (planIdx > -1) {
                    const plan = state.plannings.splice(planIdx, 1)[0];
                    state.archive.push(plan);
                    saveState();
                    this.render();
                }
            },

            unarchivePlan(id) {
                const planIdx = state.archive.findIndex(p => p.id == id);
                if (planIdx > -1) {
                    const plan = state.archive.splice(planIdx, 1)[0];
                    state.plannings.push(plan);
                    saveState();
                    this.render();
                }
            },

            savePlan() {
                const name = document.getElementById('plan-name').value || `Planung ${new Date().toLocaleDateString()}`;
                const balloonId = document.getElementById('plan-balloon').value;
                const temp = parseFloat(document.getElementById('plan-temp').value);
                const alt = parseFloat(document.getElementById('plan-alt').value);
                
                if(!balloonId) { alert("Bitte Ballon ausw√§hlen!"); return; }

                // Get selected cylinders from the DOM list
                const cylIds = [];
                document.querySelectorAll('.plan-cyl-item').forEach(el => cylIds.push(el.dataset.pid));

                // Get selected passengers
                const paxIds = Array.from(document.querySelectorAll('#plan-pax input:checked')).map(cb => cb.value);

                const balloon = state.balloons.find(b => b.id === balloonId);

                const planData = {
                    id: this.editingPlanId || Date.now(), // Use existing ID or create new
                    name: name,
                    date: new Date().toLocaleDateString(),
                    balloonId: balloonId,
                    balloonName: balloon ? balloon.callsign : 'Unbekannt',
                    cylinders: cylIds,
                    passengers: paxIds,
                    temp: temp,
                    alt: alt
                };

                if (this.editingPlanId) {
                    // Update existing plan
                    const index = state.plannings.findIndex(p => p.id == this.editingPlanId);
                    if (index !== -1) {
                        state.plannings[index] = planData;
                    } else {
                        // Edge case: if editing an archived plan directly (should not happen with current logic, but safe fallback)
                        state.plannings.push(planData);
                    }
                } else {
                    // Create new plan
                    state.plannings.push(planData);
                }

                saveState();
                this.editingPlanId = null; // Reset after save
                
                // Force switch to active view to see the saved plan
                this.planningMode = 'active';
                this.render(); 
            },

            loadPlan(id) {
                const plan = state.plannings.find(p => p.id == id);
                if(!plan) return;
                this._fillPlanForm(plan);
                this.editingPlanId = plan.id; // Set edit mode (Update)
                
                const btn = document.getElementById('btn-save-plan');
                if(btn) { btn.innerHTML = '<i class="fas fa-pen"></i> √Ñnderung Speichern'; btn.className = btn.className.replace('bg-green-600', 'bg-blue-600'); }
            },

            loadTemplate(id) {
                const plan = state.archive.find(p => p.id == id);
                if(!plan) return;
                this._fillPlanForm(plan);
                this.editingPlanId = null; // New Mode (Create copy)
                
                // Pre-fill name with "Kopie von..." to indicate template usage
                document.getElementById('plan-name').value = `${plan.name} (Kopie)`;
                
                const btn = document.getElementById('btn-save-plan');
                if(btn) { btn.innerHTML = '<i class="fas fa-save"></i> Als neue Planung Speichern'; btn.className = btn.className.replace('bg-blue-600', 'bg-green-600'); }
            },

            _fillPlanForm(plan) {
                // Set Balloon
                document.getElementById('plan-balloon').value = plan.balloonId;
                document.getElementById('plan-name').value = plan.name;
                document.getElementById('plan-temp').value = plan.temp;
                document.getElementById('plan-alt').value = plan.alt;

                // Clear current cylinders list visual
                const list = document.getElementById('plan-cyl-list');
                list.innerHTML = '';
                
                // Add cylinders from plan
                if (plan.cylinders && plan.cylinders.length > 0) {
                    plan.cylinders.forEach(cylId => this.addPlanCylinder(cylId));
                } else {
                    list.innerHTML = '<div class="text-xs text-slate-500 italic">Keine Flaschen ausgew√§hlt</div>';
                }

                // Check passengers
                document.querySelectorAll('#plan-pax input').forEach(cb => {
                    cb.checked = plan.passengers.includes(cb.value);
                });

                this.recalcWB();
            },

            clearPlanForm() {
                this.editingPlanId = null; // Reset to new mode

                // Reset to default empty state
                document.getElementById('plan-balloon').value = "";
                document.getElementById('plan-name').value = "";
                document.getElementById('plan-temp').value = "15";
                document.getElementById('plan-alt').value = "1000";
                
                document.getElementById('plan-cyl-list').innerHTML = '<div class="text-xs text-slate-500 italic">Keine Flaschen ausgew√§hlt</div>';
                document.querySelectorAll('#plan-pax input').forEach(cb => cb.checked = false);
                document.getElementById('wb-result').innerHTML = '<div class="text-slate-500 italic">Bitte Ballon und Zuladung w√§hlen...</div>';

                // Reset Button Text
                const btn = document.getElementById('btn-save-plan');
                if(btn) { btn.innerHTML = '<i class="fas fa-save"></i> Planung Speichern'; btn.className = btn.className.replace('bg-blue-600', 'bg-green-600'); }
            },

            saveSettings() {
                state.pilot.name = document.getElementById('set-pilot-name').value;
                state.pilot.weight = parseFloat(document.getElementById('set-pilot-weight').value);
                
                // New Settings
                state.settings.apiKey = document.getElementById('set-api-key').value;
                state.settings.unitAlt = document.getElementById('set-unit-alt').value;
                state.settings.unitSpeed = document.getElementById('set-unit-speed').value;
                state.settings.unitVario = document.getElementById('set-unit-vario').value;
                
                state.settings.trackColor = document.getElementById('set-track-color').value;
                state.settings.trackWidth = parseInt(document.getElementById('set-track-width').value);
                state.settings.mapStyle = document.getElementById('set-map-style').value;
                
                // Active Balloon
                state.settings.activeBalloonId = document.getElementById('set-active-balloon').value || null;

                // Read from Toggle
                const modeToggle = document.getElementById('set-mode-toggle');
                state.settings.mode = modeToggle.checked ? 'gps' : 'sim';
                
                saveState();
                
                // Apply changes immediately
                mapManager.updateTrackStyle();
                mapManager.setLayer(state.settings.mapStyle);
                mapManager.updateIcon(); // Update map marker based on active balloon image
                simulation.applyMode();
                this.renderWind();
                
                alert("Einstellungen gespeichert!");
            },
            
            // --- WIND ENVIRONMENT EDITING ---
            addWindLayer() {
                const container = document.getElementById('wind-rows');
                const div = document.createElement('div');
                div.className = "grid grid-cols-4 gap-2 items-center";
                div.innerHTML = `
                    <input type="number" class="wind-edit-alt" value="0" placeholder="H√∂he">
                    <input type="number" class="wind-edit-dir" value="0" placeholder="Dir">
                    <input type="number" class="wind-edit-spd" value="0" placeholder="Knots">
                    <button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                `;
                container.appendChild(div);
            },
            
            removeWindLayer(idx) {
                state.windLayers.splice(idx, 1);
                this.render(); // Re-render environment tab
            },
            
            saveEnvironment() {
                const newLayers = [];
                const rows = document.querySelectorAll('#wind-rows > div');
                rows.forEach(row => {
                    const alt = parseFloat(row.querySelector('.wind-edit-alt').value);
                    const dir = parseFloat(row.querySelector('.wind-edit-dir').value);
                    const spd = parseFloat(row.querySelector('.wind-edit-spd').value);
                    if (!isNaN(alt)) {
                        newLayers.push({ alt, dir, speed: spd });
                    }
                });
                state.windLayers = newLayers;
                saveState();
                this.renderWind(); // Update sidebar
                alert("Wetterdaten gespeichert!");
            },

            selectBalloon() {
                const bId = document.getElementById('plan-balloon').value;
                const list = document.getElementById('plan-cyl-list');
                list.innerHTML = '';
                if (!bId) { list.innerHTML = '<div class="text-xs text-slate-500 italic">Keine Flaschen ausgew√§hlt</div>'; return; }
                const b = state.balloons.find(x => x.id === bId);
                if (b.defaultCylinders && b.defaultCylinders.length > 0) { b.defaultCylinders.forEach(id => { this.addPlanCylinder(id); }); } else { list.innerHTML = '<div class="text-xs text-slate-500 italic">Keine Standard-Flaschen definiert</div>'; }
                this.recalcWB();
            },

            recalcWB() {
                const bId = document.getElementById('plan-balloon').value;
                if (!bId) return;
                const b = state.balloons.find(x => x.id === bId);
                const temp = parseFloat(document.getElementById('plan-temp').value);
                const alt = parseFloat(document.getElementById('plan-alt').value);
                
                const selectedCylIds = [];
                document.querySelectorAll('.plan-cyl-item').forEach(el => selectedCylIds.push(el.dataset.pid));
                const selectedCyls = selectedCylIds.map(id => state.cylinders.find(c => c.id === id)).filter(Boolean);
                const selectedPax = Array.from(document.querySelectorAll('#plan-pax input:checked')).map(i => state.passengers.find(p => p.id === i.value));
                
                const totalCylWeight = selectedCyls.reduce((sum, c) => sum + c.tare + c.gas, 0);
                const totalPaxWeight = selectedPax.reduce((sum, p) => sum + p.weight, 0);
                const totalWeight = b.weight + state.pilot.weight + totalCylWeight + totalPaxWeight;

                // Bilinear Interpolation
                const altSteps = [0, 1000, 2000, 3000];
                const tempSteps = [0, 15, 30];
                const cAlt = Math.max(0, Math.min(3000, alt));
                const cTemp = Math.max(0, Math.min(30, temp));
                let i = 0; while (i < altSteps.length - 2 && cAlt > altSteps[i+1]) i++;
                let j = 0; while (j < tempSteps.length - 2 && cTemp > tempSteps[j+1]) j++;
                const rAlt = (cAlt - altSteps[i]) / (altSteps[i+1] - altSteps[i]);
                const rTemp = (cTemp - tempSteps[j]) / (tempSteps[j+1] - tempSteps[j]);
                const q11 = b.matrix[i][j]; const q12 = b.matrix[i][j+1]; const q21 = b.matrix[i+1][j]; const q22 = b.matrix[i+1][j+1];
                const r1 = q11 + (q12 - q11) * rTemp; const r2 = q21 + (q22 - q21) * rTemp;
                const liftFactor = r1 + (r2 - r1) * rAlt;
                const maxLift = b.volume * liftFactor;

                const res = document.getElementById('wb-result');
                const isOverMTOM = totalWeight > b.mtom;
                const isOverLift = totalWeight > maxLift;

                res.innerHTML = `
                    <div class="text-lg font-bold mb-4">Analyse f√ºr ${b.callsign}</div>
                    <div class="space-y-1 text-sm text-left max-w-xs mx-auto mb-4">
                        <div class="flex justify-between"><span>Ballon leer:</span> <span>${b.weight} kg</span></div>
                        <div class="flex justify-between"><span>Pilot:</span> <span>${state.pilot.weight} kg</span></div>
                        <div class="flex justify-between"><span>Passagiere:</span> <span>${totalPaxWeight} kg</span></div>
                        <div class="flex justify-between"><span>Gasflaschen (${selectedCyls.length}):</span> <span>${totalCylWeight} kg</span></div>
                        <hr class="border-white/10 my-1">
                        <div class="flex justify-between font-bold text-lg"><span>Gesamt:</span> <span>${Math.round(totalWeight)} kg</span></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="p-2 rounded ${isOverMTOM ? 'bg-red-900/40 text-red-300 border border-red-500/50' : 'bg-green-900/40 text-green-300 border border-green-500/50'}">MTOM: ${b.mtom}kg<br><b>${isOverMTOM ? '√úBERSCHRITTEN' : 'OK'}</b></div>
                        <div class="p-2 rounded ${isOverLift ? 'bg-red-900/40 text-red-300 border border-red-500/50' : 'bg-green-900/40 text-green-300 border border-green-500/50'}">TRAGKRAFT: ${Math.round(maxLift)}kg<br><b>${isOverLift ? 'ZU SCHWER' : 'OK'}</b></div>
                    </div>
                    <div class="mt-4 text-xs italic text-slate-500">Berechnet f√ºr ${cAlt}m AMSL bei ${cTemp}¬∞C<br>(Tragkraftfaktor: ${liftFactor.toFixed(4)} kg/m¬≥)</div>
                `;
            },
            taufe(name) { const titles = ["Baron von Thermika", "Graf von Wolkenstein", "Ritter der Windstille", "Herzog der sanften Landung", "F√ºrst von Cumulus"]; alert(`Die feierliche Taufe von ${name}:\n\nSie werden hiermit erhoben in den Adelsstand als:\n\n"${titles[Math.floor(Math.random()*titles.length)]}"`); },
            
            renderWind() { 
                const container = document.getElementById('wind-layers-container'); 
                container.innerHTML = ''; 
                
                const isKmh = state.settings.unitSpeed === 'kmh';
                const unitLabel = isKmh ? 'km/h' : 'kt';

                // Combine Forecast and Measured layers
                const allLayers = [...state.windLayers, ...(state.measuredWindLayers || [])];

                allLayers.sort((a,b) => b.alt - a.alt).forEach(layer => { 
                    let speed = layer.speed;
                    if (isKmh) speed *= 1.852; // Convert knots to km/h if needed

                    const isMeasured = layer.isMeasured;
                    const colorClass = isMeasured ? 'text-green-400 font-bold' : 'text-blue-300';
                    const labelClass = isMeasured ? 'text-green-400' : '';
                    
                    // Use new .arrow-green class for measured wind or default blue
                    const arrowClass = isMeasured ? 'compass-arrow arrow-green' : 'compass-arrow';

                    const div = document.createElement('div'); 
                    div.className = 'wind-layer'; 
                    div.innerHTML = `
                        <div class="${colorClass}">${layer.alt}m</div>
                        <div class="${arrowClass}" style="transform: rotate(${layer.dir}deg)"></div>
                        <div class="${labelClass}">${speed.toFixed(1)}${unitLabel}</div>
                    `; 
                    container.appendChild(div); 
                }); 
            },

            capture() { html2canvas(document.body).then(canvas => { const link = document.createElement('a'); link.download = `AeroNav-Screenshot-${Date.now()}.png`; link.href = canvas.toDataURL(); link.click(); }); }
        };

        const system = {
            exportData() { const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'aeronav_backup.json'; a.click(); },
            resetData() { if (confirm("Sicher? Alle Daten werden gel√∂scht!")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
        };

        /**
         * INITIALIZATION
         */
        window.onload = () => {
            mapManager.init();
            simulation.init();
            flightManager.init();
            ui.init();
            // Default setup if empty
            if (state.balloons.length === 0) {
                state.balloons.push({ id: 'def', callsign: 'D-OAAA', volume: 3000, weight: 420, mtom: 1100, defaultCylinders: [], matrix: [[0.320, 0.280, 0.240],[0.280, 0.240, 0.200],[0.240, 0.200, 0.160],[0.200, 0.160, 0.120]], image: null });
                saveState();
            }
        };
    </script>
</body>
</html>
