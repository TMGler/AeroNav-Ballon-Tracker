<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CompNavAir Master - Competition Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Omnivore for KML Support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.4/leaflet-omnivore.min.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #f1f5f9; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        #map-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; cursor: crosshair; background: #e2e8f0; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(0,0,0,0.1); }
        .instrument-box { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); color: white; }
        .nav-director { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-top: 2px solid #3b82f6; }
        
        .tab-content { display: none; height: 100%; overflow-y: auto; padding-bottom: 120px; }
        .tab-content.active { display: block; animation: fadeIn 0.2s ease-out; }
        
        .sim-overlay-btn { backdrop-filter: blur(4px); transition: all 0.1s; touch-action: manipulation; user-select: none; }
        .btn-burner { background: rgba(239, 68, 68, 0.9); border: 2px solid white; color: white; }
        .btn-vent { background: rgba(71, 85, 105, 0.9); border: 2px solid white; color: white; }
        .btn-marker { background: rgba(37, 99, 235, 0.9); border: 2px solid white; color: white; }
        
        .sub-tab-btn { padding-bottom: 6px; color: #64748b; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; border-bottom: 2px solid transparent; }
        .sub-tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; }
        
        .task-completed { opacity: 0.6; background-color: #f1f5f9; }
        .task-completed .task-title { text-decoration: line-through; color: #94a3b8; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .pulse-ring { animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }

        .wind-hud::-webkit-scrollbar { display: none; }
        .wind-hud { -ms-overflow-style: none; scrollbar-width: none; }
        
        .kml-popup-table { font-size: 11px; width: 100%; border-collapse: collapse; margin-top: 5px; background: white; }
        .kml-popup-table td { padding: 4px; border-bottom: 1px solid #e2e8f0; }
        .kml-popup-label { font-weight: bold; color: #64748b; width: 40%; vertical-align: top; text-transform: uppercase; font-size: 9px; }
        .kml-popup-value { color: #1e293b; font-weight: 700; }

        #cockpit { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .cockpit-collapsed { transform: translateY(calc(100% - 24px)); }
        
        #mapSettingsPanel { right: 10px; top: 60px; z-index: 2000; }
        
        input[type="color"] { -webkit-appearance: none; border: none; width: 24px; height: 24px; padding: 0; border-radius: 50%; overflow: hidden; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; }
        
        .wind-grid { display: grid; grid-template-columns: 45px 1fr 55px; align-items: center; }
    </style>
</head>
<body class="bg-slate-200 h-screen w-screen overflow-hidden flex flex-col font-sans text-slate-900">

    <!-- Top Bar -->
    <header class="glass-panel z-20 px-4 py-2 flex justify-between items-center shadow-sm shrink-0 h-14 relative">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white w-8 h-8 rounded flex items-center justify-center font-bold text-xs shadow-md">CNA</div>
            <div>
                <h1 class="font-bold text-sm leading-tight text-slate-800">CompNavAir <span class="text-xs text-blue-500 font-normal">PRO</span></h1>
                <div class="flex items-center gap-2 text-[10px]">
                    <span id="gpsStatus" class="text-slate-500 font-mono">Bereit</span>
                    <span id="simIndicator" class="hidden font-bold text-purple-600 bg-purple-100 px-1 rounded uppercase">Sim</span>
                    <button id="briefingIndicator" onclick="deactivateBriefing()" class="hidden font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded animate-pulse border border-blue-200 uppercase">
                        WETTKAMPF AKTIV <i class="fa-solid fa-xmark ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleWindHud()" class="bg-white text-slate-600 p-2 rounded-lg shadow border border-slate-200 active:bg-slate-50" title="Wind HUD">
                <i class="fa-solid fa-wind"></i>
            </button>
            <button onclick="toggleMapSettings()" class="bg-white text-slate-600 p-2 rounded-lg shadow border border-slate-200 active:bg-slate-50" title="Karten">
                <i class="fa-solid fa-layer-group"></i>
            </button>
            <button onclick="centerMap(true)" class="bg-white text-blue-600 p-2 rounded-lg shadow border border-slate-200" title="Zentrieren"><i class="fa-solid fa-location-crosshairs"></i></button>
            <button onclick="toggleMenu()" class="bg-white text-slate-700 p-2 rounded-lg shadow border border-slate-200 relative">
                <i class="fa-solid fa-bars"></i>
                <span id="taskBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center border border-white">0</span>
            </button>
        </div>
    </header>

    <!-- Map & HUD Container -->
    <div class="relative flex-grow w-full h-full overflow-hidden bg-slate-300">
        <div id="map-container"></div>
        
        <!-- WIND HUD -->
        <div id="windHud" class="absolute top-4 left-4 z-[400] bg-slate-900/90 backdrop-blur text-white rounded-lg border border-white/20 w-48 shadow-xl flex flex-col max-h-[40vh]">
            <div class="p-2 border-b border-white/20 flex justify-between items-center text-slate-400">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold uppercase tracking-wider">WINDPROFIL</span>
                </div>
                <div class="flex gap-2 items-center">
                     <span id="windHudCount" class="text-[9px] font-mono">0</span>
                     <button onclick="fetchOnlineWind()" class="text-blue-400 hover:text-white transition-colors" title="Live Wind laden"><i class="fa-solid fa-cloud-arrow-down"></i></button>
                </div>
            </div>
            
            <div class="wind-grid px-2 py-1 text-[8px] font-bold text-slate-500 bg-slate-950/30 border-b border-white/5">
                <div>HÖHE</div>
                <div class="text-center">RICHT</div>
                <div class="text-right">SPD</div>
            </div>

            <div id="windHudContent" class="overflow-y-auto wind-hud space-y-[1px] p-1 text-[10px] font-mono">
                <div class="text-center text-slate-500 italic py-2">Keine Daten</div>
            </div>
        </div>

        <!-- MAP SETTINGS POPUP -->
        <div id="mapSettingsPanel" class="hidden absolute z-[1100] top-16 right-4 bg-white rounded-lg shadow-xl border border-slate-200 w-64 p-3 flex flex-col gap-3">
            <div class="flex justify-between items-center border-b pb-2">
                <h3 class="text-xs font-bold text-slate-700 uppercase">Karten & Ansicht</h3>
                <button onclick="toggleMapSettings()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-500 mb-1">Basiskarte</label>
                <div class="flex bg-slate-100 p-1 rounded">
                    <button onclick="setMapStyle('osm')" id="btnStyleOsm" class="flex-1 text-[10px] py-1 rounded bg-white shadow-sm font-bold text-blue-600">Karte</button>
                    <button onclick="setMapStyle('sat')" id="btnStyleSat" class="flex-1 text-[10px] py-1 rounded text-slate-500">Satellit</button>
                </div>
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-500 mb-1">Vorausschau</label>
                <div class="grid grid-cols-4 gap-1">
                    <button onclick="setTrajectory(0)" id="traj0" class="text-[9px] py-1 rounded bg-slate-100 border hover:bg-slate-200">Aus</button>
                    <button onclick="setTrajectory(5)" id="traj5" class="text-[9px] py-1 rounded bg-blue-600 text-white border border-blue-600 font-bold">5'</button>
                    <button onclick="setTrajectory(10)" id="traj10" class="text-[9px] py-1 rounded bg-slate-100 border hover:bg-slate-200">10'</button>
                    <button onclick="setTrajectory(15)" id="traj15" class="text-[9px] py-1 rounded bg-slate-100 border hover:bg-slate-200">15'</button>
                </div>
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-500 mb-1">KML Overlays</label>
                <div id="quickKmlList" class="space-y-1 max-h-32 overflow-y-auto">
                    <div class="text-[9px] italic text-slate-400">Keine KMLs geladen</div>
                </div>
            </div>
        </div>

        <!-- Waypoint Overlay -->
        <div id="navOverlay" class="absolute top-4 left-40 right-4 bg-white/95 backdrop-blur p-3 rounded-xl shadow-lg z-[500] hidden border-l-4 border-blue-600 flex justify-between items-center">
            <div>
                <div class="text-[9px] text-slate-400 uppercase font-bold" id="overlayTaskType">Aufgabe</div>
                <div class="text-slate-800 font-bold text-base leading-none" id="overlayWpName">Kein Ziel</div>
            </div>
            <div class="text-right">
                <div class="text-[9px] text-slate-400 uppercase font-bold">Abstand</div>
                <div class="text-blue-600 font-mono text-lg font-bold" id="overlayDist">--- m</div>
            </div>
        </div>

        <!-- SIM CONTROLS (Floating) -->
        <div id="simOverlayControls" class="hidden absolute left-4 top-1/2 -translate-y-1/2 flex flex-col gap-4 z-[2000]">
            <button onmousedown="startBurn()" onmouseup="stopBurn()" ontouchstart="startBurn()" ontouchend="stopBurn()" class="sim-overlay-btn btn-burner w-16 h-24 rounded-2xl flex flex-col items-center shadow-xl">
                <i class="fa-solid fa-fire text-2xl mt-4"></i><span class="text-[9px] font-bold mt-1 uppercase">Auf</span>
            </button>
            <button onclick="dropMarker()" class="sim-overlay-btn btn-marker w-16 h-16 rounded-full flex flex-col items-center justify-center shadow-xl border-2 border-white">
                <i class="fa-solid fa-location-dot text-xl"></i><span class="text-[8px] font-bold uppercase">Mark</span>
            </button>
            <button onmousedown="startVent()" onmouseup="stopVent()" ontouchstart="startVent()" ontouchend="stopVent()" class="sim-overlay-btn btn-vent w-16 h-20 rounded-2xl flex flex-col items-center shadow-xl">
                <i class="fa-solid fa-arrow-down text-xl mt-3"></i><span class="text-[9px] font-bold mt-1 uppercase">Ab</span>
            </button>
        </div>
    </div>

    <!-- COCKPIT HUD -->
    <div id="cockpit" class="z-[1000] bg-slate-900 shadow-2xl shrink-0 flex flex-col relative">
        <!-- Toggle Handle -->
        <button id="cockpit-toggle-btn" onclick="toggleCockpit()" class="absolute -top-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white w-16 h-6 rounded-t-xl flex items-center justify-center shadow-lg border-t border-x border-white/10 active:bg-slate-800 transition-colors cursor-pointer z-50">
            <i id="cockpitChevron" class="fa-solid fa-chevron-down text-xs transition-transform duration-300"></i>
        </button>

        <div id="cockpitContent" class="p-2 pt-3 pb-6 flex flex-col gap-1 transition-opacity duration-300">
            <div class="nav-director rounded-lg p-2 flex items-center justify-between shadow-inner relative overflow-hidden bg-slate-800/50">
                <div id="devIndicatorBg" class="absolute inset-0 opacity-10 pointer-events-none"></div>
                <div class="z-10 text-center w-1/4">
                    <div class="text-[8px] text-slate-400 uppercase">Soll (Brg)</div>
                    <div class="text-lg font-bold text-blue-400 font-mono" id="valBrg">---</div>
                </div>
                <div class="z-10 flex-1 text-center mx-2">
                    <div class="text-sm font-bold text-white transition-all duration-300" id="navInstruction">Warte...</div>
                    <div class="text-[9px] text-slate-400 font-mono" id="navDevValue">Abweichung: 0°</div>
                </div>
                <div class="z-10 text-center w-1/4">
                    <div class="text-[8px] text-slate-400 uppercase">Ist (Trk)</div>
                    <div class="text-lg font-bold text-green-400 font-mono" id="valTrack">---</div>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-1">
                <div class="instrument-box rounded p-1 text-center">
                    <div class="text-[8px] text-slate-400 uppercase">GS km/h</div>
                    <div class="text-base font-bold text-green-400 font-mono" id="valSpeed">0</div>
                </div>
                <div class="instrument-box rounded p-1 text-center">
                    <div class="text-[8px] text-slate-400 uppercase">ALT m</div>
                    <div class="text-base font-bold text-orange-400 font-mono" id="valAlt">0</div>
                </div>
                <div class="instrument-box rounded p-1 text-center">
                    <div class="text-[8px] text-slate-400 uppercase">VARIO m/s</div>
                    <div class="text-base font-bold text-white font-mono" id="valVario">0.0</div>
                </div>
                <button onclick="completeCurrentTask()" class="bg-blue-600 text-white rounded p-1 flex flex-col items-center justify-center active:scale-95 shadow border border-blue-500 transition-colors">
                    <i class="fa-solid fa-check mr-1"></i><span class="text-[8px] font-bold uppercase">Task Beenden</span>
                </button>
            </div>
            <div id="timeInfoBar" class="text-sm font-bold text-center text-slate-400 font-mono hidden bg-slate-800/80 p-2 rounded mt-1 border border-slate-700"></div>
        </div>
    </div>

    <!-- SIDE MENU -->
    <div id="sideMenu" class="absolute inset-y-0 right-0 w-80 max-w-[90vw] bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-[2000] flex flex-col">
        <div class="p-4 bg-slate-100 border-b flex justify-between items-center shrink-0">
            <h2 class="font-bold text-slate-700">Flug Management</h2>
            <button onclick="toggleMenu()" class="text-slate-400 p-1"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <div class="flex border-b border-slate-200 text-[10px] font-bold uppercase shrink-0">
            <button onclick="switchTab('tab-task')" id="btn-tab-task" class="flex-1 py-3 text-blue-600 border-b-2 border-blue-600 bg-blue-50">Wettkampf</button>
            <button onclick="switchTab('tab-wind')" id="btn-tab-wind" class="flex-1 py-3 text-slate-500">Wind</button>
            <button onclick="switchTab('tab-setup')" id="btn-tab-setup" class="flex-1 py-3 text-slate-500">Setup</button>
            <button onclick="switchTab('tab-archive')" id="btn-tab-archive" class="flex-1 py-3 text-slate-500">Archiv</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 bg-slate-50 space-y-4">
            <!-- TAB: WETTKAMPF -->
            <div id="tab-task" class="tab-content active space-y-4">
                <div class="flex gap-4 border-b border-slate-200 pb-2 mb-2">
                    <button onclick="switchSubTab('live')" id="sub-live" class="sub-tab-btn active">Live Modus</button>
                    <button onclick="switchSubTab('plan')" id="sub-plan" class="sub-tab-btn">Briefing</button>
                </div>
                
                <div id="view-live" class="space-y-4">
                    <button onclick="toggleFlight()" id="btnFlightToggle" class="w-full py-4 rounded-xl font-black text-lg text-white bg-green-500 hover:bg-green-600 shadow-lg flex flex-col items-center justify-center gap-1 pulse-ring">
                        <span>START</span>
                    </button>
                    
                    <!-- NEW QUICK SIM TOGGLE -->
                    <div class="flex justify-center -mt-2">
                         <button onclick="toggleSimulation()" id="btnQuickSim" class="text-[10px] text-slate-400 underline hover:text-slate-700 transition-colors">
                             Simulation aktivieren
                         </button>
                    </div>

                    <div id="liveFormCard" class="bg-white p-3 rounded shadow-sm border border-slate-200">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-2 text-center">Aufgabe hinzufügen (Live)</h3>
                        <input type="text" id="inpTitle" placeholder="Titel / Nummer (z.B. Task 1)" class="w-full p-2 border rounded text-xs font-bold mb-1 bg-slate-50">
                        <div class="mb-2 flex flex-col gap-2">
                            <div class="flex gap-2">
                                <select id="taskType" onchange="updateTaskInputs();updateLiveMarkerConfig();" class="flex-1 p-2 border rounded text-xs font-bold">
                                    <option value="JDG">15.2 Vorgegebenes Ziel (JDG)</option>
                                    <option value="PDG">15.1 Selbst gewähltes Ziel (PDG)</option>
                                    <option value="HWZ">15.3 Qual der Wahl (HWZ)</option>
                                    <option value="FIN">15.4 Fly In (FIN)</option>
                                    <option value="FON">15.5 Fly On (FON)</option>
                                    <option value="HNH">15.6 Fuchsjagd (HNH)</option>
                                    <option value="WSD">15.7 Fuchsjagd mit Anlauf (WSD)</option>
                                    <option value="GBM">15.8 Gordon Bennett Memorial (GBM)</option>
                                    <option value="CRT">15.9 Zielfahrt mit Zeitfenster (CRT)</option>
                                    <option value="RTA">15.10 Rennen zum Wertungsgebiet (RTA)</option>
                                    <option value="ELB">15.11 Ellenbogen (ELB)</option>
                                    <option value="LRN">15.12 Dreiecksfläche (LRN)</option>
                                    <option value="MDT">15.13 Min. Distanz Zeit (MDT)</option>
                                    <option value="SFL">15.14 Min. Distanz Gebiet (SFL)</option>
                                    <option value="MDD">15.15 Min. Distanz 2 Marker (MDD)</option>
                                    <option value="XDT">15.16 Max. Distanz Zeit (XDT)</option>
                                    <option value="XDI">15.17 Max. Distanz Gebiet (XDI)</option>
                                    <option value="XDD">15.18 Max. Distanz 2 Marker (XDD)</option>
                                    <option value="ANG">15.19 Winkel (ANG)</option>
                                    <option value="3DT">15.20 3D-Aufgabe (3DT)</option>
                                    <option value="APT">15.21 Höhenprofil Aufgabe (APT)</option>
                                </select>
                                <button onclick="showTaskInfo()" class="text-blue-500 p-2"><i class="fa-solid fa-circle-info text-lg"></i></button>
                            </div>
                            
                            <!-- Dynamic Marker Configuration Live -->
                            <div id="liveMarkerConfigContainer" class="flex flex-col gap-1"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input type="number" id="inpLat" placeholder="Lat" class="p-2 border rounded text-xs font-mono" step="0.0001">
                            <input type="number" id="inpLon" placeholder="Lon" class="p-2 border rounded text-xs font-mono" step="0.0001">
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="inpRadius" placeholder="R1 (m)" class="flex-1 p-2 border rounded text-xs" value="100">
                            <input type="number" id="inpRadius2" placeholder="R2 (m)" class="hidden flex-1 p-2 border rounded text-xs font-mono">
                            <button onclick="useCurrentPosAsGoal()" class="bg-slate-100 p-2 rounded border text-xs" title="Hier"><i class="fa-solid fa-crosshairs"></i></button>
                        </div>
                        <div id="extraInputs" class="hidden mb-2">
                            <input type="number" id="inpDirection" placeholder="Richtung (°)" class="w-full p-2 border rounded text-xs">
                        </div>
                        <div id="altInputs" class="hidden mb-2">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="inpAltMin" placeholder="Min Höhe (ft)" class="p-2 border rounded text-xs">
                                <input type="number" id="inpAltMax" placeholder="Max Höhe (ft)" class="p-2 border rounded text-xs">
                            </div>
                        </div>

                        <button onclick="addTask()" class="w-full bg-blue-600 text-white py-2 rounded font-bold text-xs">HINZUFÜGEN</button>
                    </div>

                    <div id="liveTaskCard" class="hidden bg-blue-50 p-4 rounded-xl border border-blue-200 shadow-md text-center">
                        <div class="flex justify-between items-center mb-2">
                            <button onclick="showActiveTaskInfo()" class="text-blue-500 font-bold text-[10px] uppercase"><i class="fa-solid fa-circle-info"></i> Info</button>
                            <button onclick="openLiveAddModal()" class="text-[10px] bg-white text-blue-600 px-2 py-1 rounded shadow-sm font-bold border border-blue-100">+ TASK</button>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-black text-slate-800" id="liveTaskType">---</div>
                            <div class="text-sm font-bold text-slate-500 mb-1" id="liveTaskName">Keine Aufgabe</div>
                            
                            <!-- Marker Color & Count Display -->
                            <div class="flex justify-center items-center gap-2 mb-1">
                                <div id="liveTaskMarkerInfo" class="flex gap-1 hidden"></div>
                                <div id="liveTaskMarkerCount" class="text-[10px] font-bold text-white bg-blue-500 px-2 py-0.5 rounded-full shadow-sm hidden">0 / 0</div>
                            </div>

                            <div class="text-[10px] font-mono text-slate-400" id="liveTaskCoords"></div>
                            <div id="liveTaskTimeStatus" class="mt-2 text-[10px] font-bold px-2 py-0.5 rounded-full inline-block bg-slate-200 text-slate-500 hidden"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-3 text-center">
                            <div class="bg-white rounded p-1"><div class="text-[8px] text-slate-400 uppercase">Distanz</div><div class="text-base font-bold text-blue-600 font-mono" id="liveTaskDist">---</div></div>
                            <div class="bg-white rounded p-1"><div class="text-[8px] text-slate-400 uppercase">Bearing</div><div class="text-base font-bold text-slate-700 font-mono" id="liveTaskBrg">---</div></div>
                        </div>
                    </div>
                    <ul id="taskList" class="space-y-1"></ul>
                    <div class="bg-white p-3 rounded shadow-sm border border-slate-200">
                        <h3 class="text-xs font-bold text-slate-500 uppercase mb-2 border-b pb-1">Marker & Log</h3>
                        <div class="max-h-32 overflow-y-auto text-[10px] font-mono" id="markerResults">Keine Events.</div>
                    </div>
                </div>
                
                <div id="view-plan" class="space-y-4 hidden">
                    <div id="briefingListContainer">
                        <div id="briefingList" class="space-y-2"></div>
                        <button onclick="editBriefing(-1)" class="w-full bg-slate-700 text-white py-3 rounded font-bold text-xs hover:bg-slate-600 mt-2">+ Neues Briefing</button>
                    </div>
                    
                    <!-- INLINE BRIEFING EDITOR -->
                    <div id="briefingEditor" class="hidden bg-white p-3 rounded border border-slate-300 shadow-md">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-slate-700">Planung bearbeiten</h3>
                            <button onclick="closeBriefingEditor()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="space-y-3">
                            <input type="text" id="brfName" placeholder="Name der Fahrt" class="w-full p-2 border rounded font-bold">
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div><label>Startzeit (Fahrt)</label><input type="time" id="brfStart" class="w-full p-2 border rounded"></div>
                                <div><label>Wertungsschluss (Fahrt)</label><input type="time" id="brfEnd" class="w-full p-2 border rounded"></div>
                            </div>
                            
                            <div class="bg-slate-50 p-2 rounded border">
                                <h4 class="text-xs font-bold text-slate-500 mb-2">Aufgaben</h4>
                                <ul id="brfTaskList" class="space-y-1 mb-2 text-[10px]"></ul>
                                
                                <div class="bg-white p-2 border rounded border-blue-100 space-y-1">
                                    <input type="text" id="brfTaskTitle" placeholder="Titel / Nr." class="w-full text-[10px] p-1 border rounded mb-1 font-bold">
                                    <div class="flex flex-col gap-1">
                                        <div class="flex gap-1">
                                            <select id="brfTaskType" onchange="updateBrfTaskInputs();updateBrfMarkerConfig();" class="text-[10px] p-1 border rounded w-full">
                                                <option value="JDG">JDG</option><option value="HWZ">HWZ</option><option value="FIN">FIN</option><option value="PDG">PDG</option><option value="FON">FON</option><option value="HNH">HNH</option><option value="WSD">WSD</option><option value="GBM">GBM</option><option value="CRT">CRT</option><option value="RTA">RTA</option><option value="ELB">ELB</option><option value="LRN">LRN</option><option value="MDT">MDT</option><option value="SFL">SFL</option><option value="MDD">MDD</option><option value="XDT">XDT</option><option value="XDI">XDI</option><option value="XDD">XDD</option><option value="ANG">ANG</option><option value="3DT">3DT</option><option value="APT">APT</option>
                                            </select>
                                            <button onclick="showTaskInfoFromEditor()" class="text-blue-500 p-1"><i class="fa-solid fa-info-circle"></i></button>
                                        </div>
                                        
                                        <!-- Briefing Color Picker Dynamic -->
                                        <div id="brfMarkerConfigContainer" class="flex flex-col gap-1 mt-1"></div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-1 mb-1 bg-slate-50 p-1 rounded">
                                        <div><label class="text-[8px] block">Von (Task)</label><input type="time" id="brfTaskTimeStart" class="text-[10px] p-1 border rounded w-full"></div>
                                        <div><label class="text-[8px] block">Bis (Task)</label><input type="time" id="brfTaskTimeEnd" class="text-[10px] p-1 border rounded w-full"></div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-1 mb-1">
                                        <input type="text" id="brfTaskLat" placeholder="Lat" class="text-[10px] p-1 border rounded">
                                        <input type="text" id="brfTaskLon" placeholder="Lon" class="text-[10px] p-1 border rounded">
                                    </div>
                                    <div class="grid grid-cols-2 gap-1 mb-1 hidden" id="brfAltInputs">
                                         <input type="number" id="brfTaskAltMin" placeholder="Min Höhe (ft)" class="text-[10px] p-1 border rounded">
                                         <input type="number" id="brfTaskAltMax" placeholder="Max Höhe (ft)" class="text-[10px] p-1 border rounded">
                                    </div>
                                    <div class="grid grid-cols-3 gap-1">
                                        <input type="number" id="brfTaskRad" placeholder="R1" class="text-[10px] p-1 border rounded" value="100">
                                        <input type="number" id="brfTaskRad2" placeholder="R2" class="text-[10px] p-1 border rounded hidden">
                                        <button onclick="addOrUpdateBriefingTask()" id="btnAddBrfTask" class="bg-blue-100 text-blue-700 text-[10px] font-bold rounded hover:bg-blue-200">Add</button>
                                    </div>
                                    <button onclick="cancelTaskEdit()" id="btnCancelBrfTask" class="hidden w-full text-[9px] text-slate-400 mt-1">Abbrechen</button>
                                </div>
                            </div>
                            
                            <div class="bg-slate-50 p-2 rounded border">
                                <h4 class="text-xs font-bold text-slate-500 mb-1">Wetter (Alt,Dir,Spd)</h4>
                                <textarea id="brfWind" rows="3" placeholder="z.B. 100,270,10" class="w-full p-2 border rounded text-[10px] font-mono"></textarea>
                            </div>
                            <button onclick="saveBriefing()" class="w-full bg-green-600 text-white py-3 rounded font-bold shadow mt-2">Speichern</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: WIND -->
            <div id="tab-wind" class="tab-content space-y-4">
                <div class="bg-white rounded border overflow-hidden">
                    <table class="w-full text-left text-[10px]">
                        <thead class="bg-slate-100 text-slate-500"><tr><th class="p-1">H</th><th class="p-1">D</th><th class="p-1">S</th></tr></thead>
                        <tbody id="windTableBody" class="divide-y divide-slate-100 font-mono"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: SETUP -->
            <div id="tab-setup" class="tab-content space-y-4">
                <div class="bg-white p-3 rounded shadow-sm border border-slate-200">
                    <h3 class="text-xs font-bold uppercase mb-3 border-b pb-1 text-slate-400">Karten & KML</h3>
                    <div class="space-y-3">
                        <select id="mapStyle" onchange="changeMapStyle()" class="w-full p-2 border rounded text-xs">
                            <option value="osm">Standard (OSM)</option>
                            <option value="sat">Satellit (Esri)</option>
                        </select>
                        <input type="file" id="kmlFileInput" multiple accept=".kml" onchange="handleKmlUpload()" class="text-[10px] w-full border p-1 rounded bg-slate-50">
                        <div id="kmlList" class="space-y-1 mt-2"></div>
                    </div>
                </div>
                <div class="bg-white p-3 rounded shadow-sm border border-slate-200">
                    <h3 class="text-xs font-bold uppercase mb-3 border-b pb-1 text-slate-400">Aufzeichnung</h3>
                    <div class="space-y-2">
                        <label class="flex justify-between text-[10px] font-bold"><span>Min Distanz</span><span id="lblDist">50m</span></label>
                        <input type="range" id="cfgDist" min="10" max="200" value="50" oninput="updateConfigUI()" class="w-full h-1 bg-slate-200 rounded accent-blue-600">
                        <label class="flex justify-between text-[10px] font-bold mt-2"><span>Kursänderung</span><span id="lblHead">5°</span></label>
                        <input type="range" id="cfgHead" min="1" max="30" value="5" oninput="updateConfigUI()" class="w-full h-1 bg-slate-200 rounded accent-blue-600">
                    </div>
                </div>
                <button onclick="toggleSimulation()" id="btnSimToggle" class="w-full py-4 bg-slate-800 text-white rounded-xl font-bold shadow-lg">Simulation Ein/Aus</button>
            </div>
            
            <div id="tab-archive" class="tab-content space-y-4">
                <div id="flightList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- LIVE ADD MODAL -->
    <div id="liveAddTaskModal" class="hidden fixed inset-0 info-modal-overlay flex items-center justify-center p-4 z-[4000]">
        <div class="bg-white rounded-lg shadow-2xl max-w-sm w-full p-4">
            <h3 class="font-bold text-slate-700 mb-3">Spontane Aufgabe</h3>
            <input type="text" id="modInpTitle" placeholder="Titel / Nr." class="w-full p-2 border rounded text-xs mb-2 font-bold bg-slate-50">
            <select id="modTaskType" onchange="updateModMarkerConfig()" class="w-full p-2 border rounded text-xs mb-2 font-bold">
                 <option value="FON">FON</option><option value="JDG">JDG</option><option value="PDG">PDG</option><option value="FIN">FIN</option>
                 <option value="HWZ">HWZ</option><option value="ELB">ELB</option><option value="LRN">LRN</option><option value="MDD">MDD</option>
                 <option value="XDD">XDD</option><option value="ANG">ANG</option><option value="3DT">3DT</option><option value="APT">APT</option>
            </select>
            
            <div id="modMarkerConfigContainer" class="flex flex-col gap-1 mb-2"></div>

            <div class="grid grid-cols-2 gap-2 mb-2"><input type="number" id="modInpLat" placeholder="Lat" class="p-2 border rounded text-xs font-mono" step="0.0001"><input type="number" id="modInpLon" placeholder="Lon" class="p-2 border rounded text-xs font-mono" step="0.0001"></div>
            <div class="flex gap-2 mb-3"><input type="number" id="modInpRadius" placeholder="MMA (m)" class="flex-1 p-2 border rounded text-xs" value="100"><button onclick="useCurrentPosForModal()" class="bg-slate-100 p-2 rounded border text-xs" title="Hier"><i class="fa-solid fa-crosshairs"></i></button></div>
            <div class="flex gap-2"><button onclick="closeLiveAddModal()" class="flex-1 py-2 text-xs text-slate-500 border rounded">Abbrechen</button><button onclick="addTaskFromModal()" class="flex-1 py-2 text-xs bg-blue-600 text-white rounded font-bold shadow">Hinzufügen</button></div>
        </div>
    </div>

    <!-- TASK INFO MODAL -->
    <div id="taskInfoModal" class="hidden fixed inset-0 info-modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full max-h-[80vh] flex flex-col">
            <div class="p-4 bg-slate-100 border-b flex justify-between items-center"><h3 class="font-bold text-slate-800" id="infoTaskTitle">Regelwerk</h3><button onclick="closeTaskInfo()"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="p-4 overflow-y-auto text-xs text-slate-600 leading-relaxed" id="infoTaskContent"></div>
            <div class="p-3 border-t bg-slate-50 text-right"><button onclick="closeTaskInfo()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold text-xs">OK</button></div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const EDRY_POS = { lat: 49.3015, lng: 8.4485 };
        const TASK_RULES_DATA = {
            "PDG": "<b>15.1 SELBST GEWÄHLTES ZIEL (PDG)</b><br>Die Wettbewerber versuchen, einen Messpunkt möglichst nah an einem vor dem Start selbst gewählten und deklarierten Ziel zu erzeugen.<br><ul><li>Ergebnis: Distanz Messpunkt zu Ziel.</li><li>Kleinstes Ergebnis gewinnt.</li></ul>",
            "JDG": "<b>15.2 VORGEGEBENES ZIEL (JDG)</b><br>Die Wettbewerber versuchen, einen Messpunkt möglichst nah an einem vorgegebenen Ziel zu erzeugen.<br><ul><li>Ergebnis: Distanz Messpunkt zu Ziel.</li><li>Kleinstes Ergebnis gewinnt.</li></ul>",
            "HWZ": "<b>15.3 QUAL DER WAHL (HWZ)</b><br>Die Wettbewerber versuchen, einen Messpunkt möglichst nah an einem von mehreren vorgegebenen Zielen zu erzeugen.<br><ul><li>Ergebnis: Distanz zum nahesten Ziel.</li><li>Kleinstes Ergebnis gewinnt.</li></ul>",
            "FIN": "<b>15.4 FLY IN (FIN)</b><br>Die Wettbewerber suchen ihre eigenen Startplätze und versuchen, einen Messpunkt möglichst nah an einem vorgegebenen Ziel zu erzeugen.<br><ul><li>Nur ein Versuch erlaubt.</li><li>Kleinstes Ergebnis gewinnt.</li></ul>",
            "FON": "<b>15.5 FLY ON (FON)</b><br>Die Wettbewerber versuchen, einen Messpunkt möglichst nah an einem vor dem Start oder während der Fahrt selbst gewählten Ziel zu erzeugen.<br><ul><li>Gültige Deklaration erforderlich.</li><li>Kleinstes Ergebnis gewinnt.</li></ul>",
            "HNH": "<b>15.6 FUCHSJAGD (HNH)</b><br>Die Wettbewerber verfolgen einen Fuchsballon und versuchen, einen Messpunkt möglichst nah am Zielkreuz des Fuchses zu erzeugen.<br><ul><li>Zielkoordinaten nach Landung des Fuchses.</li></ul>",
            "WSD": "<b>15.7 FUCHSJAGD MIT ANLAUF (WSD)</b><br>Ähnlich HNH, aber Start am Startplatz des Fuchses. Markerabwurf in Zielnähe.",
            "GBM": "<b>15.8 GORDON BENNETT MEMORIAL (GBM)</b><br>Marker in Wertungsgebiet möglichst nah am Ziel.<br><ul><li>Ergebnis: Distanz zum Ziel.</li></ul>",
            "CRT": "<b>15.9 ZIELFAHRT MIT ZEITFENSTER (CRT)</b><br>Messpunkt im Wertungsgebiet innerhalb gültiger Periode.<br><ul><li>Zeitfenster strikt beachten!</li></ul>",
            "RTA": "<b>15.10 RENNEN ZUM WERTUNGSGEBIET (RTA)</b><br>Kürzeste Zeit vom Start bis zum Messpunkt im Gebiet.<br><ul><li>Ergebnis: Zeit.</li></ul>",
            "ELB": "<b>15.11 ELLENBOGEN (ELB)</b><br>Größte Richtungsänderung (Winkel ABC).<br><ul><li>Basiert auf 3 Markern.</li><li>180 - Winkel ABC gewinnt.</li></ul>",
            "LRN": "<b>15.12 DREIECKSFLÄCHE (LRN)</b><br>Größtmögliche Fläche eines Dreiecks ABC.<br><ul><li>3 Marker notwendig.</li></ul>",
            "MDT": "<b>15.13 MINIMUM DISTANCE MIT ZEITVORGABE (MDT)</b><br>Messpunkt nach Mindestzeit/-strecke nah am Referenzpunkt.",
            "SFL": "<b>15.14 MINIMUM DISTANCE MIT WERTUNGSGEBIET (SFL)</b><br>Messpunkt innerhalb Gebiet nah am Referenzpunkt.",
            "MDD": "<b>15.15 MINIMUM DISTANCE ZWEI MARKER (MDD)</b><br>Möglichst nah beieinander liegende Marker in unterschiedlichen Gebieten.",
            "XDT": "<b>15.16 MAXIMUM DISTANCE MIT ZEITVORGABE (XDT)</b><br>Messpunkt innerhalb Zeit möglichst weit vom Referenzpunkt.",
            "XDI": "<b>15.17 MAXIMUM DISTANCE MIT WERTUNGSGEBIET (XDI)</b><br>Messpunkt innerhalb Gebiet möglichst weit vom Referenzpunkt.",
            "XDD": "<b>15.18 MAXIMUM DISTANCE ZWEI MARKER (XDD)</b><br>Möglichst weit voneinander entfernte Marker in Gebieten.",
            "ANG": "<b>15.19 WINKEL (ANG)</b><br>Größte Richtungsänderung von einer vorgegebenen Richtung (Linie A-B).",
            "3DT": "<b>15.20 3D-AUFGABE (3DT)</b><br>Größtmögliche Distanz innerhalb eines definierten Luftraumes.",
            "APT": "<b>15.21 HÖHENPROFIL AUFGABE (APT)</b><br>Längste Zeit in definiertem Höhenband. Inneres Band zählt doppelt.<br><ul><li>Start durch Marker.</li><li>Zeit in Sekunden gewinnt.</li></ul>"
        };
        
        // --- GLOBAL STATE ---
        let map, currentMarker, polylineTrack, polylineTask, polylineTrajectory, forecastMarker;
        let tasks = [], activeTaskIdx = -1, savedFlights = [], briefings = [], activeBriefing = null;
        let currentPos = { ...EDRY_POS, alt: 200, head: 0, speed: 0 };
        let windProfile = {}, config = { minDistance: 50, minHeadingChange: 5, lookAhead: 0, forecastMinutes: 5 };
        let isFlightActive = false, currentFlight = { id: null, start: null, track: [], tasksSnapshot: [], markers: [] };
        let kmlLayers = {}, baseLayers = {}, isSimulating = false, simInterval = null;
        let simBurnerActive = false, simVentActive = false, isCockpitCollapsed = false;
        let tempBriefingTasks = [], editingTaskIndex = -1;
        let tempClickMarker = null;

        // --- WAKE LOCK ---
        const wakeLockManager = {
            wakeLock: null,
            async request() {
                if ('wakeLock' in navigator) {
                    try { this.wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
                }
            },
            release() {
                if (this.wakeLock !== null) { this.wakeLock.release().then(() => { this.wakeLock = null; }); }
            }
        };

        // --- MATH HELPERS ---
        function getDistanceM(la1, lo1, la2, lo2) {
            const R = 6371e3, dφ = (la2-la1)*Math.PI/180, dλ = (lo2-lo1)*Math.PI/180;
            const a = Math.sin(dφ/2)**2 + Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dλ/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function getBearing(la1, lo1, la2, lo2) {
            const y = Math.sin((lo2-lo1)*Math.PI/180)*Math.cos(la2*Math.PI/180);
            const x = Math.cos(la1*Math.PI/180)*Math.sin(la2*Math.PI/180)-Math.sin(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.cos((lo2-lo1)*Math.PI/180);
            return (Math.atan2(y, x)*180/Math.PI + 360) % 360;
        }
        function projectPoint(la, lo, d, b) {
            const R = 6371e3, φ = la*Math.PI/180, λ = lo*Math.PI/180, br = b*Math.PI/180;
            const φ2 = Math.asin(Math.sin(φ)*Math.cos(d/R) + Math.cos(φ)*Math.sin(d/R)*Math.cos(br));
            const λ2 = λ + Math.atan2(Math.sin(br)*Math.sin(d/R)*Math.cos(φ), Math.cos(d/R)-Math.sin(φ)*Math.sin(φ2));
            return { lat: φ2*180/Math.PI, lng: λ2*180/Math.PI };
        }

        // --- DYNAMIC MARKER CONFIG ---
        function getMarkerCount(type) {
            if(['LRN', 'ELB'].includes(type)) return 3;
            if(['MDD', 'XDD', 'ANG'].includes(type)) return 2;
            if(['3DT'].includes(type)) return 0;
            return 1;
        }

        function renderMarkerConfig(type, containerId, prefix) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = "";
            const count = getMarkerCount(type);
            if (count === 0) return;

            for (let i = 0; i < count; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = "flex items-center gap-2 justify-between bg-slate-50 p-1 rounded border";
                const label = document.createElement('span'); label.className = "text-[9px] font-bold text-slate-500"; label.innerText = `Marker ${i + 1}`;
                const input = document.createElement('input'); input.type = "color"; input.className = "shadow-sm"; input.id = `${prefix}_color_${i}`; input.value = (i===0) ? "#ff0000" : (i===1 ? "#0000ff" : "#00ff00");
                wrapper.appendChild(label); wrapper.appendChild(input); container.appendChild(wrapper);
            }
        }
        
        function getMarkerColors(count, prefix) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const el = document.getElementById(`${prefix}_color_${i}`);
                colors.push(el ? el.value : "#000000");
            }
            return colors;
        }

        // --- HELPER FUNCTIONS ---
        function updateLiveMarkerConfig() { renderMarkerConfig(document.getElementById('taskType').value, 'liveMarkerConfigContainer', 'live_m'); }
        function updateBrfMarkerConfig() { renderMarkerConfig(document.getElementById('brfTaskType').value, 'brfMarkerConfigContainer', 'brf_m'); }
        function updateModMarkerConfig() { renderMarkerConfig(document.getElementById('modTaskType').value, 'modMarkerConfigContainer', 'mod_m'); }
        
        function updateTaskInputs() { 
            const type = document.getElementById('taskType').value; 
            const extra = document.getElementById('extraInputs'); 
            const inpR2 = document.getElementById('inpRadius2'); 
            const altInp = document.getElementById('altInputs');
            
            if(type === 'ANG') { extra.classList.remove('hidden'); } else { extra.classList.add('hidden'); }
            if(type === '3DT') { inpR2.classList.remove('hidden'); } else { inpR2.classList.add('hidden'); }
            if(type === 'APT') { altInp.classList.remove('hidden'); } else { altInp.classList.add('hidden'); }
            
            updateLiveMarkerConfig();
        }
        
        function updateBrfTaskInputs() { 
            const type = document.getElementById('brfTaskType').value; 
            document.getElementById('brfTaskRad2').classList.toggle('hidden', type!=='3DT'); 
            document.getElementById('brfAltInputs').classList.toggle('hidden', type!=='APT');
            updateBrfMarkerConfig();
        }

        function safeSetText(id, txt) { const el = document.getElementById(id); if(el) el.innerText = txt; }
        function toggleMapSettings() { document.getElementById('mapSettingsPanel').classList.toggle('hidden'); }
        function toggleWindHud() { document.getElementById('windHud').classList.toggle('hidden'); }
        function toggleMenu() { document.getElementById('sideMenu').classList.toggle('translate-x-full'); }

        // --- MAP ---
        function initMap() {
            map = L.map('map-container', { zoomControl: false, attributionControl: false }).setView([EDRY_POS.lat, EDRY_POS.lng], 15);
            baseLayers.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
            baseLayers.sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 18 });
            
            polylineTrack = L.polyline([], { color: '#ef4444', weight: 4, opacity: 0.7 }).addTo(map);
            polylineTask = L.polyline([], { color: '#2563eb', weight: 2, dashArray: '10, 10' }).addTo(map);
            polylineTrajectory = L.polyline([], { color: '#22c55e', weight: 3, dashArray: '5, 5' }).addTo(map);
            
            map.on('click', (e) => {
                const lat = e.latlng.lat.toFixed(5), lon = e.latlng.lng.toFixed(5);
                // Update active inputs
                const activeTab = document.querySelector('.sub-tab-btn.active');
                if(activeTab && activeTab.id === 'sub-live') {
                    ['inpLat','modInpLat'].forEach(id => { const el = document.getElementById(id); if(el) el.value = lat; });
                    ['inpLon','modInpLon'].forEach(id => { const el = document.getElementById(id); if(el) el.value = lon; });
                } else if(activeTab && activeTab.id === 'sub-plan') {
                    const brfLat = document.getElementById('brfTaskLat'); if(brfLat) brfLat.value = lat;
                    const brfLon = document.getElementById('brfTaskLon'); if(brfLon) brfLon.value = lon;
                }
                if(tempClickMarker) map.removeLayer(tempClickMarker);
                tempClickMarker = L.circleMarker(e.latlng, { color: 'red', fillColor: '#f03', fillOpacity: 0.8, radius: 4 }).addTo(map);
            });
            updatePlaneMarker();
        }

        // --- FLIGHT LOGIC ---
        function handleGpsUpdate(coords) {
            currentPos = { lat: coords.latitude, lng: coords.longitude, alt: coords.altitude||0, speed: (coords.speed||0)*3.6, head: coords.heading||0 };
            document.getElementById('valSpeed').innerText = Math.round(currentPos.speed);
            document.getElementById('valAlt').innerText = Math.round(currentPos.alt);
            document.getElementById('valTrack').innerText = Math.round(currentPos.head) + "°";
            
            updatePlaneMarker(); calculateNav(); updateWindHud(); centerMap();
            
            // Trajectory
            if (config.forecastMinutes > 0 && currentPos.speed > 5) {
                const dist = (currentPos.speed / 3.6) * (config.forecastMinutes * 60);
                const endPt = projectPoint(currentPos.lat, currentPos.lng, dist, currentPos.head);
                polylineTrajectory.setLatLngs([[currentPos.lat, currentPos.lng], [endPt.lat, endPt.lng]]);
                if(!forecastMarker) {
                    forecastMarker = L.marker([endPt.lat, endPt.lng], {icon: L.divIcon({html:`<div class="bg-green-500 text-white text-[8px] px-1 rounded font-bold">+${config.forecastMinutes}'</div>`, className:'bg-transparent'})}).addTo(map);
                } else {
                    forecastMarker.setLatLng([endPt.lat, endPt.lng]);
                    forecastMarker.setIcon(L.divIcon({html:`<div class="bg-green-500 text-white text-[8px] px-1 rounded font-bold">+${config.forecastMinutes}'</div>`, className:'bg-transparent'}));
                }
            } else {
                polylineTrajectory.setLatLngs([]);
                if(forecastMarker) { map.removeLayer(forecastMarker); forecastMarker = null; }
            }

            if(isFlightActive) {
                currentFlight.track.push({ ...currentPos, time: new Date().toISOString() });
                polylineTrack.addLatLng([currentPos.lat, currentPos.lng]);
                const b = Math.floor(currentPos.alt/50)*50;
                if(!windProfile[b]) windProfile[b] = { sumSin:0, sumCos:0, sumSpd:0, count:0 };
                const r = currentPos.head*Math.PI/180;
                windProfile[b].sumSin += Math.sin(r); windProfile[b].sumCos += Math.cos(r); windProfile[b].sumSpd += currentPos.speed; windProfile[b].count++;
                updateWindHud();
            }
        }

        // --- NAV ---
        function calculateNav() {
            if(activeTaskIdx === -1 || !tasks[activeTaskIdx] || tasks[activeTaskIdx].completed) {
                document.getElementById('navOverlay').classList.add('hidden');
                document.getElementById('navInstruction').innerText = "Bereit"; return;
            }
            const t = tasks[activeTaskIdx];
            const d = getDistanceM(currentPos.lat, currentPos.lng, t.lat, t.lng);
            const b = getBearing(currentPos.lat, currentPos.lng, t.lat, t.lng);
            document.getElementById('valBrg').innerText = Math.round(b) + "°";
            document.getElementById('overlayDist').innerText = d < 1000 ? Math.round(d) + " m" : (d/1000).toFixed(2) + " km";
            document.getElementById('overlayWpName').innerText = t.title;
            document.getElementById('navOverlay').classList.remove('hidden');
            
            document.getElementById('liveTaskType').innerText = t.type;
            document.getElementById('liveTaskName').innerText = t.title;
            document.getElementById('liveTaskDist').innerText = Math.round(d) + " m";
            document.getElementById('liveTaskBrg').innerText = Math.round(b) + "°";
            
            // Marker Info Update
            const markerDiv = document.getElementById('liveTaskMarkerInfo');
            const countDiv = document.getElementById('liveTaskMarkerCount');
            if(markerDiv && t.markerColors && t.markerColors.length > 0) {
                const nextIndex = (t.droppedMarkers ? t.droppedMarkers.length : 0);
                if(nextIndex < t.markerColors.length) {
                    markerDiv.classList.remove('hidden');
                    markerDiv.innerHTML = `<span class="inline-block w-3 h-3 rounded-full mr-1 border border-black/10" style="background-color:${t.markerColors[nextIndex]}"></span>Marker ${nextIndex+1}`;
                } else {
                    markerDiv.innerHTML = "Fertig";
                }
            } else {
                markerDiv.classList.add('hidden');
            }
            if(countDiv) {
                countDiv.classList.remove('hidden');
                countDiv.innerText = `${t.droppedMarkers ? t.droppedMarkers.length : 0} / ${t.markerColors ? t.markerColors.length : 0}`;
            }

            let diff = b - currentPos.head; while(diff < -180) diff += 360; while(diff > 180) diff -= 360;
            const instr = document.getElementById('navInstruction');
            if(Math.abs(diff) < 4) instr.innerText = "KURS OK"; else instr.innerHTML = `<i class="fa-solid ${diff>0?'fa-arrow-right':'fa-arrow-left'}"></i> ${diff>0?'R':'L'} ${Math.round(Math.abs(diff))}°`;
        }

        // --- RENDER FUNCTIONS ---
        function renderTasks() {
            const list = document.getElementById('taskList'); if(!list) return;
            list.innerHTML = "";
            tasks.forEach((t, i) => {
                const li = document.createElement('li');
                li.className = `p-2 rounded border flex justify-between items-center cursor-pointer ${i===activeTaskIdx?'bg-blue-100 border-blue-300':'bg-white shadow-sm'}`;
                
                let markersHtml = "";
                if(t.markerColors && t.markerColors.length > 0) {
                     markersHtml = `<div class="flex gap-1 mt-1">`;
                     t.markerColors.forEach((c, idx) => {
                         const filled = idx < (t.droppedMarkers ? t.droppedMarkers.length : 0);
                         markersHtml += `<span class="w-2 h-2 rounded-full border border-black/20" style="background-color:${c}; opacity:${filled?1:0.3}"></span>`;
                     });
                     markersHtml += `</div>`;
                }

                li.innerHTML = `
                    <div class="${t.completed ? 'task-completed' : ''}">
                        <span class="font-bold">${t.title} (${t.type})</span>
                        ${markersHtml}
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="text-slate-400 hover:text-green-500" onclick="toggleTaskComplete(${i})"><i class="fa-regular fa-square-check"></i></button>
                        <button class="bg-blue-600 text-white w-6 h-6 rounded" onclick="setActiveTask(${i})"><i class="fa-solid fa-play text-[10px]"></i></button>
                    </div>
                `;
                li.onclick = () => setActiveTask(i);
                list.appendChild(li);
            });
            document.getElementById('taskBadge').innerText = tasks.filter(x => !x.completed).length;
        }

        function drawTaskVisuals() {
            map.eachLayer(l => { if(l.options && l.options.isTaskLayer) map.removeLayer(l); });
            tasks.forEach((t, i) => {
                const isActive = (i === activeTaskIdx);
                const color = isActive ? '#2563eb' : (t.completed ? '#cbd5e1' : '#94a3b8');
                
                L.marker([t.lat, t.lng], { isTaskLayer: true, icon: L.divIcon({ html: `<div class="rounded-full bg-white border-2 flex items-center justify-center font-bold w-5 h-5 text-[10px]" style="border-color:${color}; color:${color}">${i+1}</div>`, className:'' }) }).addTo(map);
                if(t.radius > 0) L.circle([t.lat, t.lng], { radius: t.radius, color, fillOpacity: 0.1, weight: 2, isTaskLayer: true }).addTo(map);
                if(t.radius2 > 0) L.circle([t.lat, t.lng], { radius: t.radius2, color: '#ef4444', fillOpacity: 0.05, weight: 2, isTaskLayer: true }).addTo(map);
                
                // Draw connecting lines for Multi-Marker tasks
                if(t.droppedMarkers && t.droppedMarkers.length > 1) {
                    const latlngs = t.droppedMarkers.map(m => [m.lat, m.lng]);
                    if((t.type === 'LRN' || t.type === 'ELB') && t.droppedMarkers.length === 3) latlngs.push(latlngs[0]); 
                    L.polyline(latlngs, { color: t.markerColors[0] || 'black', weight: 3, dashArray: '5,5', isTaskLayer: true }).addTo(map);
                }
            });
        }
        
        function drawTempTasks() {
            map.eachLayer(l => { if(l.options && l.options.isPreviewLayer) map.removeLayer(l); });
            tempBriefingTasks.forEach((t, i) => { 
                const icon = L.divIcon({ html: `<div class="bg-orange-500 text-white rounded-full w-4 h-4 flex items-center justify-center font-bold text-[8px]">${i+1}</div>`, className: 'bg-transparent', iconSize: [16, 16] });
                L.marker([t.lat, t.lng], { icon, isPreviewLayer: true }).addTo(map); 
                if(t.radius) L.circle([t.lat, t.lng], { radius: t.radius, color: '#f97316', fillOpacity: 0.2, weight: 2, dashArray: '5,5', isPreviewLayer: true }).addTo(map);
                if(t.radius2) L.circle([t.lat, t.lng], { radius: t.radius2, color: '#f97316', fillOpacity: 0.1, weight: 2, dashArray: '5,5', isPreviewLayer: true }).addTo(map);
            });
            if(tempBriefingTasks.length > 0) {
                 const pts = tempBriefingTasks.filter(t => t.lat !== 0).map(t => [t.lat, t.lng]);
                 L.polyline(pts, { color: '#f97316', weight: 2, dashArray: '5, 5', isPreviewLayer: true }).addTo(map);
            }
        }

        function updateWindHud() {
            const hud = document.getElementById('windHudContent'); if(!hud) return; hud.innerHTML = "";
            const tbody = document.getElementById('windTableBody'); if(tbody) tbody.innerHTML = "";
            const sorted = Object.keys(windProfile).map(Number).sort((a,b)=>b-a);
            document.getElementById('windHudCount').innerText = sorted.length;
            sorted.forEach(h => {
                const d = windProfile[h]; const dir = Math.round((Math.atan2(d.sumSin, d.sumCos)*180/Math.PI+360)%360);
                const spd = Math.round(d.sumSpd/d.count);
                const isCurrent = Math.abs(currentPos.alt - h) < 25;
                const arrow = `<i class="fa-solid fa-long-arrow-alt-down transform" style="transform: rotate(${dir}deg)"></i>`;
                hud.innerHTML += `<div class="wind-grid px-2 py-1 rounded transition-all ${isCurrent?'bg-blue-600 text-white font-bold shadow-sm scale-[1.02]':'text-slate-300 hover:bg-white/5'} mb-0.5 font-mono cursor-pointer"><div class="text-left">${h}m</div><div class="flex items-center justify-center gap-1">${arrow} ${dir}°</div><div class="text-right">${spd}</div></div>`;
                if(tbody) tbody.innerHTML += `<tr><td class="p-1">${h}m</td><td class="p-1">${dir}°</td><td class="p-1">${spd} km/h</td></tr>`;
            });
        }

        function renderFlightList() {
            const cont = document.getElementById('flightList'); if(!cont) return;
            cont.innerHTML = savedFlights.length ? "" : '<div class="text-center italic text-xs py-4 text-slate-400">Keine Fahrten im Archiv</div>';
            savedFlights.forEach(f => {
                const div = document.createElement('div'); div.className = "bg-white p-2 rounded border shadow-sm mb-2";
                div.innerHTML = `<div class="text-[10px] font-bold">${new Date(f.start).toLocaleString()}</div><button class="bg-blue-600 text-white px-2 py-1 rounded text-[9px] mt-1" onclick="alert('Export...')">GPX</button>`;
                cont.appendChild(div);
            });
        }

        function renderBriefingList() {
            const cont = document.getElementById('briefingList'); if(!cont) return;
            cont.innerHTML = briefings.length ? "" : '<div class="text-[10px] text-slate-400 italic text-center p-4 border border-dashed rounded">Keine Planungen</div>';
            briefings.forEach((b, idx) => {
                const div = document.createElement('div'); div.className = "bg-white p-3 rounded border flex justify-between items-center shadow-sm";
                div.innerHTML = `<div><div class="font-bold text-sm text-slate-800">${b.name}</div><div class="text-[10px] text-slate-500">${b.tasks.length} Aufgaben</div></div><button class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold" onclick="activateBriefing(${idx})">Laden</button>`;
                cont.appendChild(div);
            });
        }
        
        function renderBriefingTemp() { 
            document.getElementById('brfTaskList').innerHTML = tempBriefingTasks.map((t, i) => {
                let extra = "";
                if(t.altMin || t.altMax) extra = `<span class="text-[8px] text-blue-500 ml-1">H:${t.altMin}-${t.altMax}</span>`;
                let col = "";
                if(t.markerColors && t.markerColors.length > 0) {
                    col = `<span class="inline-block w-2 h-2 rounded-full ml-1 border border-black/10" style="background-color:${t.markerColors[0]}"></span>`;
                    if(t.markerColors.length > 1) col += `<span class="text-[8px] text-slate-400 ml-1">+${t.markerColors.length-1}</span>`;
                }
                return `<li><div class="flex justify-between items-center border-b py-1"><span>${t.title} (${t.type}) ${col} ${extra}</span> <div><button onclick="editTempTask(${i})" class="text-blue-500 px-1">E</button> <button onclick="removeTempTask(${i})" class="text-red-500 px-1">X</button></div></div></li>`;
            }).join(''); 
        }

        // --- SIMULATION ---
        function toggleSimulation() { isSimulating = !isSimulating; document.getElementById('simIndicator').classList.toggle('hidden', !isSimulating); document.getElementById('simOverlayControls').classList.toggle('hidden', !isSimulating); if(isSimulating) simInterval=setInterval(() => { handleGpsUpdate({latitude:currentPos.lat+0.0001, longitude:currentPos.lng+0.0001, altitude:currentPos.alt, speed:5, heading:45}); }, 1000); else clearInterval(simInterval); }
        function startBurn() { simBurnerActive = true; } function stopBurn() { simBurnerActive = false; } function startVent() { simVentActive = true; } function stopVent() { simVentActive = false; }
        
        // --- UI HELPERS ---
        function switchTab(id) { 
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
            ['btn-tab-task','btn-tab-wind','btn-tab-setup','btn-tab-archive'].forEach(k => {
                const el = document.getElementById(k);
                if(el) {
                    if (k === 'btn-' + id) {
                        el.classList.add('text-blue-600', 'border-blue-600', 'bg-blue-50');
                        el.classList.remove('text-slate-500', 'border-transparent');
                    } else {
                        el.classList.remove('text-blue-600', 'border-blue-600', 'bg-blue-50');
                        el.classList.add('text-slate-500', 'border-transparent');
                    }
                }
            });
        }
        function switchSubTab(tab) { document.getElementById('view-live').classList.toggle('hidden', tab!=='live'); document.getElementById('view-plan').classList.toggle('hidden', tab!=='plan'); document.getElementById('sub-live').className = tab==='live'?'sub-tab-btn active':'sub-tab-btn'; document.getElementById('sub-plan').className = tab==='plan'?'sub-tab-btn active':'sub-tab-btn'; }
        function toggleMenu() { document.getElementById('sideMenu').classList.toggle('translate-x-full'); }
        function toggleWindHud() { document.getElementById('windHud').classList.toggle('hidden'); }
        function toggleMapSettings() { document.getElementById('mapSettingsPanel').classList.toggle('hidden'); }
        function centerMap(force=false) { 
            let target = [currentPos.lat, currentPos.lng];
            if(config.forecastMinutes > 0 && currentPos.speed > 2) {
                const dist = (currentPos.speed/3.6) * (config.forecastMinutes * 30); 
                const pt = projectPoint(currentPos.lat, currentPos.lng, dist, currentPos.head);
                target = [pt.lat, pt.lng];
            }
            map.setView(target, map.getZoom()); 
        }
        function safeSetText(id, txt) { const el = document.getElementById(id); if(el) el.innerText = txt; }
        function updatePlaneMarker() { const icon = L.divIcon({ html: `<svg width="30" height="30" style="transform:rotate(${currentPos.head-45}deg)"><path d="M15 2 L28 28 L15 22 L2 28 Z" fill="${isSimulating?'orange':'blue'}" stroke="white" stroke-width="2"/></svg>`, className:'bg-transparent', iconSize:[30,30] }); if(!currentMarker) currentMarker = L.marker([currentPos.lat, currentPos.lng], {icon}).addTo(map); else currentMarker.setLatLng([currentPos.lat, currentPos.lng]).setIcon(icon); }
        function generateSyntheticWind() { for(let h=0; h<=1000; h+=50) windProfile[h] = { sumSin:Math.sin(h/100), sumCos:Math.cos(h/100), sumSpd:12+h/100, count:1 }; updateWindHud(); }
        function deactivateBriefing() { activeBriefing = null; document.getElementById('briefingIndicator').classList.add('hidden'); }
        function activateBriefing(idx) { activeBriefing = briefings[idx]; tasks = JSON.parse(JSON.stringify(activeBriefing.tasks)); activeTaskIdx = 0; renderTasks(); drawTaskVisuals(); calculateNav(); document.getElementById('briefingIndicator').classList.remove('hidden'); switchSubTab('live'); }
        function editBriefing(idx) { document.getElementById('briefingEditor').classList.remove('hidden'); document.getElementById('briefingListContainer').classList.add('hidden'); tempBriefingTasks = []; if(idx===-1) document.getElementById('brfName').value = ""; else { tempBriefingTasks = [...briefings[idx].tasks]; document.getElementById('brfName').value = briefings[idx].name; } renderBriefingTemp(); updateBrfMarkerConfig(); }
        function closeBriefingEditor() { 
            document.getElementById('briefingEditor').classList.add('hidden'); 
            document.getElementById('briefingListContainer').classList.remove('hidden');
            map.eachLayer(l => { if(l.options && l.options.isPreviewLayer) map.removeLayer(l); }); 
        }
        function addOrUpdateBriefingTask() { 
            const lat = parseFloat(document.getElementById('brfTaskLat').value); 
            if(isNaN(lat)) return; 
            const type = document.getElementById('brfTaskType').value;
            const mCount = getMarkerCount(type);
            const mColors = getMarkerColors(mCount, 'brf_m');
            
            const newTask = { 
                title: document.getElementById('brfTaskTitle').value||"T", type, lat, lng: parseFloat(document.getElementById('brfTaskLon').value), radius: parseInt(document.getElementById('brfTaskRad').value)||100, radius2: parseInt(document.getElementById('brfTaskRad2').value)||0, 
                timeStart: document.getElementById('brfTaskTimeStart').value, timeEnd: document.getElementById('brfTaskTimeEnd').value, altMin: document.getElementById('brfTaskAltMin').value, altMax: document.getElementById('brfTaskAltMax').value, markerColors: mColors, droppedMarkers: []
            };
            if(editingTaskIndex >= 0) { tempBriefingTasks[editingTaskIndex] = newTask; cancelTaskEdit(); }
            else tempBriefingTasks.push(newTask); 
            renderBriefingTemp(); drawTempTasks(); 
        }
        function editTempTask(index) {
            const t = tempBriefingTasks[index]; editingTaskIndex = index;
            document.getElementById('brfTaskTitle').value = t.title || ""; 
            document.getElementById('brfTaskType').value = t.type; 
            document.getElementById('brfTaskLat').value = t.lat; document.getElementById('brfTaskLon').value = t.lng; document.getElementById('brfTaskRad').value = t.radius; document.getElementById('brfTaskRad2').value = t.radius2 || 0;
            document.getElementById('brfTaskTimeStart').value = t.timeStart || ""; document.getElementById('brfTaskTimeEnd').value = t.timeEnd || ""; document.getElementById('brfTaskAltMin').value = t.altMin || ""; document.getElementById('brfTaskAltMax').value = t.altMax || "";
            
            updateBrfTaskInputs();
            const cont = document.getElementById('brfMarkerConfigContainer');
            if(t.markerColors && cont) {
                 t.markerColors.forEach((c, idx) => {
                     const inp = document.getElementById(`brf_m_color_${idx}`);
                     if(inp) inp.value = c;
                 });
            }
            
            document.getElementById('btnAddBrfTask').innerText = "Ändern"; document.getElementById('btnCancelBrfTask').classList.remove('hidden');
            renderBriefingTemp();
        }
        function removeTempTask(i) { tempBriefingTasks.splice(i, 1); if(i === editingTaskIndex) cancelTaskEdit(); renderBriefingTemp(); drawTempTasks(); }
        function cancelTaskEdit() { editingTaskIndex = -1; document.getElementById('btnAddBrfTask').innerText = "Add"; document.getElementById('btnCancelBrfTask').classList.add('hidden'); renderBriefingTemp(); }
        function saveBriefing() { briefings.push({ name: document.getElementById('brfName').value||"Plan", tasks: [...tempBriefingTasks], startTime: document.getElementById('brfStart').value }); closeBriefingEditor(); renderBriefingList(); }
        function updateConfigUI() { config.minDistance = parseInt(document.getElementById('cfgDist').value); document.getElementById('lblDist').innerText = config.minDistance + "m"; }
        function resetSimToSpeyer() { currentPos = { ...EDRY_POS, alt:200, head:0, speed:0 }; handleGpsUpdate(currentPos); map.setView([EDRY_POS.lat, EDRY_POS.lng], 15); }
        function updateTaskInputs() { const type = document.getElementById('taskType').value; const inpR2 = document.getElementById('inpRadius2'); if(inpR2) inpR2.classList.toggle('hidden', type!=='3DT'); const altInp = document.getElementById('altInputs'); if(altInp) altInp.classList.toggle('hidden', type!=='APT'); updateLiveMarkerConfig(); }
        function updateBrfTaskInputs() { const type = document.getElementById('brfTaskType').value; document.getElementById('brfTaskRad2').classList.toggle('hidden', type!=='3DT'); document.getElementById('brfAltInputs').classList.toggle('hidden', type!=='APT'); updateBrfMarkerConfig(); }
        function openLiveAddModal() { document.getElementById('liveAddTaskModal').classList.remove('hidden'); updateModMarkerConfig(); }
        function closeLiveAddModal() { document.getElementById('liveAddTaskModal').classList.add('hidden'); }
        function addTaskFromModal() { 
            const lat = parseFloat(document.getElementById('modInpLat').value); 
            if(isNaN(lat)) return; 
            const type = document.getElementById('modTaskType').value;
            const mCount = getMarkerCount(type);
            const mColors = getMarkerColors(mCount, 'mod_m');
            tasks.push({ title: document.getElementById('modInpTitle').value||"S", lat, lng: parseFloat(document.getElementById('modInpLon').value), type, completed: false, radius: 100, markerColors: mColors, droppedMarkers: [] }); 
            renderTasks(); drawTaskVisuals(); closeLiveAddModal(); 
        }
        function dropMarker() { 
            if(!isSimulating && (!currentPos.lat || !isFlightActive)) return alert("Bitte erst START drücken!");
            const drop = { lat: currentPos.lat, lng: currentPos.lng, alt: currentPos.alt, time: new Date().toISOString() };
            markerDrops.push(drop); if(isFlightActive) currentFlight.markers.push(drop);
            
            // Assign to active task
            if(activeTaskIdx !== -1 && !tasks[activeTaskIdx].completed) {
                const t = tasks[activeTaskIdx];
                if(t.markerColors && t.droppedMarkers.length < t.markerColors.length) {
                    t.droppedMarkers.push(drop);
                    const col = t.markerColors[t.droppedMarkers.length - 1];
                    L.marker([drop.lat, drop.lng], { icon: L.divIcon({ html: `<i class="fa-solid fa-location-dot text-lg drop-shadow-md" style="color:${col}"></i>`, className: 'bg-transparent' }) }).addTo(map);
                } else {
                     L.marker([drop.lat, drop.lng], { icon: L.divIcon({ html:'<i class="fa-solid fa-times text-slate-500 font-bold text-lg"></i>', className:''})}).addTo(map);
                }
                renderTasks(); drawTaskVisuals(); calculateNav();
            } else {
                 L.marker([drop.lat, drop.lng], { icon: L.divIcon({ html:'<i class="fa-solid fa-times text-slate-500 font-bold text-lg"></i>', className:''})}).addTo(map);
            }
        }
        function checkBriefingTimes() { 
            const now = new Date(); const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            if (activeTaskIdx !== -1 && tasks.length > 0 && tasks[activeTaskIdx]) {
                const t = tasks[activeTaskIdx]; const statusEl = document.getElementById('liveTaskTimeStatus');
                if (t.timeStart || t.timeEnd) {
                    statusEl.classList.remove('hidden'); statusEl.innerText = `${t.timeStart||'--'} - ${t.timeEnd||'--'}`;
                    let ok = true; if(t.timeStart && timeStr < t.timeStart) ok = false; if(t.timeEnd && timeStr > t.timeEnd) ok = false;
                    statusEl.className = ok ? "mt-2 text-[10px] font-bold px-2 py-0.5 rounded-full inline-block bg-green-100 text-green-700" : "mt-2 text-[10px] font-bold px-2 py-0.5 rounded-full inline-block bg-red-100 text-red-600";
                    const instr = document.getElementById('navInstruction');
                    if(!ok && instrEl) instrEl.innerHTML = `<span class="text-red-300">ZEITFENSTER!</span>`;
                } else statusEl.classList.add('hidden');
            }
        }
        function showActiveTaskInfo() { if(activeTaskIdx>=0) showTaskInfoModal(tasks[activeTaskIdx].type); }
        function showTaskInfo() { showTaskInfoModal(document.getElementById('taskType').value); }
        function showTaskInfoFromEditor() { showTaskInfoModal(document.getElementById('brfTaskType').value); }
        function showTaskInfoModal(type) { document.getElementById('infoTaskContent').innerHTML = TASK_RULES_DATA[type] || "Keine Info verfügbar."; document.getElementById('taskInfoModal').classList.remove('hidden'); }
        function closeTaskInfo() { document.getElementById('taskInfoModal').classList.add('hidden'); }
        function useCurrentPosAsGoal() { document.getElementById('inpLat').value = currentPos.lat.toFixed(5); document.getElementById('inpLon').value = currentPos.lng.toFixed(5); }
        function useCurrentPosForModal() { document.getElementById('modInpLat').value = currentPos.lat.toFixed(5); document.getElementById('modInpLon').value = currentPos.lng.toFixed(5); }
        function exportGpx(id) { alert("Export..."); }
        function toggleCockpit() { const cp = document.getElementById('cockpit'); const chevron = document.getElementById('cockpitChevron'); isCockpitCollapsed = !isCockpitCollapsed; cp.classList.toggle('cockpit-collapsed', isCockpitCollapsed); chevron.style.transform = isCockpitCollapsed ? 'rotate(180deg)' : 'rotate(0deg)'; setTimeout(() => { map.invalidateSize(); centerMap(true); }, 400); }
        function setActiveTask(index) { activeTaskIdx = index; renderTasks(); drawTaskVisuals(); calculateNav(); }
        function toggleTaskComplete(index) { tasks[index].completed = !tasks[index].completed; if(tasks[index].completed && index === activeTaskIdx) { let nextIdx = -1; for(let i = index + 1; i < tasks.length; i++) { if(!tasks[i].completed) { nextIdx = i; break; } } if(nextIdx !== -1) activeTaskIdx = nextIdx; } renderTasks(); drawTaskVisuals(); calculateNav(); }
        function completeCurrentTask() { if(activeTaskIdx === -1 || tasks.length === 0) return; tasks[activeTaskIdx].completed = true; let nextIdx = -1; for(let i = activeTaskIdx + 1; i < tasks.length; i++) { if(!tasks[i].completed) { nextIdx = i; break; } } if(nextIdx === -1) { for(let i = 0; i < activeTaskIdx; i++) { if(!tasks[i].completed) { nextIdx = i; break; } } } activeTaskIdx = nextIdx; renderTasks(); drawTaskVisuals(); calculateNav(); }
        async function fetchOnlineWind() {
            const lat = currentPos.lat; const lon = currentPos.lng;
            const levels = [1000, 950, 925, 900, 850];
            const vars = levels.map(l => `wind_speed_${l}hPa,wind_direction_${l}hPa`).join(',');
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=${vars}&forecast_days=1`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Netzwerkfehler');
                const data = await response.json();
                const currentHour = new Date().toISOString().slice(0, 13) + ":00";
                const index = data.hourly.time.indexOf(currentHour);
                if (index === -1) { alert("Keine Daten."); return; }
                windProfile = {};
                const hPaToMeters = { 1000: 100, 950: 540, 925: 760, 900: 990, 850: 1460 };
                levels.forEach(level => {
                    const speed = data.hourly[`wind_speed_${level}hPa`][index];
                    const dir = data.hourly[`wind_direction_${level}hPa`][index];
                    const alt = hPaToMeters[level];
                    if (speed !== undefined && dir !== undefined) {
                        const vectorDir = (dir + 180) % 360; const rad = vectorDir * Math.PI / 180;
                        const key = Math.round(alt / 50) * 50;
                        windProfile[key] = { sumSin: Math.sin(rad), sumCos: Math.cos(rad), sumSpd: speed, count: 1 };
                    }
                });
                updateWindHud(); alert("Live-Wind geladen!");
            } catch (err) { console.error(err); alert("Fehler: " + err.message); }
        }
        
        function toggleFlight() {
            const btn = document.getElementById('btnFlightToggle');
            if (!isFlightActive) {
                if (activeBriefing && activeBriefing.startTime) {
                    const nowStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    if (nowStr < activeBriefing.startTime && !confirm(`ACHTUNG: Startperiode beginnt erst um ${activeBriefing.startTime}. Vorzeitig starten?`)) return;
                }
                isFlightActive = true;
                currentFlight = { id: Date.now(), start: new Date().toISOString(), track: [], tasksSnapshot: [], markers: [] };
                btn.className = "w-full py-4 rounded-xl font-black text-lg text-white bg-red-600 shadow-lg";
                btn.innerHTML = `<span>LANDUNG</span>`;
                document.getElementById('liveFormCard').classList.add('hidden');
                document.getElementById('liveTaskCard').classList.remove('hidden');
                if(!isSimulating) navigator.geolocation.watchPosition(pos => handleGpsUpdate(pos.coords), null, {enableHighAccuracy:true});
                wakeLockManager.request();
            } else {
                if(!confirm("Fahrt beenden?")) return;
                isFlightActive = false;
                savedFlights.unshift({ ...currentFlight, tasksSnapshot: JSON.parse(JSON.stringify(tasks)) }); 
                renderFlightList();
                btn.className = "w-full py-4 rounded-xl font-black text-lg text-white bg-green-500 shadow-lg pulse-ring";
                btn.innerHTML = `<span>START</span>`;
                document.getElementById('liveFormCard').classList.remove('hidden');
                document.getElementById('liveTaskCard').classList.add('hidden');
                switchTab('tab-archive');
                wakeLockManager.release();
            }
        }

        function addTask() {
            const lat = parseFloat(document.getElementById('inpLat').value);
            if(isNaN(lat)) return;
            const type = document.getElementById('taskType').value;
            const mCount = getMarkerCount(type);
            const mColors = getMarkerColors(mCount, 'live_m');
            const tStart = document.getElementById('inpTimeStart') ? document.getElementById('inpTimeStart').value : "";
            const tEnd = document.getElementById('inpTimeEnd') ? document.getElementById('inpTimeEnd').value : "";
            const altMin = document.getElementById('inpAltMin') ? document.getElementById('inpAltMin').value : "";
            const altMax = document.getElementById('inpAltMax') ? document.getElementById('inpAltMax').value : "";

            const task = { 
                id: Date.now(), 
                title: document.getElementById('inpTitle').value||`T${tasks.length + 1}`, 
                lat, lng: parseFloat(document.getElementById('inpLon').value), type, 
                radius: parseInt(document.getElementById('inpRadius').value)||100, 
                radius2: parseInt(document.getElementById('inpRadius2').value)||0,
                completed: false, 
                markerColors: mColors, droppedMarkers: [],
                timeStart: tStart,
                timeEnd: tEnd,
                altMin: altMin,
                altMax: altMax
            };
            tasks.push(task); if(activeTaskIdx === -1) activeTaskIdx = 0; renderTasks(); drawTaskVisuals(); calculateNav(); 
            document.getElementById('inpTitle').value = "";
        }

        function setMapStyle(style) { 
            map.removeLayer(baseLayers.osm); map.removeLayer(baseLayers.sat); 
            baseLayers[style].addTo(map); 
            document.getElementById('btnStyleOsm').className = style==='osm' ? "flex-1 text-[10px] py-1 rounded bg-white shadow-sm font-bold text-blue-600" : "flex-1 text-[10px] py-1 rounded text-slate-500";
            document.getElementById('btnStyleSat').className = style==='sat' ? "flex-1 text-[10px] py-1 rounded bg-white shadow-sm font-bold text-blue-600" : "flex-1 text-[10px] py-1 rounded text-slate-500";
        }
        function changeMapStyle() { setMapStyle(document.getElementById('mapStyle').value); }
        
        function setTrajectory(min) {
            config.forecastMinutes = min;
            [0,5,10,15].forEach(m => {
                const btn = document.getElementById(`traj${m}`);
                if(m === min) btn.className = "text-[9px] py-1 rounded bg-blue-600 text-white border border-blue-600 font-bold";
                else btn.className = "text-[9px] py-1 rounded bg-slate-100 border hover:bg-slate-200";
            });
            handleGpsUpdate(currentPos);
        }

        // --- ONLOAD ---
        window.onload = function() {
            initMap();
            generateSyntheticWind();
            renderBriefingList();
            renderFlightList();
            setInterval(checkBriefingTimes, 1000);
            updateLiveMarkerConfig();
            
            document.addEventListener('visibilitychange', async () => {
                if(document.visibilityState === 'visible' && isFlightActive) await wakeLockManager.request();
            });
        };
    </script>
</body>
</html>
