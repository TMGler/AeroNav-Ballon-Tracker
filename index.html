<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CompNavAir Master - Competition Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Omnivore for KML Support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.4/leaflet-omnivore.min.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Global & Layout */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        
        /* Map Area */
        #main-content { position: relative; flex-grow: 1; width: 100%; height: 100%; overflow: hidden; }
        #map-container { height: 100%; width: 100%; z-index: 0; cursor: crosshair; background: #e2e8f0; }
        
        /* UI Elements */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(0,0,0,0.1); }
        .instrument-box { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); color: white; }
        .nav-director { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-top: 2px solid #3b82f6; }
        
        /* Tab Management */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        
        /* Cockpit Overlay Logic */
        #cockpit { 
            position: absolute; 
            bottom: 0; left: 0; right: 0; 
            z-index: 1000; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .cockpit-collapsed { transform: translateY(100%); } /* Slide completely out */
        
        /* Floating Handle when collapsed */
        #cockpit-toggle-btn {
            position: absolute;
            top: -24px; /* Height of handle */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .pulse-ring { animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); } 100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }

        /* Sim Buttons */
        .sim-overlay-btn { backdrop-filter: blur(4px); transition: all 0.2s; touch-action: manipulation; user-select: none; }
        .btn-burner { background: rgba(239, 68, 68, 0.85); border: 2px solid white; color: white; }
        .btn-burner:active { background: #ef4444; transform: scale(0.95); box-shadow: 0 0 20px #f59e0b; }
        .btn-vent { background: rgba(71, 85, 105, 0.85); border: 2px solid white; color: white; }
        .btn-vent:active { background: #334155; transform: scale(0.95); }
        .btn-marker { background: rgba(37, 99, 235, 0.9); border: 2px solid white; color: white; }
        .btn-marker:active { background: #1d4ed8; transform: scale(0.9); }
        
        /* Utils */
        .wind-hud::-webkit-scrollbar { display: none; }
        .wind-hud { -ms-overflow-style: none; scrollbar-width: none; }
        .kml-popup-table { font-size: 11px; width: 100%; border-collapse: collapse; margin-top: 5px; background: white; }
        .kml-popup-table td { padding: 4px; border-bottom: 1px solid #e2e8f0; }
        .kml-popup-label { font-weight: bold; color: #64748b; width: 40%; vertical-align: top; text-transform: uppercase; font-size: 9px; }
        .kml-popup-value { color: #1e293b; font-weight: 700; }
        
        .sub-tab-btn { padding-bottom: 4px; color: #64748b; font-weight: bold; text-transform: uppercase; font-size: 0.75rem; border-bottom: 2px solid transparent; }
        .sub-tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; }
        .task-completed { opacity: 0.6; background-color: #f1f5f9; }
        .task-completed span { text-decoration: line-through; color: #94a3b8; }
    </style>
</head>
<body class="bg-slate-200 h-screen w-screen overflow-hidden flex flex-col font-sans text-slate-900">

    <!-- Top Bar -->
    <header class="glass-panel z-20 px-4 py-2 flex justify-between items-center shadow-sm shrink-0 h-14 relative">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white w-8 h-8 rounded flex items-center justify-center font-bold text-xs shadow-md">CNA</div>
            <div>
                <h1 class="font-bold text-sm leading-tight text-slate-800">CompNavAir <span class="text-xs text-blue-500 font-normal">Competition</span></h1>
                <div class="flex items-center gap-2 text-[10px]">
                    <span id="gpsStatus" class="text-slate-500">Bereit.</span>
                    <span id="simIndicator" class="hidden font-bold text-purple-600 bg-purple-100 px-1 rounded uppercase">Sim</span>
                    <button id="briefingIndicator" onclick="deactivateBriefing()" class="hidden font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded animate-pulse border border-blue-200 uppercase hover:bg-blue-200">
                        WETTKAMPF AKTIV <i class="fa-solid fa-xmark ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleWindHud()" class="bg-white text-slate-600 p-2 rounded-lg shadow border border-slate-200 active:bg-slate-50" title="Wind">
                <i class="fa-solid fa-wind"></i>
            </button>
            <button onclick="toggleMapSettings()" class="bg-white text-slate-600 p-2 rounded-lg shadow border border-slate-200 active:bg-slate-50" title="Karten & Ansicht">
                <i class="fa-solid fa-layer-group"></i>
            </button>
            <button onclick="centerMap(true)" class="bg-white text-blue-600 p-2 rounded-lg shadow border border-slate-200" title="Zentrieren"><i class="fa-solid fa-location-crosshairs"></i></button>
            <button onclick="toggleMenu()" class="bg-white text-slate-700 p-2 rounded-lg shadow border border-slate-200 relative">
                <i class="fa-solid fa-bars"></i>
                <span id="taskBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center">0</span>
            </button>
        </div>
    </header>

    <!-- Main Content Wrapper (Map + Overlays) -->
    <div id="main-content">
        <div id="map-container"></div>
        
        <!-- WIND HUD -->
        <div id="windHud" class="absolute top-4 left-4 z-[400] bg-slate-900/80 backdrop-blur text-white p-2 rounded-lg border border-white/20 w-32 shadow-xl flex flex-col gap-1 max-h-[40vh]">
            <div class="text-[9px] font-bold uppercase border-b border-white/20 pb-1 mb-1 flex justify-between">
                <span>Wind Profil</span>
                <span id="windHudCount" class="text-slate-400">0</span>
            </div>
            <div id="windHudContent" class="overflow-y-auto wind-hud space-y-0.5 text-[10px] font-mono">
                <div class="text-center text-slate-400 italic py-2">Keine Daten</div>
            </div>
        </div>

        <!-- MAP SETTINGS POPUP -->
        <div id="mapSettingsPanel" class="hidden absolute z-[1100] top-16 right-4 bg-white rounded-lg shadow-xl border border-slate-200 w-64 p-3 flex flex-col gap-3">
            <div class="flex justify-between items-center border-b pb-2">
                <h3 class="text-xs font-bold text-slate-700 uppercase">Karten & Ansicht</h3>
                <button onclick="toggleMapSettings()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-500 mb-1">Basiskarte</label>
                <div class="flex bg-slate-100 p-1 rounded">
                    <button onclick="setMapStyle('osm')" id="btnStyleOsm" class="flex-1 text-[10px] py-1 rounded bg-white shadow-sm font-bold text-blue-600">Karte</button>
                    <button onclick="setMapStyle('sat')" id="btnStyleSat" class="flex-1 text-[10px] py-1 rounded text-slate-500">Satellit</button>
                </div>
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-500 mb-1">Vorausschau</label>
                <div class="grid grid-cols-4 gap-1">
                    <button onclick="setTrajectory(0)" id="traj0" class="text-[9px] py-1 rounded bg-slate-100 border hover:bg-slate-200">Aus</button>
                    <button onclick="setTrajectory(5)" id="traj5" class="text-[9px] py-1 rounded bg-blue-600 text-white border border-blue-600 font-bold">5'</button>
                    <button onclick="setTrajectory(10)" id="traj10" class="text-[9px] py-1 rounded bg-slate-100 border hover:bg-slate-200">10'</button>
                    <button onclick="setTrajectory(15)" id="traj15" class="text-[9px] py-1 rounded bg-slate-100 border hover:bg-slate-200">15'</button>
                </div>
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-500 mb-1">KML Overlays</label>
                <div id="quickKmlList" class="space-y-1 max-h-32 overflow-y-auto">
                    <div class="text-[9px] italic text-slate-400">Keine KMLs geladen</div>
                </div>
            </div>
        </div>

        <!-- Waypoint Overlay -->
        <div id="navOverlay" class="absolute top-4 left-40 right-4 bg-white/95 backdrop-blur p-3 rounded-xl shadow-lg z-[500] hidden border-l-4 border-blue-600 flex justify-between items-center">
            <div>
                <div class="text-[9px] text-slate-400 uppercase font-bold" id="overlayTaskType">Aufgabe</div>
                <div class="text-slate-800 font-bold text-base leading-none" id="overlayWpName">Kein Ziel</div>
            </div>
            <div class="text-right">
                <div class="text-[9px] text-slate-400 uppercase font-bold">Abstand</div>
                <div class="text-blue-600 font-mono text-lg font-bold" id="overlayDist">--- m</div>
            </div>
        </div>

        <!-- SIM CONTROLS (Floating) -->
        <div id="simOverlayControls" class="hidden absolute left-4 top-1/2 -translate-y-1/2 flex flex-col gap-4 z-[2000]">
            <button onmousedown="startBurn()" onmouseup="stopBurn()" ontouchstart="startBurn()" ontouchend="stopBurn()" class="sim-overlay-btn btn-burner w-16 h-24 rounded-2xl flex flex-col items-center shadow-xl">
                <i class="fa-solid fa-fire text-2xl mt-4"></i><span class="text-[9px] font-bold mt-1 uppercase">Auf</span>
            </button>
            <button onclick="dropMarker()" class="sim-overlay-btn btn-marker w-16 h-16 rounded-full flex flex-col items-center justify-center shadow-xl border-2 border-white">
                <i class="fa-solid fa-location-dot text-xl"></i><span class="text-[8px] font-bold uppercase">Mark</span>
            </button>
            <button onmousedown="startVent()" onmouseup="stopVent()" ontouchstart="startVent()" ontouchend="stopVent()" class="sim-overlay-btn btn-vent w-16 h-20 rounded-2xl flex flex-col items-center shadow-xl">
                <i class="fa-solid fa-arrow-down text-xl mt-3"></i><span class="text-[9px] font-bold mt-1 uppercase">Ab</span>
            </button>
        </div>

        <!-- COCKPIT HUD (Overlay) -->
        <div id="cockpit" class="bg-slate-900 shadow-2xl shrink-0 flex flex-col rounded-t-xl w-full">
            <!-- Toggle Handle -->
            <button id="cockpit-toggle-btn" onclick="toggleCockpit()" class="bg-slate-900 text-white w-16 h-6 rounded-t-xl flex items-center justify-center shadow-lg border-t border-x border-white/10 active:bg-slate-800 transition-colors cursor-pointer">
                <i id="cockpitChevron" class="fa-solid fa-chevron-down text-xs transition-transform duration-300"></i>
            </button>

            <div id="cockpitContent" class="p-2 pt-3 pb-6 flex flex-col gap-1 transition-opacity duration-300">
                <div class="nav-director rounded-lg p-2 flex items-center justify-between shadow-inner relative overflow-hidden bg-slate-800/50">
                    <div id="devIndicatorBg" class="absolute inset-0 opacity-10 pointer-events-none"></div>
                    <div class="z-10 text-center w-1/4">
                        <div class="text-[8px] text-slate-400 uppercase">Soll (Brg)</div>
                        <div class="text-lg font-bold text-blue-400 font-mono" id="valBrg">---</div>
                    </div>
                    <div class="z-10 flex-1 text-center mx-2">
                        <div class="text-sm font-bold text-white transition-all duration-300" id="navInstruction">Warte...</div>
                        <div class="text-[9px] text-slate-400 font-mono" id="navDevValue">Abweichung: 0°</div>
                    </div>
                    <div class="z-10 text-center w-1/4">
                        <div class="text-[8px] text-slate-400 uppercase">Ist (Trk)</div>
                        <div class="text-lg font-bold text-green-400 font-mono" id="valTrack">---</div>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-1">
                    <div class="instrument-box rounded p-1 text-center">
                        <div class="text-[8px] text-slate-400 uppercase">GS km/h</div>
                        <div class="text-base font-bold text-green-400 font-mono" id="valSpeed">0</div>
                    </div>
                    <div class="instrument-box rounded p-1 text-center">
                        <div class="text-[8px] text-slate-400 uppercase">ALT m</div>
                        <div class="text-base font-bold text-orange-400 font-mono" id="valAlt">0</div>
                    </div>
                    <div class="instrument-box rounded p-1 text-center">
                        <div class="text-[8px] text-slate-400 uppercase">VARIO m/s</div>
                        <div class="text-base font-bold text-white font-mono" id="valVario">0.0</div>
                    </div>
                    <button onclick="completeCurrentTask()" class="bg-blue-600 text-white rounded p-1 flex flex-col items-center justify-center active:scale-95 shadow border border-blue-500 transition-colors">
                        <i class="fa-solid fa-forward-step text-xs mb-1"></i><span class="text-[8px] font-bold uppercase">Next</span>
                    </button>
                </div>
                <div id="timeInfoBar" class="text-sm font-bold text-center text-slate-400 font-mono hidden bg-slate-800/80 p-2 rounded mt-1 border border-slate-700"></div>
            </div>
        </div>
    </div>

    <!-- SIDE MENU -->
    <div id="sideMenu" class="absolute inset-y-0 right-0 w-80 max-w-[90vw] bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-[2000] flex flex-col">
        <div class="p-4 bg-slate-100 border-b flex justify-between items-center shrink-0">
            <h2 class="font-bold text-slate-700">Flug Management</h2>
            <button onclick="toggleMenu()" class="text-slate-400 p-1"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <div class="flex border-b border-slate-200 text-[10px] font-bold uppercase shrink-0">
            <button onclick="switchTab('tab-task')" id="btn-tab-task" class="flex-1 py-3 text-blue-600 border-b-2 border-blue-600 bg-blue-50">Wettkampf</button>
            <button onclick="switchTab('tab-wind')" id="btn-tab-wind" class="flex-1 py-3 text-slate-500">Wind</button>
            <button onclick="switchTab('tab-setup')" id="btn-tab-setup" class="flex-1 py-3 text-slate-500">Setup</button>
            <button onclick="switchTab('tab-archive')" id="btn-tab-archive" class="flex-1 py-3 text-slate-500">Archiv</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 bg-slate-50 space-y-4">
            
            <!-- TAB: WETTKAMPF -->
            <div id="tab-task" class="tab-content active space-y-4">
                <div class="flex gap-4 border-b border-slate-200 pb-2 mb-2">
                    <button onclick="switchSubTab('live')" id="sub-live" class="sub-tab-btn active">Live Modus</button>
                    <button onclick="switchSubTab('plan')" id="sub-plan" class="sub-tab-btn">Briefing</button>
                </div>
                
                <div id="view-live" class="space-y-4">
                    <button onclick="toggleFlight()" id="btnFlightToggle" class="w-full py-4 rounded-xl font-black text-lg text-white bg-green-500 hover:bg-green-600 shadow-lg flex flex-col items-center justify-center gap-1 pulse-ring">
                        <span>START</span>
                    </button>

                    <div id="liveFormCard" class="bg-white p-3 rounded shadow-sm border border-slate-200">
                        <input type="text" id="inpTitle" placeholder="Titel / Nummer (z.B. Task 1)" class="w-full p-2 border rounded text-xs font-bold mb-1 bg-slate-50">
                        <div class="mb-2 flex items-center gap-2">
                            <select id="taskType" onchange="updateTaskInputs()" class="flex-1 p-2 border rounded text-xs font-bold">
                                <option value="JDG">JDG (15.2)</option>
                                <option value="PDG">PDG (15.1)</option>
                                <option value="HWZ">HWZ (15.3)</option>
                                <option value="FIN">FIN (15.4)</option>
                                <option value="FON">FON (15.5)</option>
                                <option value="HNH">HNH</option>
                                <option value="WSD">WSD</option>
                                <option value="GBM">GBM</option>
                                <option value="CRT">CRT</option>
                                <option value="ELB">ELB</option>
                                <option value="LRN">LRN</option>
                                <option value="MDD">MDD</option>
                                <option value="XDD">XDD</option>
                                <option value="ANG">ANG</option>
                                <option value="3DT">3DT</option>
                            </select>
                            <button onclick="showTaskInfo()" class="text-blue-500 p-2"><i class="fa-solid fa-circle-info text-lg"></i></button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input type="number" id="inpLat" placeholder="Lat" class="p-2 border rounded text-xs font-mono" step="0.0001">
                            <input type="number" id="inpLon" placeholder="Lon" class="p-2 border rounded text-xs font-mono" step="0.0001">
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="inpRadius" placeholder="R1 (m)" class="flex-1 p-2 border rounded text-xs" value="100">
                            <input type="number" id="inpRadius2" placeholder="R2 (m)" class="hidden flex-1 p-2 border rounded text-xs">
                            <button onclick="useCurrentPosAsGoal()" class="bg-slate-100 p-2 rounded border text-xs" title="Hier"><i class="fa-solid fa-crosshairs"></i></button>
                        </div>
                        <div id="extraInputs" class="hidden mb-2">
                            <input type="number" id="inpDirection" placeholder="Richtung (°)" class="w-full p-2 border rounded text-xs">
                        </div>
                        <button onclick="addTask()" class="w-full bg-blue-600 text-white py-2 rounded font-bold text-xs">HINZUFÜGEN</button>
                    </div>

                    <div id="liveTaskCard" class="hidden bg-blue-50 p-4 rounded-xl border border-blue-200 shadow-md text-center">
                        <div class="flex justify-between items-center mb-2">
                            <button onclick="showActiveTaskInfo()" class="text-blue-500 font-bold text-[10px] uppercase"><i class="fa-solid fa-circle-info"></i> Info</button>
                            <button onclick="openLiveAddModal()" class="text-[10px] bg-white text-blue-600 px-2 py-1 rounded shadow-sm font-bold border border-blue-100">+ TASK</button>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-black text-slate-800" id="liveTaskType">---</div>
                            <div class="text-sm font-bold text-slate-500 mb-1" id="liveTaskName">Keine Aufgabe</div>
                            <div class="text-[10px] font-mono text-slate-400" id="liveTaskCoords"></div>
                            <div id="liveTaskTimeStatus" class="mt-2 text-[10px] font-bold px-2 py-0.5 rounded-full inline-block bg-slate-200 text-slate-500 hidden"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-3 text-center">
                            <div class="bg-white rounded p-1"><div class="text-[8px] text-slate-400 uppercase">Abstand</div><div class="text-base font-bold text-blue-600 font-mono" id="liveTaskDist">---</div></div>
                            <div class="bg-white rounded p-1"><div class="text-[8px] text-slate-400 uppercase">Bearing</div><div class="text-base font-bold text-slate-700 font-mono" id="liveTaskBrg">---</div></div>
                        </div>
                    </div>
                    <ul id="taskList" class="space-y-1"></ul>
                    <div class="bg-white p-3 rounded shadow-sm border border-slate-200">
                        <h3 class="text-xs font-bold text-slate-500 uppercase mb-2 border-b pb-1">Marker & Log</h3>
                        <div class="max-h-32 overflow-y-auto text-[10px] font-mono" id="markerResults">Keine Events.</div>
                    </div>
                </div>
                <div id="view-plan" class="space-y-4 hidden">
                    <div id="briefingList" class="space-y-2"></div>
                    <button onclick="editBriefing(-1)" class="w-full bg-slate-700 text-white py-3 rounded font-bold text-xs hover:bg-slate-600">+ Neues Briefing</button>
                </div>
            </div>

            <!-- TAB: WIND -->
            <div id="tab-wind" class="tab-content space-y-4">
                <div class="bg-white rounded border overflow-hidden">
                    <table class="w-full text-left text-[10px]">
                        <thead class="bg-slate-100 text-slate-500"><tr><th class="p-1">H</th><th class="p-1">D</th><th class="p-1">S</th></tr></thead>
                        <tbody id="windTableBody" class="divide-y divide-slate-100 font-mono"></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: SETUP -->
            <div id="tab-setup" class="tab-content space-y-4">
                <div class="bg-white p-3 rounded shadow-sm border border-slate-200">
                    <h3 class="text-xs font-bold uppercase mb-3 border-b pb-1 text-slate-400">Karten & KML</h3>
                    <div class="space-y-3">
                        <input type="file" id="kmlFileInput" multiple accept=".kml" onchange="handleKmlUpload()" class="text-[10px] w-full border p-1 rounded bg-slate-50">
                        <div id="kmlList" class="space-y-1 mt-2"></div>
                    </div>
                </div>
                <div class="bg-white p-3 rounded shadow-sm border border-slate-200">
                    <h3 class="text-xs font-bold uppercase mb-3 border-b pb-1 text-slate-400">Aufzeichnung</h3>
                    <div class="space-y-2">
                        <label class="flex justify-between text-[10px] font-bold"><span>Min Distanz</span><span id="lblDist">50m</span></label>
                        <input type="range" id="cfgDist" min="10" max="200" value="50" oninput="updateConfigUI()" class="w-full h-1 bg-slate-200 rounded accent-blue-600">
                        
                        <label class="flex justify-between text-[10px] font-bold mt-2"><span>Kursänderung</span><span id="lblHead">5°</span></label>
                        <input type="range" id="cfgHead" min="1" max="30" value="5" oninput="updateConfigUI()" class="w-full h-1 bg-slate-200 rounded accent-blue-600">
                    </div>
                </div>
                <button onclick="toggleSimulation()" id="btnSimToggle" class="w-full py-4 bg-slate-800 text-white rounded-xl font-bold shadow-lg">Simulation Ein/Aus</button>
            </div>
            
            <div id="tab-archive" class="tab-content space-y-4">
                <div id="flightList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Briefing Editor Popup -->
    <div id="briefingEditor" class="hidden bg-white p-3 rounded shadow-lg border border-slate-200 fixed top-10 left-4 right-4 bottom-10 z-[3000] overflow-y-auto flex flex-col">
        <div class="flex justify-between items-center mb-4 shrink-0"><h3 class="font-bold text-slate-700">Planung</h3><button onclick="closeBriefingEditor()"><i class="fa-solid fa-xmark text-xl"></i></button></div>
        <div class="space-y-3 flex-grow overflow-y-auto pr-1">
            <input type="text" id="brfName" placeholder="Bezeichnung" class="w-full p-2 border rounded font-bold">
            <div class="grid grid-cols-2 gap-2 text-xs">
                <div><label class="block mb-1">Startzeit</label><input type="time" id="brfStart" class="w-full p-2 border rounded"></div>
                <div><label class="block mb-1">Schlusszeit</label><input type="time" id="brfEnd" class="w-full p-2 border rounded"></div>
            </div>
            <div class="bg-slate-50 p-2 rounded border">
                <h4 class="text-xs font-bold text-slate-500 mb-2">Aufgaben</h4>
                <ul id="brfTaskList" class="space-y-1 mb-2 text-[10px]"></ul>
                <div class="bg-white p-2 border rounded border-blue-100 space-y-1">
                    <input type="text" id="brfTaskTitle" placeholder="Titel / Nr." class="w-full text-[10px] p-1 border rounded mb-1 font-bold">
                    <select id="brfTaskType" class="text-[10px] p-1 border rounded w-full mb-1"><option value="JDG">JDG</option><option value="HWZ">HWZ</option><option value="FIN">FIN</option><option value="PDG">PDG</option><option value="FON">FON</option><option value="3DT">3DT</option></select>
                    <div class="grid grid-cols-2 gap-1 mb-1"><input type="text" id="brfTaskLat" placeholder="Lat" class="text-[10px] p-1 border rounded"><input type="text" id="brfTaskLon" placeholder="Lon" class="text-[10px] p-1 border rounded"></div>
                    <div class="grid grid-cols-3 gap-1"><input type="number" id="brfTaskRad" placeholder="R1" class="text-[10px] p-1 border rounded" value="100"><input type="number" id="brfTaskRad2" placeholder="R2" class="text-[10px] p-1 border rounded"><button onclick="addOrUpdateBriefingTask()" id="btnAddBrfTask" class="bg-blue-100 text-blue-700 text-[10px] font-bold rounded">Add</button></div>
                    <button onclick="cancelTaskEdit()" id="btnCancelBrfTask" class="hidden w-full text-[9px] text-slate-400 mt-1">Abbrechen</button>
                </div>
            </div>
            <button onclick="saveBriefing()" class="w-full bg-green-600 text-white py-3 rounded font-bold shadow shrink-0 mt-4 uppercase tracking-wider">Planung speichern</button>
        </div>
    </div>

    <!-- LIVE ADD MODAL -->
    <div id="liveAddTaskModal" class="hidden fixed inset-0 info-modal-overlay flex items-center justify-center p-4 z-[4000]">
        <div class="bg-white rounded-lg shadow-2xl max-w-sm w-full p-4">
            <h3 class="font-bold text-slate-700 mb-3">Spontane Aufgabe</h3>
            <input type="text" id="modInpTitle" placeholder="Titel / Nr." class="w-full p-2 border rounded text-xs mb-2 font-bold bg-slate-50">
            <select id="modTaskType" class="w-full p-2 border rounded text-xs mb-2 font-bold"><option value="FON">FON</option><option value="JDG">JDG</option><option value="PDG">PDG</option><option value="FIN">FIN</option></select>
            <div class="grid grid-cols-2 gap-2 mb-2"><input type="number" id="modInpLat" placeholder="Lat" class="p-2 border rounded text-xs font-mono" step="0.0001"><input type="number" id="modInpLon" placeholder="Lon" class="p-2 border rounded text-xs font-mono" step="0.0001"></div>
            <div class="flex gap-2 mb-3"><input type="number" id="modInpRadius" placeholder="MMA (m)" class="flex-1 p-2 border rounded text-xs" value="100"><button onclick="useCurrentPosForModal()" class="bg-slate-100 p-2 rounded border text-xs" title="Hier"><i class="fa-solid fa-crosshairs"></i></button></div>
            <div class="flex gap-2"><button onclick="closeLiveAddModal()" class="flex-1 py-2 text-xs text-slate-500 border rounded">Abbrechen</button><button onclick="addTaskFromModal()" class="flex-1 py-2 text-xs bg-blue-600 text-white rounded font-bold shadow">Hinzufügen</button></div>
        </div>
    </div>

    <!-- TASK INFO MODAL -->
    <div id="taskInfoModal" class="hidden fixed inset-0 info-modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full max-h-[80vh] flex flex-col">
            <div class="p-4 bg-slate-100 border-b flex justify-between items-center"><h3 class="font-bold text-slate-800" id="infoTaskTitle">Regelwerk</h3><button onclick="closeTaskInfo()"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="p-4 overflow-y-auto text-xs text-slate-600 leading-relaxed" id="infoTaskContent"></div>
            <div class="p-3 border-t bg-slate-50 text-right"><button onclick="closeTaskInfo()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold text-xs">OK</button></div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const EDRY_POS = { lat: 49.3015, lng: 8.4485 };
        const TASK_RULES_DATA = {
            "PDG": "<b>15.1 Pilot Declared Goal</b><br>Ziel muss deklariert werden. Es zählt der Abstand des Markers zur letzten Deklaration.",
            "JDG": "<b>15.2 Judge Declared Goal</b><br>Ziel wird vorgegeben. Messung physical Marker vor Logger Mark.",
            "HWZ": "<b>15.3 Hesitation Waltz</b><br>Auswahl mehrerer Ziele. Es zählt der Abstand zum nächsten Ziel.",
            "FIN": "<b>15.4 Fly In</b><br>Einflug in einen Radius.",
            "FON": "<b>15.5 Fly On</b><br>Zielwahl in der Luft.",
            "3DT": "<b>15.20 3D Shape Task</b><br>Track innerhalb einer 3D-Geometrie.",
            "HNH": "<b>15.6 Hare and Hounds</b><br>Verfolgung des Hasen. Zielkoordinaten nach Landung.",
            "WSD": "<b>15.7 Watership Down</b><br>Wie HNH, aber Markerabwurf in Zielnähe.",
            "GBM": "<b>15.8 Gordon Bennett</b><br>Zielgebiet treffen. Scoring Areas beachten.",
            "CRT": "<b>15.9 Calculated Rate</b><br>Zeitfenster beachten.",
            "ELB": "<b>15.11 Elbow</b><br>Richtungsänderung.",
            "LRN": "<b>15.12 Land Run</b><br>Dreiecksfläche.",
            "MDD": "<b>15.15 Min Double Drop</b><br>Min. Abstand zweier Marker.",
            "XDD": "<b>15.18 Max Double Drop</b><br>Max. Abstand zweier Marker.",
            "ANG": "<b>15.19 Angle</b><br>Winkelvorgabe einhalten."
        };

        // --- GLOBAL STATE ---
        let map, currentMarker, polylineTrack, polylineTask, polylineTrajectory, forecastMarker;
        let tasks = [], activeTaskIdx = -1, savedFlights = [], briefings = [], activeBriefing = null;
        let currentPos = { ...EDRY_POS, alt: 200, head: 0, speed: 0 };
        let windProfile = {}, config = { minDistance: 50, minHeadingChange: 5, lookAhead: 0, forecastMinutes: 5 };
        let isFlightActive = false, currentFlight = { id: null, start: null, track: [], tasksSnapshot: [], markers: [] };
        let kmlLayers = {}, baseLayers = {}, isSimulating = false, simInterval = null;
        let simBurnerActive = false, simVentActive = false, isCockpitCollapsed = false;
        let tempBriefingTasks = [], editingTaskIndex = -1;

        // --- MATH HELPERS ---
        function getDistanceM(la1, lo1, la2, lo2) {
            const R = 6371e3, dφ = (la2-la1)*Math.PI/180, dλ = (lo2-lo1)*Math.PI/180;
            const a = Math.sin(dφ/2)**2 + Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dλ/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function getBearing(la1, lo1, la2, lo2) {
            const y = Math.sin((lo2-lo1)*Math.PI/180)*Math.cos(la2*Math.PI/180);
            const x = Math.cos(la1*Math.PI/180)*Math.sin(la2*Math.PI/180)-Math.sin(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.cos((lo2-lo1)*Math.PI/180);
            return (Math.atan2(y, x)*180/Math.PI + 360) % 360;
        }
        function projectPoint(la, lo, d, b) {
            const R = 6371e3, φ = la*Math.PI/180, λ = lo*Math.PI/180, br = b*Math.PI/180;
            const φ2 = Math.asin(Math.sin(φ)*Math.cos(d/R) + Math.cos(φ)*Math.sin(d/R)*Math.cos(br));
            const λ2 = λ + Math.atan2(Math.sin(br)*Math.sin(d/R)*Math.cos(φ), Math.cos(d/R)-Math.sin(φ)*Math.sin(φ2));
            return { lat: φ2*180/Math.PI, lng: λ2*180/Math.PI };
        }

        // --- INIT ---
        window.onload = function() {
            initMap();
            generateSyntheticWind();
            renderBriefingList();
            renderFlightList();
            setInterval(checkBriefingTimes, 1000);
        };

        function initMap() {
            map = L.map('map-container', { zoomControl: false, attributionControl: false }).setView([EDRY_POS.lat, EDRY_POS.lng], 15);
            baseLayers.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
            baseLayers.sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 18 });
            
            polylineTrack = L.polyline([], { color: '#ef4444', weight: 4, opacity: 0.7 }).addTo(map);
            polylineTask = L.polyline([], { color: '#2563eb', weight: 2, dashArray: '10, 10' }).addTo(map);
            polylineTrajectory = L.polyline([], { color: '#22c55e', weight: 3, dashArray: '5, 5' }).addTo(map);
            
            map.on('click', (e) => {
                const lat = e.latlng.lat.toFixed(5), lon = e.latlng.lng.toFixed(5);
                ['inpLat','brfTaskLat','modInpLat'].forEach(id => { const el = document.getElementById(id); if(el) el.value = lat; });
                ['inpLon','brfTaskLon','modInpLon'].forEach(id => { const el = document.getElementById(id); if(el) el.value = lon; });
            });
            updatePlaneMarker();
        }

        function toggleMapSettings() { document.getElementById('mapSettingsPanel').classList.toggle('hidden'); }
        function setMapStyle(style) { map.removeLayer(baseLayers.osm); map.removeLayer(baseLayers.sat); baseLayers[style].addTo(map); 
            document.getElementById('btnStyleOsm').className = style==='osm' ? "flex-1 text-[10px] py-1 rounded bg-white shadow-sm font-bold text-blue-600" : "flex-1 text-[10px] py-1 rounded text-slate-500";
            document.getElementById('btnStyleSat').className = style==='sat' ? "flex-1 text-[10px] py-1 rounded bg-white shadow-sm font-bold text-blue-600" : "flex-1 text-[10px] py-1 rounded text-slate-500";
        }
        function setTrajectory(min) {
            config.forecastMinutes = min;
            [0,5,10,15].forEach(m => {
                const btn = document.getElementById(`traj${m}`);
                if(m === min) btn.className = "text-[9px] py-1 rounded bg-blue-600 text-white border border-blue-600 font-bold";
                else btn.className = "text-[9px] py-1 rounded bg-slate-100 border hover:bg-slate-200";
            });
            handleGpsUpdate(currentPos);
        }

        // --- KML & STYLING ---
        function handleKmlUpload() {
            const files = document.getElementById('kmlFileInput').files;
            if(!files.length) return;
            for(let file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const layer = omnivore.kml.parse(e.target.result, null, L.geoJson(null, {
                        style: (f) => {
                            const name = f.properties.name || "";
                            if (/ED-?R\d+/i.test(name) && !name.toUpperCase().includes("EDRY")) return { color:'red', fillColor:'red', fillOpacity:0.3, weight:2 };
                            return { color:'#3b82f6', weight:2, fillOpacity:0.1 };
                        },
                        onEachFeature: (f, l) => {
                            if (f.properties) {
                                const p = f.properties;
                                let html = `<div class="font-bold border-b pb-1 mb-1 text-sm text-blue-800">${p.name || 'Luftraum'}</div>`;
                                html += `<table class="kml-popup-table">`;
                                ['IDENT', 'NAM', 'UPPERLIMIT', 'LOWERLIMIT'].forEach(key => {
                                    if(p[key]) html += `<tr><td class="kml-popup-label">${key}</td><td class="kml-popup-value">${p[key]}</td></tr>`;
                                });
                                html += `</table>`;
                                layer.bindPopup(html);
                            }
                        }
                    }));
                    layer.addTo(map);
                    kmlLayers[file.name] = layer;
                    renderKmlList();
                };
                reader.readAsText(file);
            }
        }
        function renderKmlList() {
            const cont = document.getElementById('kmlList'); if(!cont) return; cont.innerHTML = "";
            const quickCont = document.getElementById('quickKmlList');
            let html = "";
            Object.keys(kmlLayers).forEach(name => {
                const isVisible = map.hasLayer(kmlLayers[name]);
                html += `<div class="flex justify-between items-center text-[10px] bg-white p-1 px-2 rounded border"><span class="truncate w-32">${name}</span><div class="flex gap-2"><button onclick="toggleKml('${name}')" class="${isVisible?'text-blue-600':'text-slate-400'}"><i class="fa-solid fa-eye"></i></button><button onclick="removeKml('${name}')" class="text-red-400"><i class="fa-solid fa-trash"></i></button></div></div>`;
            });
            cont.innerHTML = html;
            if(quickCont) quickCont.innerHTML = html || '<div class="text-[9px] italic text-slate-400">Keine KMLs geladen</div>';
        }
        function toggleKml(name) { if(map.hasLayer(kmlLayers[name])) map.removeLayer(kmlLayers[name]); else kmlLayers[name].addTo(map); renderKmlList(); }
        function removeKml(name) { map.removeLayer(kmlLayers[name]); delete kmlLayers[name]; renderKmlList(); }
        function changeMapStyle() { const s = document.getElementById('mapStyle').value; map.removeLayer(baseLayers.osm); map.removeLayer(baseLayers.sat); baseLayers[s].addTo(map); }

        // --- FLIGHT LOGIC ---
        function toggleFlight() {
            const btn = document.getElementById('btnFlightToggle');
            if (!isFlightActive) {
                if (activeBriefing && activeBriefing.startTime) {
                    const nowStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    if (nowStr < activeBriefing.startTime && !confirm(`ACHTUNG: Startperiode beginnt erst um ${activeBriefing.startTime}. Vorzeitig starten?`)) return;
                }
                isFlightActive = true;
                currentFlight = { id: Date.now(), start: new Date().toISOString(), track: [], tasksSnapshot: [], markers: [] };
                btn.className = "w-full py-4 rounded-xl font-black text-lg text-white bg-red-600 shadow-lg";
                btn.innerHTML = `<span>LANDUNG</span>`;
                document.getElementById('liveFormCard').classList.add('hidden');
                document.getElementById('liveTaskCard').classList.remove('hidden');
                if(!isSimulating) navigator.geolocation.watchPosition(pos => handleGpsUpdate(pos.coords), null, {enableHighAccuracy:true});
            } else {
                if(!confirm("Fahrt beenden?")) return;
                isFlightActive = false;
                savedFlights.unshift({ ...currentFlight, tasksSnapshot: JSON.parse(JSON.stringify(tasks)) }); 
                renderFlightList();
                btn.className = "w-full py-4 rounded-xl font-black text-lg text-white bg-green-500 shadow-lg pulse-ring";
                btn.innerHTML = `<span>START</span>`;
                document.getElementById('liveFormCard').classList.remove('hidden');
                document.getElementById('liveTaskCard').classList.add('hidden');
                switchTab('tab-archive');
            }
        }

        function handleGpsUpdate(coords) {
            currentPos = { lat: coords.latitude, lng: coords.longitude, alt: coords.altitude||0, speed: (coords.speed||0)*3.6, head: coords.heading||0 };
            document.getElementById('valSpeed').innerText = Math.round(currentPos.speed);
            document.getElementById('valAlt').innerText = Math.round(currentPos.alt);
            document.getElementById('valTrack').innerText = Math.round(currentPos.head) + "°";
            
            updatePlaneMarker(); calculateNav(); updateWindHud(); centerMap();
            
            // Trajectory
            if (config.forecastMinutes > 0 && currentPos.speed > 5) {
                const dist = (currentPos.speed / 3.6) * (config.forecastMinutes * 60);
                const endPt = projectPoint(currentPos.lat, currentPos.lng, dist, currentPos.head);
                polylineTrajectory.setLatLngs([[currentPos.lat, currentPos.lng], [endPt.lat, endPt.lng]]);
                if(!forecastMarker) {
                    forecastMarker = L.marker([endPt.lat, endPt.lng], {icon: L.divIcon({html:`<div class="bg-green-500 text-white text-[8px] px-1 rounded font-bold">+${config.forecastMinutes}'</div>`, className:'bg-transparent'})}).addTo(map);
                } else {
                    forecastMarker.setLatLng([endPt.lat, endPt.lng]);
                    forecastMarker.setIcon(L.divIcon({html:`<div class="bg-green-500 text-white text-[8px] px-1 rounded font-bold">+${config.forecastMinutes}'</div>`, className:'bg-transparent'}));
                }
            } else {
                polylineTrajectory.setLatLngs([]);
                if(forecastMarker) { map.removeLayer(forecastMarker); forecastMarker = null; }
            }

            if(isFlightActive) {
                currentFlight.track.push({ ...currentPos, time: new Date().toISOString() });
                polylineTrack.addLatLng([currentPos.lat, currentPos.lng]);
                const b = Math.floor(currentPos.alt/50)*50;
                if(!windProfile[b]) windProfile[b] = { sumSin:0, sumCos:0, sumSpd:0, count:0 };
                const r = currentPos.head*Math.PI/180;
                windProfile[b].sumSin += Math.sin(r); windProfile[b].sumCos += Math.cos(r); windProfile[b].sumSpd += currentPos.speed; windProfile[b].count++;
                updateWindHud();
            }
        }

        function calculateNav() {
            if(activeTaskIdx === -1 || !tasks[activeTaskIdx] || tasks[activeTaskIdx].completed) {
                document.getElementById('navOverlay').classList.add('hidden');
                document.getElementById('navInstruction').innerText = "Bereit"; return;
            }
            const t = tasks[activeTaskIdx];
            const d = getDistanceM(currentPos.lat, currentPos.lng, t.lat, t.lng);
            const b = getBearing(currentPos.lat, currentPos.lng, t.lat, t.lng);
            document.getElementById('valBrg').innerText = Math.round(b) + "°";
            document.getElementById('overlayDist').innerText = d < 1000 ? Math.round(d) + " m" : (d/1000).toFixed(2) + " km";
            document.getElementById('overlayWpName').innerText = t.title;
            document.getElementById('navOverlay').classList.remove('hidden');
            
            document.getElementById('liveTaskType').innerText = t.type;
            document.getElementById('liveTaskName').innerText = t.title;
            document.getElementById('liveTaskDist').innerText = Math.round(d) + " m";
            document.getElementById('liveTaskBrg').innerText = Math.round(b) + "°";
            
            let diff = b - currentPos.head; while(diff < -180) diff += 360; while(diff > 180) diff -= 360;
            const instr = document.getElementById('navInstruction');
            if(Math.abs(diff) < 4) instr.innerText = "KURS OK"; else instr.innerHTML = `<i class="fa-solid ${diff>0?'fa-arrow-right':'fa-arrow-left'}"></i> ${diff>0?'R':'L'} ${Math.round(Math.abs(diff))}°`;
        }

        // --- RENDER FUNCTIONS ---
        function renderTasks() {
            const list = document.getElementById('taskList'); if(!list) return;
            list.innerHTML = "";
            tasks.forEach((t, i) => {
                const active = i === activeTaskIdx;
                const li = document.createElement('li');
                li.className = `p-2 rounded border flex justify-between items-center ${i===activeTaskIdx?'bg-blue-100 border-blue-300':'bg-white shadow-sm'}`;
                li.innerHTML = `<span>${t.title} (${t.type})</span><button class="bg-blue-600 text-white w-6 h-6 rounded" onclick="selectTask(${i})"><i class="fa-solid fa-play text-[10px]"></i></button>`;
                list.appendChild(li);
            });
            document.getElementById('taskBadge').innerText = tasks.filter(x => !x.completed).length;
        }

        function drawTaskVisuals() {
            map.eachLayer(l => { if(l.options && l.options.isTaskLayer) map.removeLayer(l); });
            tasks.forEach((t, i) => {
                const color = i === activeTaskIdx ? '#2563eb' : (t.completed ? '#cbd5e1' : '#94a3b8');
                L.marker([t.lat, t.lng], { isTaskLayer: true, icon: L.divIcon({ html: `<div class="rounded-full bg-white border-2 border-blue-600 text-[10px] flex items-center justify-center font-bold w-5 h-5">${i+1}</div>`, className:'' }) }).addTo(map);
                if(t.radius > 0) L.circle([t.lat, t.lng], { radius: t.radius, color, fillOpacity: 0.05, isTaskLayer: true }).addTo(map);
            });
        }

        function updateWindHud() {
            const hud = document.getElementById('windHudContent'); if(!hud) return; hud.innerHTML = "";
            const tbody = document.getElementById('windTableBody'); if(tbody) tbody.innerHTML = "";
            const sorted = Object.keys(windProfile).map(Number).sort((a,b)=>b-a);
            document.getElementById('windHudCount').innerText = sorted.length;
            sorted.forEach(h => {
                const d = windProfile[h]; const dir = Math.round((Math.atan2(d.sumSin, d.sumCos)*180/Math.PI+360)%360);
                const spd = Math.round(d.sumSpd/d.count);
                const isCurrent = Math.abs(currentPos.alt - h) < 25;
                hud.innerHTML += `<div class="flex justify-between items-center px-1 rounded ${isCurrent?'bg-blue-500 text-white font-bold':'text-slate-300'}"><span>${h}m</span><span style="transform:rotate(${dir-180}deg)"><i class="fa-solid fa-arrow-down text-[8px]"></i></span><span>${dir}°</span></div>`;
                if(tbody) tbody.innerHTML += `<tr><td class="p-1">${h}m</td><td class="p-1">${dir}°</td><td class="p-1">${spd} km/h</td></tr>`;
            });
        }

        function renderFlightList() {
            const cont = document.getElementById('flightList'); if(!cont) return;
            cont.innerHTML = savedFlights.length ? "" : '<div class="text-center italic text-xs py-4 text-slate-400">Keine Fahrten im Archiv</div>';
            savedFlights.forEach(f => {
                const div = document.createElement('div'); div.className = "bg-white p-2 rounded border shadow-sm mb-2";
                div.innerHTML = `<div class="text-[10px] font-bold">${new Date(f.start).toLocaleString()}</div><button class="bg-blue-600 text-white px-2 py-1 rounded text-[9px] mt-1" onclick="alert('Export...')">GPX</button>`;
                cont.appendChild(div);
            });
        }

        function renderBriefingList() {
            const cont = document.getElementById('briefingList'); if(!cont) return;
            cont.innerHTML = briefings.length ? "" : '<div class="text-[10px] text-slate-400 italic text-center p-4 border border-dashed rounded">Keine Planungen</div>';
            briefings.forEach((b, idx) => {
                const div = document.createElement('div'); div.className = "bg-white p-3 rounded border flex justify-between items-center shadow-sm";
                div.innerHTML = `<div><div class="font-bold text-sm text-slate-800">${b.name}</div><div class="text-[10px] text-slate-500">${b.tasks.length} Aufgaben</div></div><button class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold" onclick="activateBriefing(${idx})">Laden</button>`;
                cont.appendChild(div);
            });
        }

        // --- SIMULATION ---
        function toggleSimulation() { isSimulating = !isSimulating; document.getElementById('simIndicator').classList.toggle('hidden', !isSimulating); document.getElementById('simOverlayControls').classList.toggle('hidden', !isSimulating); if(isSimulating) simInterval=setInterval(() => { handleGpsUpdate({latitude:currentPos.lat+0.0001, longitude:currentPos.lng+0.0001, altitude:currentPos.alt, speed:5, heading:45}); }, 1000); else clearInterval(simInterval); }
        function startBurn() { simBurnerActive = true; } function stopBurn() { simBurnerActive = false; } function startVent() { simVentActive = true; } function stopVent() { simVentActive = false; }
        
        // --- UI HELPERS ---
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function switchSubTab(tab) { document.getElementById('view-live').classList.toggle('hidden', tab!=='live'); document.getElementById('view-plan').classList.toggle('hidden', tab!=='plan'); }
        function toggleMenu() { document.getElementById('sideMenu').classList.toggle('translate-x-full'); }
        function toggleWindHud() { document.getElementById('windHud').classList.toggle('hidden'); }
        function centerMap(force=false) { 
            let target = [currentPos.lat, currentPos.lng];
            if(config.forecastMinutes > 0 && currentPos.speed > 2) {
                const dist = (currentPos.speed/3.6) * (config.forecastMinutes * 30); 
                const pt = projectPoint(currentPos.lat, currentPos.lng, dist, currentPos.head);
                target = [pt.lat, pt.lng];
            }
            map.setView(target, map.getZoom()); 
        }
        function safeSetText(id, txt) { const el = document.getElementById(id); if(el) el.innerText = txt; }
        
        // --- UI ACTIONS ---
        function updatePlaneMarker() { const icon = L.divIcon({ html: `<svg width="30" height="30" style="transform:rotate(${currentPos.head-45}deg)"><path d="M15 2 L28 28 L15 22 L2 28 Z" fill="${isSimulating?'orange':'blue'}" stroke="white" stroke-width="2"/></svg>`, className:'bg-transparent', iconSize:[30,30] }); if(!currentMarker) currentMarker = L.marker([currentPos.lat, currentPos.lng], {icon}).addTo(map); else currentMarker.setLatLng([currentPos.lat, currentPos.lng]).setIcon(icon); }
        function generateSyntheticWind() { for(let h=0; h<=1000; h+=50) windProfile[h] = { sumSin:Math.sin(h/100), sumCos:Math.cos(h/100), sumSpd:12+h/100, count:1 }; updateWindHud(); }
        function deactivateBriefing() { activeBriefing = null; document.getElementById('briefingIndicator').classList.add('hidden'); }
        function activateBriefing(idx) { activeBriefing = briefings[idx]; tasks = JSON.parse(JSON.stringify(activeBriefing.tasks)); activeTaskIdx = 0; renderTasks(); drawTaskVisuals(); calculateNav(); document.getElementById('briefingIndicator').classList.remove('hidden'); switchSubTab('live'); }
        function editBriefing(idx) { document.getElementById('briefingEditor').classList.remove('hidden'); tempBriefingTasks = []; if(idx===-1) document.getElementById('brfName').value = ""; renderBriefingTemp(); }
        function closeBriefingEditor() { document.getElementById('briefingEditor').classList.add('hidden'); }
        function addOrUpdateBriefingTask() { const lat = parseFloat(document.getElementById('brfTaskLat').value); if(isNaN(lat)) return; tempBriefingTasks.push({ title: document.getElementById('brfTaskTitle').value||"T", type: document.getElementById('brfTaskType').value, lat, lng: parseFloat(document.getElementById('brfTaskLon').value), radius: parseInt(document.getElementById('brfTaskRad').value)||100 }); renderBriefingTemp(); }
        function renderBriefingTemp() { document.getElementById('brfTaskList').innerHTML = tempBriefingTasks.map(t => `<li>${t.title} (${t.type})</li>`).join(''); }
        function cancelTaskEdit() {}
        function saveBriefing() { briefings.push({ name: document.getElementById('brfName').value||"Plan", tasks: [...tempBriefingTasks], startTime: document.getElementById('brfStart').value }); closeBriefingEditor(); renderBriefingList(); }
        function updateConfigUI() { config.minDistance = parseInt(document.getElementById('cfgDist').value); document.getElementById('lblDist').innerText = config.minDistance + "m"; }
        function resetSimToSpeyer() { currentPos = { ...EDRY_POS, alt:200, head:0, speed:0 }; handleGpsUpdate(currentPos); map.setView([EDRY_POS.lat, EDRY_POS.lng], 15); }
        function updateTaskInputs() { const type = document.getElementById('taskType').value; const inpR2 = document.getElementById('inpRadius2'); if(inpR2) inpR2.classList.toggle('hidden', type!=='3DT'); }
        function openLiveAddModal() { document.getElementById('liveAddTaskModal').classList.remove('hidden'); }
        function closeLiveAddModal() { document.getElementById('liveAddTaskModal').classList.add('hidden'); }
        function addTaskFromModal() { const lat = parseFloat(document.getElementById('modInpLat').value); if(isNaN(lat)) return; tasks.push({ title: document.getElementById('modInpTitle').value||"S", lat, lng: parseFloat(document.getElementById('modInpLon').value), type: document.getElementById('modTaskType').value, completed: false, radius: 100 }); renderTasks(); drawTaskVisuals(); closeLiveAddModal(); }
        function dropMarker() { L.marker([currentPos.lat, currentPos.lng], { icon: L.divIcon({ html:'<i class="fa-solid fa-times text-red-600 font-bold text-lg"></i>', className:''})}).addTo(map); }
        function checkBriefingTimes() {} // Timer logic
        function showActiveTaskInfo() { if(activeTaskIdx>=0) showTaskInfoModal(tasks[activeTaskIdx].type); }
        function showTaskInfo() { showTaskInfoModal(document.getElementById('taskType').value); }
        function showTaskInfoModal(type) { document.getElementById('infoTaskContent').innerHTML = TASK_RULES_DATA[type] || "Keine Info verfügbar."; document.getElementById('taskInfoModal').classList.remove('hidden'); }
        function closeTaskInfo() { document.getElementById('taskInfoModal').classList.add('hidden'); }
        function useCurrentPosAsGoal() { document.getElementById('inpLat').value = currentPos.lat.toFixed(5); document.getElementById('inpLon').value = currentPos.lng.toFixed(5); }
        function useCurrentPosForModal() { document.getElementById('modInpLat').value = currentPos.lat.toFixed(5); document.getElementById('modInpLon').value = currentPos.lng.toFixed(5); }
        function exportGpx(id) { alert("Export..."); }
        function toggleCockpit() {
            const cp = document.getElementById('cockpit');
            const chevron = document.getElementById('cockpitChevron');
            isCockpitCollapsed = !isCockpitCollapsed;
            cp.classList.toggle('cockpit-collapsed', isCockpitCollapsed);
            chevron.style.transform = isCockpitCollapsed ? 'rotate(180deg)' : 'rotate(0deg)';
            setTimeout(() => { map.invalidateSize(); centerMap(true); }, 400);
        }
    </script>
</body>
</html>
