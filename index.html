<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AeroNav - Ballon Tracker Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background: #f0fdf4; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255,255,255,0.5);
        }

        #instruments {
            position: absolute; top: 10px; left: 10px; right: 10px;
            z-index: 1000; display: flex; justify-content: space-between; gap: 5px;
        }

        .instrument-box { flex: 1; text-align: center; padding: 8px; }
        .value { font-size: 1.2rem; font-weight: 800; color: #1e3a8a; }
        .label { font-size: 0.6rem; color: #64748b; text-transform: uppercase; }

        #error-overlay {
            position: absolute; top: 70px; left: 10px; right: 10px;
            z-index: 1100; display: none;
        }

        #nav-indicator {
            position: absolute; bottom: 100px; left: 10px; right: 10px;
            z-index: 1000; display: none;
        }

        #controls {
            position: absolute; bottom: 20px; left: 10px; right: 10px;
            z-index: 1000; display: flex; flex-direction: column; gap: 10px;
        }

        .btn-large {
            padding: 15px; border-radius: 50px; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .btn-large:active { transform: scale(0.98); }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; width: 95%; max-width: 450px; max-height: 90vh;
            overflow-y: auto; padding: 20px; border-radius: 20px;
        }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 0.75rem; font-weight: bold; color: #475569; margin-bottom: 4px; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem;
        }

        @keyframes pulse-red {
            0% { background-color: #ef4444; }
            50% { background-color: #991b1b; }
            100% { background-color: #ef4444; }
        }
        .pulse-error { animation: pulse-red 2s infinite; }

        .ai-shimmer {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .nav-arrow { font-size: 2rem; transition: transform 0.3s; }
    </style>
</head>
<body>

    <!-- Cockpit -->
    <div id="instruments" class="pointer-events-none">
        <div class="glass-panel instrument-box pointer-events-auto">
            <div class="value" id="disp-alt">0</div>
            <div class="label">m</div>
        </div>
        <div class="glass-panel instrument-box pointer-events-auto">
            <div class="value" id="disp-speed">0</div>
            <div class="label">km/h</div>
        </div>
        <div class="glass-panel instrument-box pointer-events-auto">
            <div class="value" id="disp-heading">---</div>
            <div class="label">Kurs</div>
        </div>
        <div class="glass-panel instrument-box pointer-events-auto">
            <div class="value" id="disp-climb">0.0</div>
            <div class="label">Vario</div>
        </div>
    </div>

    <!-- KI Navigations-Indikator -->
    <div id="nav-indicator" class="pointer-events-none">
        <div class="glass-panel p-4 flex items-center gap-4 border-l-4 border-indigo-600">
            <div id="nav-arrow-box" class="flex flex-col items-center">
                <i id="nav-icon" class="fa-solid fa-arrow-up nav-arrow text-indigo-600"></i>
                <span id="nav-alt-target" class="text-[10px] font-bold text-indigo-900 mt-1">HÖHE</span>
            </div>
            <div class="flex-1">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs font-bold text-indigo-900">✨ KI-NAVIGATOR</span>
                    <span id="nav-dist" class="text-[10px] font-bold text-slate-500">0.0 km</span>
                </div>
                <p id="nav-text" class="text-xs text-slate-700 leading-tight">Berechne besten Kurs zum Ziel...</p>
            </div>
            <button onclick="clearWaypoint()" class="pointer-events-auto bg-slate-100 p-2 rounded-full text-slate-400">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
    </div>

    <!-- KI Wetter-Widget (Schwebend) -->
    <div id="ai-weather-info" class="absolute top-24 left-3 right-3 z-[1001] hidden">
        <div class="glass-panel p-3 border-l-4 border-purple-500">
            <div class="flex items-center gap-2 mb-1">
                <span class="text-xs font-bold text-purple-700">✨ KI-WETTERCHECK</span>
                <div id="ai-weather-loading" class="hidden h-1 w-12 ai-shimmer rounded"></div>
            </div>
            <p id="ai-weather-text" class="text-[11px] text-gray-700 italic leading-tight">Analysiere Bedingungen...</p>
        </div>
    </div>

    <!-- Error/Status Overlay -->
    <div id="error-overlay" class="pulse-error text-white p-3 rounded-xl shadow-lg flex items-center gap-3">
        <i class="fa-solid fa-triangle-exclamation text-xl"></i>
        <div class="flex-1">
            <div class="font-bold text-sm" id="error-title">GPS Signal verloren</div>
            <div class="text-[10px] opacity-90" id="error-desc">Suche nach Position...</div>
        </div>
        <button onclick="retryGPS()" class="bg-white/20 px-3 py-1 rounded-lg text-xs font-bold">Retry</button>
    </div>

    <div id="map"></div>

    <!-- Hauptsteuerung -->
    <div id="controls" class="pointer-events-none">
        <div class="flex gap-2 pointer-events-auto">
            <button id="btn-toggle" onclick="toggleRecording()" class="btn-large flex-1 bg-green-600 text-white flex items-center justify-center gap-2">
                <i class="fa-solid fa-play"></i> <span id="btn-text">Fahrt starten</span>
            </button>
            <button onclick="openMenu()" class="btn-large bg-white text-indigo-600 w-16 flex items-center justify-center border-2 border-indigo-100">
                <i class="fa-solid fa-bars-staggered"></i>
            </button>
        </div>
    </div>

    <!-- Modal: Flug speichern -->
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-indigo-900">Fahrt abschließen</h2>
            
            <div class="grid grid-cols-2 gap-2">
                <div class="form-group">
                    <label>Fahrt-Name</label>
                    <input type="text" id="save-name">
                </div>
                <div class="form-group">
                    <label>Ballon (Reg)</label>
                    <input type="text" id="save-reg" placeholder="z.B. D-OXYZ">
                </div>
            </div>

            <div class="form-group">
                <label>Notizen & ✨ KI-Logbuch</label>
                <div class="relative">
                    <textarea id="save-notes" rows="4" placeholder="Startplatz, Landung, Besonderheiten..."></textarea>
                    <button onclick="generateAIRepo()" id="btn-ai-repo" class="absolute bottom-2 right-2 bg-purple-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-lg flex items-center gap-1">
                        ✨ Bericht
                    </button>
                </div>
            </div>

            <div id="ai-repo-loader" class="hidden mb-4 p-3 bg-purple-50 rounded-xl text-center">
                <div class="ai-shimmer h-4 w-3/4 mx-auto rounded mb-2"></div>
                <span class="text-[10px] text-purple-600 font-bold uppercase tracking-wider">Erstelle KI-Analyse...</span>
            </div>

            <div id="save-error" class="hidden text-red-600 text-xs font-bold mb-4 bg-red-50 p-2 rounded-lg"></div>

            <div class="bg-indigo-50 p-3 rounded-lg mb-4 text-xs text-indigo-800 flex justify-between">
                <span>Max: <b id="stat-max-alt">0</b>m</span>
                <span>Zeit: <b id="stat-duration">0</b> min</span>
                <span>Track: <b id="stat-points">0</b> Pkt</span>
            </div>

            <div class="flex gap-2">
                <button onclick="confirmSave()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">Speichern</button>
                <button onclick="closeSaveModal()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Logbuch Menü -->
    <div id="menu-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Logbuch & Historie</h2>
                <button onclick="closeMenu()" class="text-gray-400 p-2"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div id="saved-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>

            <div class="mt-6 pt-4 border-t space-y-2">
                <button onclick="toggleSimulation()" id="sim-btn" class="w-full py-3 px-4 rounded-xl bg-purple-50 text-purple-700 font-bold text-sm flex items-center justify-between">
                    <span><i class="fa-solid fa-robot mr-2"></i> Demo-Modus</span>
                    <i class="fa-solid fa-play"></i>
                </button>
                <button onclick="closeMenu()" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold">Schließen</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const apiKey = ""; 
        const state = {
            recording: false,
            track: [],
            lastPosTime: null,
            watchId: null,
            maxAlt: 0,
            currentAlt: 0,
            currentPos: null,
            startTime: null,
            simulationId: null,
            wakeLock: null,
            lastAIWeatherUpdate: 0,
            lastAINavUpdate: 0,
            waypoint: null,
            waypointMarker: null,
            windLibrary: {} // Struktur: { "100m": {speed, heading}, "200m": ... }
        };

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([51.1657, 10.4515], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const trackLine = L.polyline([], { color: '#4f46e5', weight: 4, opacity: 0.8 }).addTo(map);
        const marker = L.circleMarker([0,0], { radius: 8, color: 'white', fillColor: '#4f46e5', fillOpacity: 1, weight: 2 }).addTo(map);

        // --- MAP INTERACTION (WAYPOINT SETTING) ---
        map.on('contextmenu', function(e) {
            setWaypoint(e.latlng);
        });

        function setWaypoint(latlng) {
            if (state.waypointMarker) map.removeLayer(state.waypointMarker);
            state.waypoint = latlng;
            state.waypointMarker = L.marker(latlng, {
                icon: L.divIcon({
                    html: '<i class="fa-solid fa-location-crosshairs text-indigo-600 text-3xl" style="margin-top:-15px; margin-left:-10px"></i>',
                    className: 'custom-div-icon'
                })
            }).addTo(map);
            document.getElementById('nav-indicator').style.display = 'block';
            updateAINavigation();
        }

        function clearWaypoint() {
            if (state.waypointMarker) map.removeLayer(state.waypointMarker);
            state.waypoint = null;
            state.waypointMarker = null;
            document.getElementById('nav-indicator').style.display = 'none';
        }

        // --- GEMINI API INTEGRATION ---

        async function callGemini(prompt, systemPrompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            let retries = 0;
            const delays = [1000, 2000, 4000];

            while (retries < 3) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (err) {
                    await new Promise(r => setTimeout(r, delays[retries]));
                    retries++;
                }
            }
            throw new Error("KI offline");
        }

        async function updateAINavigation() {
            if (!state.waypoint || !state.currentPos) return;
            if (Date.now() - state.lastAINavUpdate < 15000) return; // Update alle 15 Sek

            const dist = (map.distance(state.currentPos, state.waypoint) / 1000).toFixed(1);
            document.getElementById('nav-dist').innerText = `${dist} km`;

            try {
                const windProfileStr = Object.entries(state.windLibrary)
                    .map(([h, w]) => `Höhe ${h}: ${w.heading}°/${w.speed}kmh`)
                    .join(', ');

                const systemPrompt = "Du bist ein KI-Ballon-Navigator. Analysiere das Windprofil und gib EINE Handlungsanweisung (max 10 Wörter), um den Waypoint zu erreichen. Antworte in Deutsch. Gib NUR die Anweisung zurück. Benutze Begriffe wie 'Steigen auf...', 'Sinken auf...', 'Höhe halten'.";
                const prompt = `Aktuelle Position: ${state.currentPos.lat}, ${state.currentPos.lng}. Ziel: ${state.waypoint.lat}, ${state.waypoint.lng}. Aktuelle Höhe: ${state.currentAlt}m. Bekannte Winde: ${windProfileStr || 'Keine Daten vorhanden'}.`;
                
                const instruction = await callGemini(prompt, systemPrompt);
                
                document.getElementById('nav-text').innerText = instruction;
                
                // Pfeil-Logik basierend auf Text (einfacher Parser)
                const lower = instruction.toLowerCase();
                const icon = document.getElementById('nav-icon');
                if (lower.includes("steigen")) icon.className = "fa-solid fa-arrow-up nav-arrow text-green-600";
                else if (lower.includes("sinken")) icon.className = "fa-solid fa-arrow-down nav-arrow text-red-600";
                else icon.className = "fa-solid fa-arrow-right nav-arrow text-indigo-600";

                state.lastAINavUpdate = Date.now();
            } catch (e) {
                console.error("Nav-AI Error", e);
            }
        }

        async function checkAIWeather(lat, lng, alt) {
            if (Date.now() - state.lastAIWeatherUpdate < 300000) return;
            document.getElementById('ai-weather-info').style.display = 'block';
            document.getElementById('ai-weather-loading').classList.remove('hidden');
            try {
                const systemPrompt = "Du bist ein Ballonpilot. Gib kurze Sicherheitstipps (max 15 Wörter) für Region/Höhe auf Deutsch.";
                const prompt = `Pos: ${lat}, ${lng}. Alt: ${alt}m. Kurzinfo Wetter/Sicherheit?`;
                const advice = await callGemini(prompt, systemPrompt);
                document.getElementById('ai-weather-text').innerText = advice;
                state.lastAIWeatherUpdate = Date.now();
            } catch (e) {} finally {
                document.getElementById('ai-weather-loading').classList.add('hidden');
            }
        }

        // --- WIND DATA LOGGING ---
        function updateWindLibrary(alt, speed, heading) {
            // Runden auf 100m Intervalle
            const slot = Math.round(alt / 100) * 100 + "m";
            if (speed > 2) { // Nur signifikante Winde speichern
                state.windLibrary[slot] = { speed: Math.round(speed), heading: Math.round(heading) };
            }
        }

        // --- TRACKING LOGIC ---

        function handlePosition(pos) {
            state.lastPosTime = Date.now();
            const { latitude, longitude, altitude, speed, heading } = pos.coords;
            processData(latitude, longitude, altitude || 0, (speed || 0) * 3.6, heading, pos.timestamp);
            
            if (state.recording) {
                checkAIWeather(latitude, longitude, altitude);
                updateAINavigation();
            }
        }

        function processData(lat, lng, alt, speedKmh, heading, time) {
            const climb = state.track.length > 0 ? (alt - state.track[state.track.length-1].alt) : 0;
            
            state.currentAlt = alt;
            state.currentPos = L.latLng(lat, lng);
            if (alt > state.maxAlt) state.maxAlt = alt;
            
            document.getElementById('disp-alt').innerText = Math.round(alt);
            document.getElementById('disp-speed').innerText = Math.round(speedKmh);
            document.getElementById('disp-heading').innerText = heading ? Math.round(heading) + "°" : "---";
            document.getElementById('disp-climb').innerText = climb.toFixed(1);

            if (heading) updateWindLibrary(alt, speedKmh, heading);

            marker.setLatLng([lat, lng]);

            if (state.recording) {
                if (state.track.length > 0) {
                    const last = state.track[state.track.length - 1];
                    if (last.lat === lat && last.lng === lng) return;
                }
                state.track.push({ lat, lng, alt, speedKmh, heading, time });
                trackLine.addLatLng([lat, lng]);
                map.panTo([lat, lng]);
            }
        }

        // --- REST DER APP LOGIK ---

        function toggleRecording() {
            if (!state.recording) {
                if (!state.lastPosTime && !state.simulationId) {
                    alert("Warte auf GPS Signal...");
                    startGPSWatch();
                    return;
                }
                state.recording = true;
                state.startTime = Date.now();
                state.track = [];
                state.maxAlt = 0;
                state.windLibrary = {};
                trackLine.setLatLngs([]);
                requestWakeLock();
                document.getElementById('btn-toggle').className = "btn-large flex-1 bg-red-600 text-white flex items-center justify-center gap-2";
                document.getElementById('btn-text').innerText = "Fahrt stoppen";
                startGPSWatch();
            } else {
                state.recording = false;
                if (state.wakeLock) state.wakeLock.release().then(() => state.wakeLock = null);
                document.getElementById('ai-weather-info').style.display = 'none';
                openSaveModal();
            }
        }

        function openSaveModal() {
            document.getElementById('save-modal').style.display = 'flex';
            document.getElementById('save-name').value = `Fahrt ${new Date().toLocaleDateString()}`;
            document.getElementById('stat-max-alt').innerText = Math.round(state.maxAlt);
            document.getElementById('stat-points').innerText = state.track.length;
            const duration = Math.round((Date.now() - state.startTime) / 60000);
            document.getElementById('stat-duration').innerText = duration;
            document.getElementById('save-notes').value = "";
        }

        async function generateAIRepo() {
            const loader = document.getElementById('ai-repo-loader');
            const textarea = document.getElementById('save-notes');
            loader.classList.remove('hidden');
            try {
                const summary = state.track.filter((_, i) => i % 15 === 0).map(p => `${p.alt}m`).join('->');
                const systemPrompt = "Schreibe einen kurzen Logbucheintrag (Deutsch) für eine Ballonfahrt.";
                const prompt = `Fahrtbericht: Max ${state.maxAlt}m, Dauer ${document.getElementById('stat-duration').innerText}min. Höhenprofil: ${summary}`;
                textarea.value = await callGemini(prompt, systemPrompt);
            } catch (e) { alert("Fehler"); } finally { loader.classList.add('hidden'); }
        }

        function closeSaveModal() { document.getElementById('save-modal').style.display = 'none'; resetUI(); }
        function resetUI() { document.getElementById('btn-toggle').className = "btn-large flex-1 bg-green-600 text-white flex items-center justify-center gap-2"; document.getElementById('btn-text').innerText = "Fahrt starten"; }

        function confirmSave() {
            const flight = { id: Date.now(), name: document.getElementById('save-name').value, registration: document.getElementById('save-reg').value, notes: document.getElementById('save-notes').value, maxAlt: state.maxAlt, track: state.track, date: new Date().toISOString() };
            const flights = JSON.parse(localStorage.getItem('flights') || '[]');
            flights.push(flight);
            localStorage.setItem('flights', JSON.stringify(flights));
            closeSaveModal();
        }

        function openMenu() { document.getElementById('menu-modal').style.display = 'flex'; renderHistory(); }
        function closeMenu() { document.getElementById('menu-modal').style.display = 'none'; }
        function renderHistory() {
            const list = document.getElementById('saved-list');
            const flights = JSON.parse(localStorage.getItem('flights') || '[]');
            list.innerHTML = flights.reverse().map(f => `<div class="bg-white border p-3 rounded-xl mb-2"><h3 class="font-bold">${f.name}</h3><button onclick="loadToMap(${f.id})" class="text-xs text-blue-600">Auf Karte anzeigen</button></div>`).join('');
        }

        function loadToMap(id) {
            const f = JSON.parse(localStorage.getItem('flights')).find(x => x.id === id);
            trackLine.setLatLngs(f.track.map(p => [p.lat, p.lng]));
            map.fitBounds(trackLine.getBounds());
            closeMenu();
        }

        function toggleSimulation() {
            if (state.simulationId) { clearInterval(state.simulationId); state.simulationId = null; return; }
            if (!state.recording) toggleRecording();
            let lat = 51.16, lng = 10.45, alt = 50, head = 0;
            state.simulationId = setInterval(() => {
                alt += (Math.random() * 6 - 2); // Simuliere Steigen/Sinken
                head = (head + 1) % 360;
                lat += 0.0003; lng += 0.0002;
                processData(lat, lng, alt, 15, head, Date.now());
            }, 1000);
            closeMenu();
        }

        function startGPSWatch() {
            state.watchId = navigator.geolocation.watchPosition(handlePosition, (err) => {}, { enableHighAccuracy: true });
        }

        async function requestWakeLock() { if ('wakeLock' in navigator) state.wakeLock = await navigator.wakeLock.request('screen'); }
        window.onload = startGPSWatch;
    </script>
</body>
</html>
